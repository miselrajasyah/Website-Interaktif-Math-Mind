<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Minds: Aljabar Fase D</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Merriweather"', 'serif'],
                    },
                    colors: {
                        // EARTH TONE PALETTE
                        earth: {
                            50: '#FDFCF5',   // Cream White
                            100: '#F4F1EA',  // Soft Beige
                            200: '#E6E2D3',  // Stone
                            300: '#D4C5A9',  // Sand
                            400: '#B09E80',  // Khaki
                            500: '#8C7B5D',  // Mud
                            600: '#606C38',  // Sage Green (Primary)
                            700: '#BC6C25',  // Terracotta / Orange (Warmth)
                            800: '#5E4934',  // Deep Brown (Text)
                            900: '#283618',  // Dark Forest Green
                        },
                        accent: {
                            yellow: '#DDA15E', // Warm Ochre
                            green: '#606C38',  // Sage
                            orange: '#BC6C25', // Earth Orange
                            red: '#9B2226',    // Brick Red
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #FDFCF5; }
        ::-webkit-scrollbar-thumb { background: #606C38; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #283618; }

        .earth-bg {
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1EA 100%);
            position: relative;
        }
        /* Noise Texture */
        .earth-bg::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(96, 108, 56, 0.2);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(188, 108, 37, 0.15);
            box-shadow: 0 10px 30px -10px rgba(94, 73, 52, 0.1);
        }
        
        .media-card { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .media-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px -5px rgba(188, 108, 37, 0.15);
        }
        
        .story-slide { display: none; animation: fadeInScale 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
        .story-slide.active { display: block; }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        #media-modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        #media-modal.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        #media-modal:not(.hidden) { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        .badge-locked { filter: grayscale(100%); opacity: 0.5; }
        .badge-unlocked { animation: bounce-slow; filter: none; opacity: 1; }
    </style>
</head>
<body class="earth-bg text-earth-800 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#FEFAE0]">
        <div class="glass p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-md text-center relative overflow-hidden border-2 border-earth-300">
            <div class="relative z-10">
                <div class="w-24 h-24 bg-earth-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl text-white text-4xl animate-bounce-slow">
                    <i class="fas fa-leaf"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-earth-900 mb-2 font-serif tracking-tight">Math Minds</h1>
                <p class="text-earth-700 font-medium mb-8">Eksplorasi Aljabar dengan Gayamu</p>
                
                <form id="login-form" class="space-y-4 relative">
                    <div class="relative group">
                        <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-earth-600 group-focus-within:text-earth-700 transition-colors"></i>
                        <input type="text" id="student-name" placeholder="Siapa namamu?" required 
                            class="w-full pl-12 pr-4 py-4 bg-white border-2 border-earth-200 focus:border-earth-700 rounded-xl shadow-sm focus:outline-none focus:ring-4 focus:ring-earth-700/10 transition-all placeholder-earth-400 text-earth-900 font-medium">
                    </div>
                    <button type="submit" 
                        class="w-full py-4 bg-earth-700 hover:bg-earth-800 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                        <span>Mulai Petualangan</span>
                        <i class="fas fa-compass"></i>
                    </button>
                </form>
                <p class="mt-6 text-xs text-earth-500 font-medium">¬© 2025 Pendidikan Matematika</p>
                <p class="mt-2 text-[10px] text-earth-400">Data tersimpan lokal di perangkat ini.</p>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex-1 h-full flex overflow-hidden opacity-0 pointer-events-none transition-opacity duration-1000 z-10 relative" style="display: none;">
        
        <button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 w-10 h-10 bg-earth-700 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-earth-800 transition">
            <i class="fas fa-bars"></i>
        </button>

        ```
        
        <aside id="main-sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white/90 backdrop-blur-md border-r border-earth-300 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:relative md:w-72 glass">
            <div class="p-6 border-b border-earth-300 flex items-center gap-4 bg-earth-600/5">
                <div class="w-10 h-10 bg-earth-700 rounded-lg flex items-center justify-center text-white shadow-md flex-shrink-0">
                    <i class="fas fa-shapes"></i>
                </div>
                <div class="hidden md:block">
                    <h2 class="text-lg font-bold text-earth-900 leading-tight font-serif">Aljabar Fase D</h2>
                    <p class="text-xs text-earth-700 font-medium" id="user-greeting">Halo, Siswa!</p>
                </div>
            </div>
            
            <nav id="sidebar-menu" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide"></nav>
            
            <div class="px-4 pb-2">
                 <button onclick="openProfile()" class="w-full py-3 flex items-center gap-3 px-4 rounded-xl bg-earth-200 text-earth-900 hover:bg-earth-300 transition-colors md:justify-start justify-center font-bold">
                    <i class="fas fa-seedling text-earth-700"></i>
                    <span class="hidden md:inline">Profil & Insight</span>
                </button>
            </div>

            <div class="p-4 border-t border-earth-300">
                <button onclick="location.reload()" class="w-full py-3 flex items-center gap-3 px-4 rounded-xl text-accent-red hover:bg-red-50 transition-colors md:justify-start justify-center font-medium">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="hidden md:inline">Keluar</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 w-full overflow-y-auto relative scroll-smooth p-4 md:p-8 pt-16 md:pt-8" id="main-scroll">
            <div class="max-w-7xl mx-auto pb-24">
                
                <section id="introduction" class="min-h-[85vh] flex items-center justify-center relative mb-20">
                    <div class="glass rounded-[2.5rem] p-8 md:p-16 w-full shadow-xl border-t-4 border-earth-600 relative overflow-hidden min-h-[500px] flex flex-col justify-center">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-accent-yellow/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-64 h-64 bg-earth-600/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2"></div>

                        <div class="story-slide active text-center relative z-10" id="slide-1">
                            <div class="inline-flex items-center justify-center w-24 h-24 bg-earth-100 text-earth-700 rounded-full mb-8 animate-bounce-slow shadow-sm border border-earth-200">
                                <i class="fas fa-search text-4xl"></i>
                            </div>
                            <h1 class="text-4xl md:text-6xl font-serif font-bold text-earth-900 mb-6">Menemukan Pola di Sekitarmu</h1>
                            <p class="text-xl text-earth-700 max-w-2xl mx-auto leading-relaxed mb-10">
                                Matematika bukan sekadar angka acak. Ia adalah bahasa untuk menjelaskan pola alam, struktur bangunan, hingga cara kita berbelanja.
                                <br><span class="text-earth-600 text-base italic mt-2 block">"Fase D: Dari Pola Bilangan ke Sistem Persamaan"</span>
                            </p>
                            <button onclick="nextSlide(2)" class="px-10 py-4 bg-earth-700 text-white rounded-full font-bold hover:bg-earth-800 transition-all shadow-lg hover:shadow-earth-700/30 flex items-center gap-3 mx-auto">
                                <span>Apa yang akan kita pelajari?</span> <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div class="story-slide text-center relative z-10" id="slide-2">
                            <div class="inline-flex items-center justify-center w-24 h-24 bg-accent-green/10 text-earth-900 rounded-full mb-8 shadow-sm">
                                <i class="fas fa-layer-group text-4xl text-accent-green"></i>
                            </div>
                            <h1 class="text-3xl md:text-5xl font-serif font-bold text-earth-900 mb-6">Misi Kita: Menguasai Aljabar</h1>
                            <div class="grid md:grid-cols-2 gap-4 text-left max-w-4xl mx-auto mb-10 text-earth-700">
                                <div class="bg-white/60 p-4 rounded-xl border border-earth-200"><i class="fas fa-check text-earth-600 mr-2"></i> Mengenali & Memprediksi Pola</div>
                                <div class="bg-white/60 p-4 rounded-xl border border-earth-200"><i class="fas fa-check text-earth-600 mr-2"></i> Bentuk Aljabar & Sifat Operasi</div>
                                <div class="bg-white/60 p-4 rounded-xl border border-earth-200"><i class="fas fa-check text-earth-600 mr-2"></i> Relasi & Fungsi (Linear vs Nonlinear)</div>
                                <div class="bg-white/60 p-4 rounded-xl border border-earth-200"><i class="fas fa-check text-earth-600 mr-2"></i> Menyelesaikan PLSV & SPLDV</div>
                            </div>
                            <div class="flex justify-center gap-4">
                                <button onclick="nextSlide(1)" class="px-8 py-3 rounded-full border-2 border-earth-400 text-earth-700 font-bold hover:bg-earth-100 transition">Kembali</button>
                                <button onclick="nextSlide(3)" class="px-10 py-4 bg-earth-900 text-white rounded-full font-bold hover:bg-black transition-all shadow-lg flex items-center gap-3">
                                    <span>Pilih Gaya Belajarmu</span> <i class="fas fa-users-rays"></i>
                                </button>
                            </div>
                        </div>

                        <div class="story-slide text-center relative z-10" id="slide-3">
                            <h1 class="text-4xl md:text-6xl font-serif font-bold mb-6 text-earth-900">
                                8 Pintu Masuk
                            </h1>
                            <p class="text-lg text-earth-600 max-w-2xl mx-auto mb-10">
                                Setiap orang punya cara unik memahami Aljabar. Apakah kamu tipe visual, logis, atau musikal? Semua ada jalannya di sini.
                            </p>
                            <button onclick="startApp()" class="px-12 py-5 bg-gradient-to-r from-earth-700 to-earth-600 text-white rounded-full font-bold text-lg hover:scale-105 transition-transform shadow-2xl flex items-center gap-3 mx-auto animate-pulse">
                                <span>Mulai Eksplorasi</span> <i class="fas fa-rocket"></i>
                            </button>
                        </div>
                    </div>
                </section>

                <div id="intelligences-container" class="space-y-24"></div>

            </div>
        </main>
    </div>

    <div id="media-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-earth-900/90 backdrop-blur-md p-4 hidden">
        <div class="modal-content-box bg-[#FDFCF5] w-full max-w-5xl h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative border border-earth-300">
            <div id="modal-header" class="p-6 flex justify-between items-center text-white transition-colors duration-300 bg-earth-700">
                <div class="flex items-center gap-4 overflow-hidden">
                    <div>
                        <p class="text-xs opacity-90 uppercase tracking-widest font-bold mb-1 text-white/80">Fase D: Aljabar</p>
                        <h3 id="modal-title" class="text-2xl font-serif font-bold truncate max-w-md">Title</h3>
                    </div>
                    <div id="nav-controls" class="hidden flex items-center gap-2 ml-6 bg-black/20 rounded-full px-1 py-1 border border-white/10">
                        <button onclick="navContent(-1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/30 hover:scale-105 transition active:scale-95 text-sm"><i class="fas fa-chevron-left"></i></button>
                        <span id="nav-counter" class="text-sm font-mono font-bold px-2 min-w-[3.5rem] text-center">1/10</span>
                        <button onclick="navContent(1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/30 hover:scale-105 transition active:scale-95 text-sm"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 rounded-full bg-white/20 hover:bg-accent-red hover:text-white flex items-center justify-center transition text-white min-h-[48px] min-w-[48px] active:scale-90 shadow-sm border border-white/10">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto p-8 bg-[#F4F1EA] relative"></div>
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-earth-400 text-xs animate-pulse md:hidden pointer-events-none"><i class="fas fa-arrows-alt-h"></i> Geser untuk navigasi</div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 hidden">
        <div class="bg-[#FDFCF5] w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] border border-earth-300">
            <div class="p-6 bg-earth-800 text-white flex justify-between items-center">
                <h3 class="text-xl font-bold font-serif"><i class="fas fa-leaf mr-2"></i> Jejak Belajar</h3>
                <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-white/20 hover:bg-accent-red flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 overflow-y-auto space-y-8">
                <div class="flex items-center gap-6 pb-6 border-b border-earth-200">
                    <div class="w-20 h-20 bg-accent-yellow/20 rounded-full flex items-center justify-center text-4xl text-accent-yellow border-2 border-accent-yellow">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div>
                        <h4 id="profile-name" class="text-2xl font-bold text-earth-900">Guest</h4>
                        <div class="flex gap-4 mt-2 text-sm text-earth-700 font-medium">
                            <span><i class="fas fa-fire text-accent-orange"></i> Streak: <b id="streak-count">0</b> Hari</span>
                            <span><i class="fas fa-star text-accent-yellow"></i> XP: <b id="xp-count">0</b></span>
                        </div>
                    </div>
                </div>
                <div class="bg-earth-100 border border-earth-200 rounded-2xl p-6 relative">
                    <div class="absolute -top-3 -right-3 bg-earth-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg flex items-center gap-1">
                        <i class="fas fa-robot"></i> AI Analysis
                    </div>
                    
                    <h4 class="font-bold text-earth-800 mb-2 flex items-center gap-2">
                        <i class="fas fa-brain text-earth-600"></i> Peta Kecerdasanmu
                    </h4>
                    
                    <p id="ai-feedback-text" class="text-earth-700 text-sm italic mb-4 bg-white/50 p-3 rounded-lg border border-earth-200">
                        Belum cukup data. Cobalah berinteraksi dengan beberapa modul Aljabar.
                    </p>
                    
                    <div class="relative w-full h-64 bg-white rounded-xl shadow-inner border border-earth-200 p-2">
                        <canvas id="ai-radar-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-earth-800 mb-4">Pencapaian</h4>
                    <div id="badge-container" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="pt-6 border-t border-earth-200 flex gap-3">
                    <button onclick="exportData()" class="px-4 py-2 border border-earth-300 rounded-lg text-sm text-earth-700 hover:bg-white"><i class="fas fa-download"></i> Backup</button>
                    <button onclick="clearData()" class="px-4 py-2 border border-accent-red text-accent-red rounded-lg text-sm hover:bg-red-50"><i class="fas fa-trash"></i> Hapus</button>
                </div>
            </div>
        </div>
    </div>
    <div id="closing-overlay" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-md hidden opacity-0 transition-opacity duration-500">
        <div class="relative w-full max-w-lg p-8 mx-4">
            <div class="absolute inset-0 bg-gradient-to-br from-yellow-100 to-white rounded-[3rem] transform rotate-2"></div>
            <div class="relative bg-white rounded-[3rem] p-8 text-center shadow-2xl border-4 border-earth-200 overflow-hidden">
                
                <div class="absolute -top-10 left-10 text-earth-300 text-9xl opacity-10"><i class="fas fa-certificate"></i></div>
                <div class="absolute -bottom-10 right-10 text-accent-yellow text-9xl opacity-10"><i class="fas fa-star"></i></div>

                <div class="mb-6 relative inline-block">
                    <div class="text-6xl animate-bounce text-earth-700" style="animation-duration: 2s">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="absolute -right-4 -top-4 text-3xl animate-pulse text-yellow-400">‚ú®</div>
                    <div class="absolute -left-4 top-4 text-3xl animate-pulse text-yellow-400" style="animation-delay: 0.5s">‚ú®</div>
                </div>

                <h2 class="text-3xl font-serif font-bold text-earth-800 mb-2">Luar Biasa, <span id="close-name" class="text-accent-orange">Teman</span>!</h2>
                <p id="close-quote" class="text-earth-500 text-sm font-medium italic mb-8">"Setiap langkah kecil membawamu lebih dekat ke puncak."</p>

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-earth-50 p-4 rounded-2xl border border-earth-100">
                        <div class="text-xs text-earth-400 font-bold uppercase tracking-widest">Total XP</div>
                        <div class="text-3xl font-bold text-green-600" id="close-xp">0</div>
                    </div>
                    <div class="bg-earth-50 p-4 rounded-2xl border border-earth-100">
                        <div class="text-xs text-earth-400 font-bold uppercase tracking-widest">Badge</div>
                        <div class="text-3xl font-bold text-yellow-600" id="close-badge">0</div>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="location.reload()" class="w-full py-4 bg-earth-800 hover:bg-earth-900 text-white rounded-2xl font-bold shadow-lg transform hover:scale-105 transition flex items-center justify-center gap-3">
                        <span>Sampai Jumpa Besok!</span> <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button onclick="document.getElementById('closing-overlay').classList.add('hidden')" class="w-full py-4 rounded-xl border-2 border-earth-100 text-earth-500 font-bold text-sm hover:bg-earth-50 hover:text-earth-700 transition-colors active:scale-95">
                        Batal, Saya mau lanjut belajar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="team-modal" class="fixed inset-0 z-[160] flex items-center justify-center bg-black/80 backdrop-blur-md hidden opacity-0 transition-opacity duration-500">
        <div class="bg-[#FDFCF5] w-full max-w-5xl rounded-[2.5rem] p-8 md:p-12 shadow-2xl border-4 border-earth-300 relative overflow-hidden flex flex-col max-h-[90vh]">
            
            <div class="text-center mb-10 relative z-10">
                <span class="text-xs font-bold text-earth-500 uppercase tracking-widest bg-earth-100 px-4 py-2 rounded-full border border-earth-200">Meet the Creators</span>
                <h2 class="text-3xl md:text-5xl font-serif font-bold text-earth-900 mt-4">Tim Pengembang</h2>
                <div class="w-24 h-1 bg-accent-orange mx-auto mt-6 rounded-full"></div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 overflow-y-auto p-2 scrollbar-hide">
                
                <div class="group relative bg-white rounded-[2rem] p-6 shadow-lg border border-earth-100 hover:-translate-y-2 hover:shadow-2xl transition-all duration-300 text-center flex flex-col items-center">
                    <div class="w-32 h-32 mb-6 rounded-full p-1 border-2 border-dashed border-earth-300 group-hover:border-accent-orange transition-colors">
                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-200 relative">
                            <img src="foto_misel.jpg" alt="Misel" class="w-full h-full object-cover"> 
                        </div>
                    </div>
                    <h3 class="font-bold text-earth-900 text-lg mb-1">Misel Rajasyah</h3>
                    <span class="text-[10px] font-bold text-white bg-earth-700 px-3 py-1 rounded-full uppercase tracking-wider">Developer Website</span>
                </div>

                <div class="group relative bg-white rounded-[2rem] p-6 shadow-lg border border-earth-100 hover:-translate-y-2 hover:shadow-2xl transition-all duration-300 text-center flex flex-col items-center">
                    <div class="w-32 h-32 mb-6 rounded-full p-1 border-2 border-dashed border-earth-300 group-hover:border-accent-yellow transition-colors">
                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-200 relative">
                            <img src="foto_bela.jpg" alt="Bela" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <h3 class="font-bold text-earth-900 text-lg mb-1">Natasya Bela</h3>
                    <span class="text-[10px] font-bold text-white bg-accent-yellow px-3 py-1 rounded-full uppercase tracking-wider">Developer E-Book</span>
                </div>

                <div class="group relative bg-white rounded-[2rem] p-6 shadow-lg border border-earth-100 hover:-translate-y-2 hover:shadow-2xl transition-all duration-300 text-center flex flex-col items-center">
                    <div class="w-32 h-32 mb-6 rounded-full p-1 border-2 border-dashed border-earth-300 group-hover:border-accent-green transition-colors">
                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-200 relative">
                            <img src="foto_chez.jpg" alt="Chez" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <h3 class="font-bold text-earth-900 text-lg mb-1">Chezarie Javia</h3>
                    <span class="text-[10px] font-bold text-white bg-accent-green px-3 py-1 rounded-full uppercase tracking-wider">Developer E-Book</span>
                </div>

                <div class="group relative bg-white rounded-[2rem] p-6 shadow-lg border border-earth-100 hover:-translate-y-2 hover:shadow-2xl transition-all duration-300 text-center flex flex-col items-center">
                    <div class="w-32 h-32 mb-6 rounded-full p-1 border-2 border-dashed border-earth-300 group-hover:border-accent-red transition-colors">
                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-200 relative">
                            <img src="foto_neny.jpg" alt="Neny" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <h3 class="font-bold text-earth-900 text-lg mb-1">Kartika Neny</h3>
                    <span class="text-[10px] font-bold text-white bg-accent-red px-3 py-1 rounded-full uppercase tracking-wider">Developer E-Book</span>
                </div>

            </div>

            <button onclick="closeTeam()" class="absolute top-4 right-4 z-50 w-14 h-14 rounded-full bg-earth-100 hover:bg-red-100 text-earth-600 hover:text-red-500 flex items-center justify-center transition shadow-md active:scale-90 border-2 border-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
    </div>

<script>
    // --- 0. DATA PRIVACY & STORAGE MANAGER ---
    const STORAGE_KEY = 'math_minds_user_v2_aljabar';
    let userProfile = {
        name: '', streak: 1, lastVisit: new Date().toDateString(), xp: 0, badges: [],
        progress: { modulesVisited: {}, timePerType: {}, quizzesTaken: 0, quizzesCorrect: 0 }
    };

    function loadUser() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            userProfile = JSON.parse(saved);
            const today = new Date().toDateString();
            if(userProfile.lastVisit !== today) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                // Cek Streak
                if(userProfile.lastVisit === yesterday.toDateString()) {
                    userProfile.streak++;
                    // BADGE KONSISTEN (3 Hari)
                    if(userProfile.streak >= 3) unlockBadge('streak_3');
                } else {
                    userProfile.streak = 1;
                }
                userProfile.lastVisit = today;
            }
        }
        // Inisialisasi list modulesVisited jika belum ada (untuk Badge Explorer)
        if(!userProfile.progress.modulesVisited) userProfile.progress.modulesVisited = {};
        saveUser();
    }
    function saveUser() { localStorage.setItem(STORAGE_KEY, JSON.stringify(userProfile)); updateProfileUI(); }
    function addXP(amount) {
        userProfile.xp += amount;
        
        // BADGE VETERAN (500 XP)
        if(userProfile.xp >= 500) unlockBadge('xp_500');
        
        saveUser();
        updateProfileUI(); // Update tampilan real-time
    }
    function unlockBadge(id) {
        if(!userProfile.badges.includes(id)) {
            userProfile.badges.push(id);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#606C38', '#BC6C25', '#DDA15E'] });
            saveUser();
            alert(`üèÖ Badge Unlocked: ${id.toUpperCase()}!`);
        }
    }
    function clearData() { if(confirm('Hapus semua progres?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(userProfile));
        const anchor = document.createElement('a'); anchor.setAttribute("href", dataStr); anchor.setAttribute("download", "math_backup.json");
        document.body.appendChild(anchor); anchor.click(); anchor.remove();
    }

    // --- 1. DATA STRUCTURE (REVISED FOR ALGEBRA PHASE D) ---
    const intelligenceData = [
        { 
            id: "linguistic", name: "Verbal Linguistic", icon: "fa-comments", color: "accent-yellow", hex: "#DDA15E", 
            desc: "Memahami Aljabar lewat Kata & Cerita", 
            media: [
                // --- KONTEN LAMA (DIPERTAHANKAN) ---
                { 
                    title: "Penerjemah Aljabar", icon: "fa-language", type: "app", appType: "story", 
                    desc: "Ubah kalimat sehari-hari menjadi bentuk aljabar.",
                    contentList: [
                        { prompt: "Uang Jajan", ex: "3x + 5000", obj1: "Hari (x)", obj2: "Sisa Uang" },
                        { prompt: "Tarif Taksi", ex: "y = 3000x + 7000", obj1: "Jarak KM (x)", obj2: "Buka Pintu" },
                        { prompt: "Keliling Kebun", ex: "K = 2(p + l)", obj1: "Panjang", obj2: "Lebar" },
                        { prompt: "SPLDV: Belanja", ex: "2b + 3p = 15000", obj1: "Buku (b)", obj2: "Pena (p)" },
                        { prompt: "Suhu Udara", ex: "T = -2h + 30", obj1: "Ketinggian (h)", obj2: "Suhu Awal" }
                    ]
                },
                { 
                    title: "Definisi Relasi & Fungsi", icon: "fa-book", type: "flashcard", 
                    desc: "Hafalan istilah penting.",
                    contentList: [
                        { cards: [{f:"Domain", b:"Daerah Asal (Himpunan input)"}] },
                        { cards: [{f:"Kodomain", b:"Daerah Kawan (Himpunan tujuan)"}] },
                        { cards: [{f:"Range", b:"Daerah Hasil (Anggota kodomain yang terpilih)"}] },
                        { cards: [{f:"Fungsi (Pemetaan)", b:"Relasi dimana setiap anggota domain punya TEPAT SATU pasangan"}] },
                        { cards: [{f:"Korespondensi 1-1", b:"Setiap anggota domain dan kodomain berpasangan tepat satu"}] }
                    ]
                },
                { 
                    title: "Sifat Operasi (Narasi)", icon: "fa-microphone-alt", type: "input", inputType: "textarea", 
                    desc: "Jelaskan sifat operasi dengan kata-katamu.",
                    contentList: [
                        { prompt: "Jelaskan Sifat Komutatif (a+b = b+a) dengan analogi perjalanan pulang-pergi." },
                        { prompt: "Jelaskan Sifat Distributif a(b+c) = ab + ac menggunakan analogi membagikan permen." },
                        { prompt: "Kenapa (a-b) tidak sama dengan (b-a)? Jelaskan dengan contoh hutang." }
                    ]
                },
                { 
                    title: "Kamus SPLDV", icon: "fa-spell-check", type: "quiz", 
                    desc: "Istilah Sistem Persamaan Linear.",
                    contentList: [
                        { question: "Metode menghilangkan satu variabel disebut?", options: ["Eliminasi", "Substitusi", "Campuran", "Grafik"], answer: 0 },
                        { question: "Metode mengganti variabel dengan persamaan lain?", options: ["Substitusi", "Eliminasi", "Distribusi", "Asosiasi"], answer: 0 }
                    ]
                },

                // --- 10 VARIASI MEDIA BARU ---
                
                // 1. Etimologi & Sejarah (Flashcard)
                {
                    title: "Asal Kata Aljabar", icon: "fa-history", type: "flashcard",
                    desc: "Sejarah istilah matematika.",
                    contentList: [
                        { cards: [{f:"Al-Jabr (Bahasa Arab)", b:"Berarti 'Pengumpulan kembali bagian yang rusak' atau penyelesaian."}] },
                        { cards: [{f:"Variabel", b:"Berasal dari kata 'Vary' (Berubah). Sesuatu yang nilainya bisa ganti-ganti."}] },
                        { cards: [{f:"Konstanta", b:"Berasal dari kata 'Constant' (Tetap). Nilai yang tidak berubah."}] }
                    ]
                },

                // 2. Sinonim Matematika (Quiz)
                {
                    title: "Sinonim Kata Operasi", icon: "fa-quote-right", type: "quiz",
                    desc: "Kata kunci dalam soal cerita.",
                    contentList: [
                        { question: "Kata manakah yang BERBEDA arti dengan simbol '+' (Tambah)?", options: ["Selisih", "Jumlah", "Total", "Gabungan"], answer: 0 },
                        { question: "Kata 'Dua kali lipat dari' dalam aljabar ditulis sebagai...", options: ["2x", "x + 2", "x¬≤", "x/2"], answer: 0 },
                        { question: "Kata 'Kurang dari' (misal: 5 kurang dari x) ditulis...", options: ["x - 5", "5 - x", "5 < x", "x < 5"], answer: 0 }
                    ]
                },

                // 3. Susun Definisi (Sort App - Reused Logic)
                {
                    title: "Susun Kalimat Definisi", icon: "fa-sort-alpha-down", type: "app", appType: "sort",
                    desc: "Urutkan kata acak menjadi definisi yang benar.",
                    items: ["Persamaan", "Linear", "Satu", "Variabel", "Adalah", "Kalimat", "Terbuka", "Dengan", "Tanda", "Sama Dengan"],
                    explanation: "PLSV adalah kalimat terbuka yang dihubungkan tanda sama dengan dan hanya punya 1 variabel."
                },

                // 4. Tebak Tokoh/Istilah (Chat Simulation)
                {
                    title: "Tebak: Siapakah Aku?", icon: "fa-user-secret", type: "app", appType: "chat",
                    desc: "Tebak istilah aljabar dari petunjuk percakapan.",
                    chatData: [
                        {sender:"Misteri", msg:"Aku adalah sebuah huruf kecil."}, 
                        {sender:"Misteri", msg:"Aku berdiri sendiri tanpa teman angka."},
                        {sender:"Misteri", msg:"Nilaiku belum diketahui."},
                        {sender:"You", msg:"Apakah kamu Variabel?"},
                        {sender:"Misteri", msg:"Benar! Tapi lebih tepatnya... Variabel Jomblo?"}
                    ]
                },

                // 5. Analogi & Metafora (Input Esai)
                {
                    title: "Analogi Substitusi", icon: "fa-pen-nib", type: "input", inputType: "textarea",
                    desc: "Latihan berpikir metaforis.",
                    prompt: "Bayangkan metode SUBSTITUSI (mengganti) seperti pemain cadangan sepak bola. Jelaskan proses pergantian pemain x dengan angka 5!"
                },

                // 6. Pantun Matematika (Input Kreatif)
                {
                    title: "Pantun Rumus", icon: "fa-feather-alt", type: "input", inputType: "textarea",
                    desc: "Menghafal rumus lewat sastra.",
                    prompt: "Buatlah pantun 4 baris yang berakhiran a-b-a-b tentang 'Gradien' (Kemiringan Garis)."
                },

                // 7. Debat Argumen (Input Kritis)
                {
                    title: "Debat Kesalahan Umum", icon: "fa-gavel", type: "input", inputType: "textarea",
                    desc: "Argumentasi logika verbal.",
                    prompt: "Temanmu berkata: '3x + 5 sama dengan 8x'. Tuliskan kalimat sanggahanmu untuk menjelaskan kenapa itu salah!"
                },

                // 8. Kosa Kata Gradien (Quiz)
                {
                    title: "Bahasa Grafik", icon: "fa-chart-line", type: "quiz",
                    desc: "Menerjemahkan visual ke kata sifat.",
                    contentList: [
                        { question: "Jika garis naik dari kiri ke kanan, kita menyebutnya...", options: ["Positif / Menanjak", "Negatif / Menurun", "Nol / Datar", "Tak Terdefinisi"], answer: 0 },
                        { question: "Garis yang 'Landai' memiliki nilai gradien yang...", options: ["Mendekati Nol", "Sangat Besar", "Negatif Besar", "Tak Terhingga"], answer: 0 }
                    ]
                },

                // 9. Langkah Soal Cerita (Sort App)
                {
                    title: "Logika Soal Cerita", icon: "fa-list-ol", type: "app", appType: "sort",
                    desc: "Urutkan langkah menerjemahkan soal cerita.",
                    items: ["Baca soal dengan teliti", "Tentukan pemisalan (Misal x = buku)", "Buat model matematika", "Selesaikan persamaan", "Tulis kesimpulan"],
                },

                // 10. Jurnal Refleksi Konsep (Input)
                {
                    title: "Surat untuk 'X'", icon: "fa-envelope-open-text", type: "input", inputType: "textarea",
                    desc: "Personifikasi matematika.",
                    prompt: "Tulis surat pendek untuk Variabel X. Tanyakan kenapa dia suka bersembunyi dan bagaimana perasaanmu saat menemukannya?"
                },
                // 11. Podcast Mini (Task Audio/Speaking)
                {
                    title: "Podcast Aljabar", icon: "fa-microphone", type: "task",
                    content: "Rekam suaramu selama 1 menit: Jelaskan kepada 'pendengar imajiner' apa bedanya Persamaan (ada =) dan Pertidaksamaan (ada <, >). Gunakan bahasa penyiar radio!",
                    desc: "Latihan verbal: Menjelaskan konsep lewat suara."
                },

                // 12. Teka-Teki Kata (Word Scramble App)
                {
                    title: "Susun Kata", icon: "fa-font", type: "app", appType: "sort",
                    desc: "Huruf-huruf ini berantakan! Susun menjadi istilah matematika.",
                    items: ["K-O-E-F-I-S-I-E-N", "V-A-R-I-A-B-E-L", "K-O-N-S-T-A-N-T-A", "A-L-J-A-B-A-R"],
                    explanation: "Istilah dasar penyusun bentuk aljabar."
                }
            ]
        },
        { 
            id: "logical", name: "Logical Mathematical", icon: "fa-calculator", color: "earth-600", hex: "#606C38", 
            desc: "Analisis Pola, Angka & Logika", 
            media: [
                // --- 1. EXISTING (DIPERLUAS) ---
                // GANTI BAGIAN DETEKTIF POLA DENGAN INI:
                { 
                    title: "Detektif Pola (Level 1-8)", icon: "fa-search-plus", type: "app", appType: "pattern", 
                    desc: "Tebak suku berikutnya! (Gunakan panah navigasi di atas untuk ganti soal)",
                    contentList: [
                        // Level 1: Geometri Dasar
                        { seq: ["2", "4", "8"], ans: "16", hint: "Kali 2", opts: ["12", "16", "10", "20"] },
                        // Level 2: Aritmatika
                        { seq: ["3", "6", "9"], ans: "12", hint: "Tambah 3", opts: ["11", "12", "15", "10"] },
                        // Level 3: Fibonacci
                        { seq: ["1", "1", "2", "3"], ans: "5", hint: "Jumlah 2 angka sebelumnya", opts: ["4", "5", "6", "8"] },
                        // Level 4: Aritmatika Turun
                        { seq: ["50", "45", "40"], ans: "35", hint: "Kurang 5", opts: ["30", "35", "25", "38"] },
                        // Level 5: Kuadrat
                        { seq: ["1", "4", "9", "16"], ans: "25", hint: "Pangkat 2 (n¬≤)", opts: ["20", "24", "25", "36"] },
                        // Level 6: Segitiga (Penjumlahan Bertingkat)
                        { seq: ["1", "3", "6", "10"], ans: "15", hint: "+2, +3, +4...", opts: ["14", "15", "12", "16"] },
                        // Level 7: Lompat Huruf
                        { seq: ["A", "C", "E"], ans: "G", hint: "Lewati 1 huruf", opts: ["F", "G", "H", "I"] },
                        // Level 8: Pola Campuran (x2 + 1)
                        { seq: ["2", "5", "11", "23"], ans: "47", hint: "Dikali 2, lalu tambah 1", opts: ["45", "46", "47", "50"] }
                    ]
                },
                { 
                    title: "Logika PLSV (Level 1-10)", icon: "fa-balance-scale-right", type: "quiz", 
                    desc: "Kuis intensif Persamaan Linear Satu Variabel.",
                    contentList: [
                        // Basic
                        { question: "Jika 3x = 15, maka x adalah...", options: ["5", "3", "12", "45"], answer: 0 },
                        { question: "Penyelesaian x + 7 = 3", options: ["-4", "4", "10", "-10"], answer: 0 },
                        { question: "2x - 5 = 5. Nilai x?", options: ["5", "0", "10", "2.5"], answer: 0 },
                        // Intermediate
                        { question: "3(x + 1) = 12. Nilai x?", options: ["3", "4", "2", "5"], answer: 0 },
                        { question: "5x = 2x + 9", options: ["3", "-3", "9", "1.8"], answer: 0 },
                        { question: "10 - x = 2. Berapakah x?", options: ["8", "-8", "12", "5"], answer: 0 },
                        // Advanced (Logic)
                        { question: "Jika 2x = 10, berapakah nilai 3x - 1?", options: ["14", "15", "5", "9"], answer: 0, explanation: "Cari x dulu. x=5. Maka 3(5)-1 = 14." },
                        { question: "Manakah yang BUKAN persamaan linear satu variabel?", options: ["x + y = 5", "2x = 8", "3y - 2 = 7", "p = 10"], answer: 0 },
                        { question: "Agar 4x > 12 bernilai benar, x harus...", options: ["Lebih dari 3", "Kurang dari 3", "Sama dengan 3", "Lebih dari 4"], answer: 0 },
                        { question: "Setengah dari x adalah 10. Maka x?", options: ["20", "5", "15", "100"], answer: 0 }
                    ]
                },
                { 
                    title: "Linear vs Nonlinear", icon: "fa-chart-line", type: "quiz", 
                    desc: "Analisis bentuk fungsi dan grafiknya.",
                    contentList: [
                        { question: "Manakah yang merupakan fungsi linear?", options: ["y = 5x - 2", "y = x¬≤", "y = 1/x", "y = ‚àöx"], answer: 0 },
                        { question: "Grafik dari y = x¬≤ + 1 berbentuk?", options: ["Melengkung (Parabola)", "Garis Lurus", "Lingkaran", "Zigzag"], answer: 0 },
                        { question: "Pola: 3, 6, 12, 24... (Kali 2). Ini adalah pertumbuhan?", options: ["Eksponensial (Nonlinear)", "Linear (Aritmatika)", "Konstan", "Logaritma"], answer: 0 },
                        { question: "Persamaan garis lurus selalu memiliki variabel pangkat tertingginya...", options: ["Satu (1)", "Dua (2)", "Tiga (3)", "Nol (0)"], answer: 0 },
                        { question: "Manakah tabel fungsi linear?", options: ["x:1,2,3 -> y:2,4,6", "x:1,2,3 -> y:1,4,9", "x:1,2,3 -> y:1,8,27", "x:1,2,3 -> y:2,4,8"], answer: 0, explanation: "Cek selisihnya. Linear memiliki beda yang tetap." }
                    ]
                },
                { 
                    title: "Algoritma SPLDV", icon: "fa-cogs", type: "app", appType: "sort", 
                    desc: "Urutkan langkah penyelesaian SPLDV (2 Level).",
                    contentList: [
                        { 
                            title: "Lvl 1: Metode Eliminasi",
                            items: ["Samakan koefisien x atau y", "Kurangkan/Jumlahkan persamaan", "Temukan nilai variabel pertama", "Substitusi ke persamaan lain"]
                        },
                        { 
                            title: "Lvl 2: Metode Grafik",
                            items: ["Tentukan titik potong sumbu-x (y=0)", "Tentukan titik potong sumbu-y (x=0)", "Tarik garis lurus melalui 2 titik", "Lihat perpotongan kedua garis"]
                        }
                    ]
                },

                // --- 2. 12 MEDIA BARU (NEW) ---

                // 5. Debugging / Error Analysis
                {
                    title: "Debug Aljabar", icon: "fa-bug", type: "quiz",
                    desc: "Cari baris mana yang SALAH langkah hitungnya.",
                    contentList: [
                        { question: "Soal: -2x > 10. Langkah salah di mana?\nA. -2x > 10\nB. x > 10/-2 (Salah)\nC. x > -5", options: ["Langkah B", "Langkah A", "Langkah C", "Semua Benar"], answer: 0, explanation: "Saat dibagi bilangan negatif, tanda pertidaksamaan harus DIBALIK (<)." },
                        { question: "Soal: 2(x+3) = 10.\nA. 2x + 3 = 10 (Salah)\nB. 2x = 7\nC. x = 3.5", options: ["Langkah A", "Langkah B", "Langkah C", "Soal Salah"], answer: 0, explanation: "Harusnya didistribusikan: 2x + 6 = 10." }
                    ]
                },

                // 6. Mesin Fungsi (Input-Output Logic)
                {
                    title: "Mesin Fungsi", icon: "fa-robot", type: "quiz",
                    desc: "Tebak rumus fungsi dari pola Input -> Output.",
                    contentList: [
                        { question: "Input(2) -> 5, Input(3) -> 7, Input(4) -> 9. Rumusnya?", options: ["f(x) = 2x + 1", "f(x) = x + 3", "f(x) = 3x - 1", "f(x) = x¬≤ + 1"], answer: 0 },
                        { question: "Input(5) -> 25, Input(-2) -> 4, Input(10) -> 100. Rumusnya?", options: ["f(x) = x¬≤", "f(x) = 5x", "f(x) = 2x + 15", "f(x) = x + 20"], answer: 0 },
                        { question: "Input(0) -> -3, Input(1) -> -1, Input(2) -> 1. Rumusnya?", options: ["f(x) = 2x - 3", "f(x) = x - 3", "f(x) = 3x - 3", "f(x) = -3x"], answer: 0 }
                    ]
                },

                // 7. Coding Logic (Flowchart)
                {
                    title: "Coding Aljabar", icon: "fa-code-branch", type: "app", appType: "sort",
                    desc: "Susun alur logika pemrograman (Pseudocode).",
                    contentList: [
                        {
                            title: "Program Cek Ganjil/Genap",
                            items: ["Input Bilangan X", "Hitung Sisa Bagi X dengan 2", "Jika Sisa = 0, Print 'Genap'", "Jika Tidak, Print 'Ganjil'"]
                        },
                        {
                            title: "Program Tebak Umur",
                            items: ["Input Tahun Lahir (T)", "Set Tahun Sekarang (S) = 2025", "Hitung Umur = S - T", "Tampilkan Umur"]
                        }
                    ]
                },

                // 8. Logika Pertidaksamaan
                {
                    title: "Logika Tanda", icon: "fa-less-than-equal", type: "quiz",
                    desc: "Logika membalik tanda < dan >.",
                    contentList: [
                        { question: "Jika a < b, dan kedua ruas dikali -1, maka...", options: ["-a > -b", "-a < -b", "-a = -b", "Tidak berubah"], answer: 0 },
                        { question: "x tidak lebih dari 10. Simbolnya?", options: ["x ‚â§ 10", "x < 10", "x ‚â• 10", "x > 10"], answer: 0 },
                        { question: "Umur minimal 17 tahun. Simbolnya?", options: ["x ‚â• 17", "x > 17", "x ‚â§ 17", "x = 17"], answer: 0 }
                    ]
                },

                // 9. Pola Bilangan Lanjut
                {
                    title: "Seri Angka", icon: "fa-layer-group", type: "quiz",
                    desc: "Tes IQ Pola Bilangan.",
                    contentList: [
                        { question: "1, 1, 2, 3, 5, 8, ... (Fibonacci)", options: ["13", "11", "10", "15"], answer: 0 },
                        { question: "1, 4, 9, 16, 25, ... (Kuadrat)", options: ["36", "30", "49", "35"], answer: 0 },
                        { question: "100, 95, 90, 85, ...", options: ["80", "75", "84", "70"], answer: 0 }
                    ]
                },

                // 10. Counter Examples (Pembuktian Terbalik)
                {
                    title: "Patahkan Mitos", icon: "fa-shield-alt", type: "input", inputType: "textarea",
                    desc: "Cari contoh angka yang membuktikan pernyataan ini SALAH.",
                    contentList: [
                        { prompt: "Mitos: 'Semua bilangan prima adalah ganjil'. Cari satu angka prima yang genap!" },
                        { prompt: "Mitos: 'x pangkat 2 selalu lebih besar dari x'. Cari angka x (pecahan) yang membuat ini salah!" },
                        { prompt: "Mitos: 'Jika a > b, maka a¬≤ > b¬≤'. Cari contoh menggunakan bilangan negatif (misal a=2, b=-5) yang membantahnya!" }
                    ]
                },

                // 11. Simbol Logika (Flashcard)
                {
                    title: "Simbol Logika", icon: "fa-fingerprint", type: "flashcard",
                    desc: "Bahasa simbol matematika.",
                    contentList: [
                        { cards: [{f:"‚â†", b:"Tidak sama dengan"}] },
                        { cards: [{f:"‚â°", b:"Ekuivalen / Setara"}] },
                        { cards: [{f:"‚à¥", b:"Oleh karena itu (Kesimpulan)"}] },
                        { cards: [{f:"‚àà", b:"Elemen dari / Anggota himpunan"}] },
                        { cards: [{f:"‚áí", b:"Maka / Implikasi (Jika... Maka...)"}] }
                    ]
                },

                // 12. Ekuivalensi Persamaan
                {
                    title: "Persamaan Kembar", icon: "fa-clone", type: "quiz",
                    desc: "Pilih persamaan yang senilai/ekuivalen.",
                    contentList: [
                        { question: "Persamaan 2x = 10 ekuivalen dengan...", options: ["x = 5", "2x = 5", "x = 10", "4x = 10"], answer: 0 },
                        { question: "x + 3 = 7 ekuivalen dengan...", options: ["x = 4", "x = 10", "x = 3", "x = 7"], answer: 0 },
                        { question: "Persamaan manakah yang TIDAK ekuivalen dengan 2x - 4 = 0?", options: ["x = 4", "2x = 4", "x = 2", "x - 2 = 0"], answer: 0 }
                    ]
                },

                // 13. Silogisme Aljabar
                {
                    title: "Deduksi Logis", icon: "fa-brain", type: "quiz",
                    desc: "Menarik kesimpulan.",
                    contentList: [
                        { question: "Premis 1: Jika x = 2, maka y = 4.\nPremis 2: x = 2.\nKesimpulan?", options: ["y = 4", "y = 2", "x = 4", "Tidak ada kesimpulan"], answer: 0 },
                        { question: "Jika A > B dan B > C, maka...", options: ["A > C", "A < C", "A = C", "C > A"], answer: 0 }
                    ]
                },

                // 14. Puzzle Operasi Biner
                {
                    title: "Operasi Misteri", icon: "fa-puzzle-piece", type: "quiz",
                    desc: "Logika simbol buatan.",
                    contentList: [
                        { question: "Jika didefinisikan a # b = (a + b) x a.\nBerapakah 2 # 3?", options: ["10 (Karena (2+3)x2)", "5", "6", "12"], answer: 0 },
                        { question: "Jika a @ b = a¬≤ - b.\nBerapakah 3 @ 4?", options: ["5 (Karena 9-4)", "2", "-1", "7"], answer: 0 }
                    ]
                },

                // 15. Kode Rahasia (Substitution Cipher)
                {
                    title: "Kriptografi", icon: "fa-user-secret", type: "app", appType: "story",
                    desc: "Enkripsi pesan menggunakan fungsi aljabar.",
                    contentList: [
                        { prompt: "Rumus Enkripsi: y = x + 2", ex: "A(1) jadi C(3)", obj1: "Huruf Asli (x)", obj2: "Huruf Sandi (y)" },
                        { prompt: "Rumus Enkripsi: y = 2x", ex: "A(1) jadi B(2), B(2) jadi D(4)", obj1: "Posisi Asli", obj2: "Posisi Sandi" }
                    ]
                },

                // 16. Studi Kasus
                {
                    title: "Logika Nyata", icon: "fa-city", type: "input", inputType: "textarea",
                    desc: "Penerapan logika linear di dunia nyata.",
                    contentList: [
                        { prompt: "Operator seluler A menawarkan tarif tetap Rp50.000/bulan. Operator B tarif Rp2.000/menit. Kapan Operator A lebih menguntungkan? (Gunakan logika pertidaksamaan)" },
                        { prompt: "Lift memiliki beban maksimal 500kg. Jika rata-rata orang 60kg, berapa orang maksimal (x) yang boleh masuk? Buat model matematikanya!" }
                    ]
                }
            ]
        },
        { 
            id: "spatial", name: "Visual Spatial", icon: "fa-shapes", color: "accent-orange", hex: "#BC6C25", 
            desc: "Belajar Lewat Mata: Grafik, Gambar & Imajinasi", 
            media: [
                // --- 1. INTERAKTIF & GAMBAR (DOMINAN) ---
                
                // 1. Lab Grafik (Canvas Interaktif)
                { 
                    title: "Lab Grafik Linear", icon: "fa-chart-area", type: "app", appType: "graph", 
                    desc: "Geser slider di bawah. Lihat bagaimana garisnya BERGERAK dan BERPUTAR." 
                },

                // 2. Visualisasi Konsep (Galeri Gambar)
                { 
                    title: "Galeri Diagram Fungsi", icon: "fa-images", type: "image", 
                    desc: "Lihat bedanya pola panah pada setiap jenis fungsi.",
                    contentList: [
                        { title: "Fungsi Korespondensi 1-1", imgSrc: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Bijection.svg/220px-Bijection.svg.png", desc: "Perhatikan: Setiap titik di kiri punya TEPAT SATU pasangan di kanan. Pasangan serasi!" },
                        { title: "Bukan Fungsi (Bercabang)", imgSrc: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/General_Relation_Not_Function.svg/220px-General_Relation_Not_Function.svg.png", desc: "Perhatikan titik paling atas bercabang dua. Ini dilarang dalam Fungsi!" },
                        { title: "Fungsi Konstan", imgSrc: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Function_machine2.svg/220px-Function_machine2.svg.png", desc: "Mesin fungsi: Apapun yang masuk, keluarnya bentuk yang sama." }
                    ]
                },

                // 3. Kuis Tebak Grafik (Soal Menggunakan GAMBAR)
                { 
                    title: "Tebak Grafik", icon: "fa-eye", type: "quiz", 
                    desc: "Amati gambar grafiknya, tebak sifatnya.",
                    contentList: [
                        { 
                            question: "<div class='text-center text-8xl text-accent-red mb-4'><i class='fas fa-chart-line transform -scale-x-100'></i></div>Grafik di atas turun dari kiri ke kanan. Gradiennya pasti...", 
                            options: ["Negatif (-)", "Positif (+)", "Nol", "Tak Terhingga"], answer: 0 
                        },
                        { 
                            question: "<div class='text-center text-8xl text-earth-600 mb-4'><i class='fas fa-minus'></i></div>Garis mendatar seperti ini memiliki kemiringan (gradien)...", 
                            options: ["Nol (0)", "Satu (1)", "Tak Terdefinisi", "Sepuluh"], answer: 0 
                        },
                        { 
                            question: "<div class='flex justify-center gap-4 text-6xl mb-4'><i class='fas fa-grip-lines-vertical'></i></div>Garis tegak lurus (Vertikal). Apakah ini Fungsi?", 
                            options: ["Bukan Fungsi", "Ya, Fungsi Linear", "Fungsi Kuadrat", "Fungsi Identitas"], answer: 0, explanation: "Garis vertikal melanggar syarat fungsi (satu input x punya banyak output y)." }
                    ]
                },

                // 4. Pola Geometris (Visual Pattern dengan EMOJI)
                {
                    title: "Pola Bangun Datar", icon: "fa-cubes", type: "app", appType: "pattern",
                    // Menggunakan Emoji sebagai visual
                    seq: ["üü¶", "üü¶üü¶\nüü¶üü¶", "üü¶üü¶üü¶\nüü¶üü¶üü¶\nüü¶üü¶üü¶"], 
                    ans: "16", 
                    hint: "Hitung jumlah kotak biru. Lihat bentuknya makin besar.",
                    opts: ["16", "12", "9", "20"]
                },

                // 5. Drag & Drop Visual (Ikon)
                {
                    title: "Sortir Bentuk", icon: "fa-object-group", type: "app", appType: "dragdrop",
                    desc: "Kelompokkan gambar ke kategori yang benar!",
                    // Menggunakan FontAwesome Icon di dalam item yang didrag
                    items: [
                        "<i class='fas fa-slash text-2xl'></i>", 
                        "<i class='fas fa-bezier-curve text-2xl'></i>", 
                        "<i class='fas fa-minus text-2xl'></i>", 
                        "<i class='fas fa-circle-notch text-2xl'></i>"
                    ],
                    explanation: "Garis lurus = Linear. Garis lengkung/lingkaran = Non-Linear."
                },

                // 6. Peta Kuadran (Image Map)
                {
                    title: "Peta Koordinat", icon: "fa-map-marked-alt", type: "image",
                    imgSrc: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Cartesian-coordinate-system.svg/300px-Cartesian-coordinate-system.svg.png",
                    desc: "Peta Wilayah Kartesius. Kuadran I (Kanan Atas) adalah wilayah positif semua (+,+)."
                },

                // 7. Mind Mapping (Gambar Sendiri)
                { 
                    title: "Kanvas Aljabar", icon: "fa-paint-brush", type: "app", appType: "draw", 
                    desc: "Ekspresikan pemahamanmu lewat coretan.",
                    contentList: [
                        { title: "Gambar Gradien", prompt: "Gambarlah 3 garis: Satu menanjak (Positif), satu menurun (Negatif), satu datar (Nol)." },
                        { title: "Sistem Persamaan", prompt: "Gambarlah dua garis yang bertabrakan di satu titik (Titik Potong)." }
                    ]
                },

                // 8. Visual Gradien Nyata (Foto)
                {
                    title: "Gradien Dunia Nyata", icon: "fa-camera", type: "image",
                    desc: "Matematika ada di sekelilingmu.",
                    contentList: [
                        { title: "Tangga", imgSrc: "https://images.unsplash.com/photo-1596236560756-382928dc4357?q=80&w=300&auto=format&fit=crop", desc: "Kemiringan tangga = Tinggi / Alas. Ini adalah Gradien!" },
                        { title: "Atap Rumah", imgSrc: "https://images.unsplash.com/photo-1599806112354-67f8b5425a06?q=80&w=300&auto=format&fit=crop", desc: "Atap yang curam memiliki nilai gradien yang besar agar air cepat turun." }
                    ]
                },

                // 9. Ilusi Optik
                {
                    title: "Ilusi Geometri", icon: "fa-low-vision", type: "image",
                    imgSrc: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/Cafe_wall.svg/300px-Cafe_wall.svg.png",
                    desc: "Garis-garis ini sebenarnya LURUS dan SEJAJAR (Gradien sama), tapi matamu melihatnya miring. Gunakan Aljabar untuk membuktikannya!"
                },

                // 10. Puzzle Aljabar Tiles (Visual Block)
                {
                    title: "Puzzle Luas", icon: "fa-th", type: "app", appType: "dragdrop",
                    desc: "Susun blok warna untuk membuat persegi panjang.",
                    items: [
                        "<div class='w-8 h-8 bg-blue-500 text-white text-xs flex items-center justify-center'>x¬≤</div>", 
                        "<div class='w-4 h-8 bg-green-500 text-white text-xs flex items-center justify-center'>x</div>", 
                        "<div class='w-4 h-4 bg-yellow-500 text-xs flex items-center justify-center border'>1</div>"
                    ],
                    explanation: "Visualisasi persamaan kuadrat dengan luas area."
                },

                // 11. Sketsa Solusi
                {
                    title: "Sketsa Solusi", icon: "fa-pencil-ruler", type: "app", appType: "draw",
                    desc: "Latihan memvisualisasikan solusi SPLDV tanpa menghitung.",
                    contentList: [
                        { title: "Satu Solusi", prompt: "Gambarlah huruf 'X'. Titik temunya adalah solusi." },
                        { title: "Tanpa Solusi", prompt: "Gambarlah rel kereta api (Garis Sejajar). Mereka tidak pernah bertemu." }
                    ]
                },

                // 12. Simbol Visual (Flashcard Ikon)
                {
                    title: "Simbol Geometri", icon: "fa-icons", type: "flashcard",
                    desc: "Bahasa gambar dalam matematika.",
                    contentList: [
                        { cards: [{f:"<i class='fas fa-equals text-4xl'></i>", b:"Sama Dengan (Seimbang Kiri Kanan)"}] },
                        { cards: [{f:"<i class='fas fa-not-equal text-4xl'></i>", b:"Pertidaksamaan (Berat Sebelah)"}] },
                        { cards: [{f:"‚ä•", b:"Tegak Lurus (Membentuk siku 90¬∞)"}] }
                    ]
                },

                // 13. Transformasi Grafik (Kuis Visual)
                {
                    title: "Geser Grafik", icon: "fa-arrows-alt", type: "quiz",
                    desc: "Bayangkan grafik bergerak.",
                    contentList: [
                        { question: "Jika garis <b class='text-blue-500'>y = x</b> digeser ke <b class='text-red-500'>ATAS</b> sebanyak 3 satuan, persamaannya jadi...", options: ["y = x + 3", "y = x - 3", "y = 3x", "y = x/3"], answer: 0 },
                        { question: "Garis mana yang paling 'Curam' (Menanjak tajam)?", options: ["y = 10x", "y = 2x", "y = x", "y = 0.5x"], answer: 0 }
                    ]
                },

                // 14. Bayangan Fungsi
                {
                    title: "Bayangan Domain", icon: "fa-lightbulb", type: "image",
                    imgSrc: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/df/Function_color_example_3.svg/300px-Function_color_example_3.svg.png",
                    desc: "Bayangkan Domain sebagai 'Warna Asal' dan Range sebagai 'Warna Hasil'."
                },

                // 15. Emosi Grafik (Draw)
                {
                    title: "Emosi Grafik", icon: "fa-smile-wink", type: "app", appType: "draw",
                    contentList: [
                        { prompt: "Gambarlah wajah tersenyum menggunakan parabola (y = x¬≤)!" },
                        { prompt: "Gambarlah wajah sedih menggunakan parabola terbalik (y = -x¬≤)!" }
                    ]
                },

                // 16. Tebak Titik (Kuis Visual)
                {
                    title: "Tebak Lokasi", icon: "fa-crosshairs", type: "quiz",
                    desc: "Visualisasikan posisi titik.",
                    contentList: [
                        { question: "Titik (0, 5) berada di...", options: ["Menempel di sumbu Y (Tegak)", "Menempel di sumbu X (Datar)", "Melayang di Kuadran I", "Titik Tengah"], answer: 0 },
                        { question: "Titik mana yang paling KIRI?", options: ["(-5, 2)", "(0, 2)", "(5, 2)", "(10, 2)"], answer: 0 }
                    ]
                }
            ]
        },
        { 
            id: "kinesthetic", name: "Bodily Kinesthetic", icon: "fa-running", color: "earth-800", hex: "#5E4934", 
            desc: "Belajar dengan Gerak, Sentuhan & Aktivitas Fisik", 
            media: [
                // 1-8 SAMA SEPERTI SEBELUMNYA...
                { title: "Lab Timbangan", icon: "fa-balance-scale", type: "app", appType: "balance", desc: "Simulasi Fisik: Seimbangkan beban kiri dan kanan." },
                { title: "Gradient Racer", icon: "fa-biking", type: "app", appType: "racer", desc: "Miringkan sepeda (Slider) sesuai curamnya bukit gradien!" },
                { title: "Sortir Variabel", icon: "fa-hand-paper", type: "app", appType: "dragdrop", desc: "Kelompokkan suku sejenis dengan jarimu.", items: ["3x", "5", "-2x", "10", "x", "-7"], explanation: "Gabungkan x dengan x, angka dengan angka." },
                { title: "Konstruktor Tiles", icon: "fa-th-large", type: "app", appType: "tiles", desc: "Susun balok-balok untuk membangun persamaan '2x + 3'." },
                { title: "Lompat Katak", icon: "fa-frog", type: "app", appType: "jumper", desc: "Tekan KANAN/KIRI untuk melompat di garis bilangan sesuai operasi hitung." },
                { title: "Senam Simbol", icon: "fa-child", type: "app", appType: "simon", desc: "Ikuti gerakan instruktur! Klik ikon tubuh yang sesuai dengan variabel." },
                { title: "Labirin (x,y)", icon: "fa-map-signs", type: "app", appType: "maze", desc: "Pandu titik merah menuju koordinat tujuan menggunakan tombol panah." },
                { title: "Memory Isyarat", icon: "fa-hands-helping", type: "app", appType: "memory", desc: "Cari pasangan kartu: Simbol Matematika vs Isyarat Tangan." },

                // 9. SPEED RUNNER (DIPERBAIKI)
                { title: "Speed Runner", icon: "fa-running", type: "app", appType: "runner", desc: "Atur kecepatan lari (Slider) untuk mengejar 'Hantu Math'!" },

                // 10-15 SAMA SEPERTI SEBELUMNYA...
                { title: "Rhythm Master", icon: "fa-drum", type: "app", appType: "rhythm_game", desc: "Tekan SPASI tepat pada ketukan pola barisan bilangan!" },
                { title: "Ukur Benda", icon: "fa-ruler", type: "app", appType: "ruler", desc: "Geser penggaris digital untuk mengukur keliling bangun datar." },
                { title: "Teka-teki Koin", icon: "fa-coins", type: "app", appType: "dragdrop", desc: "Pisahkan koin emas (positif) dan koin perak (negatif).", items: ["ü™ô", "ü™ô", "‚ö™", "‚ö™", "ü™ô"], explanation: "Koin sejenis dikumpulkan." },
                { title: "Tebak Emoji", icon: "fa-theater-masks", type: "quiz", desc: "Pilih emoji yang menggambarkan 'Gradien Negatif'!", contentList: [{question:"Mana ekspresi untuk Gradien Negatif (Turun)?", options:["üìâ","üìà","‚û°Ô∏è","‚¨ÜÔ∏è"], answer:0}, {question:"Mana ekspresi untuk x¬≤ (Positif)?", options:["üòä (Senyum)","‚òπÔ∏è (Cemberut)","üòê (Datar)","ü§î"], answer:0}] },
                { title: "Hitung Jari", icon: "fa-hand-paper", type: "app", appType: "fingers", desc: "Klik jari untuk melipat/membuka. Representasikan nilai x = 3." },
                { title: "Reflex Math", icon: "fa-basketball-ball", type: "app", appType: "reflex", desc: "Tangkap bola jawaban yang benar sebelum jatuh!" },

                // 16. MEDIA BARU: MERIAM LINEAR
                { title: "Meriam Linear", icon: "fa-bullseye", type: "app", appType: "cannon", desc: "Atur Sudut (m) dan Tinggi (c) meriam untuk menembak target!" }
            ]
        },
        { 
            id: "musical", name: "Musical", icon: "fa-music", color: "accent-green", hex: "#606C38", 
            desc: "Belajar Lewat Nada, Irama & Harmoni", 
            media: [
                // --- 1. MEDIA EKSISTING (DIPERBAIKI) ---
                { 
                    title: "Drum Pola Bilangan", icon: "fa-drum", type: "app", appType: "sequencer", 
                    desc: "Buat beat drum berdasarkan barisan aritmatika & geometri.",
                    contentList: [
                        { title: "Pola 4/4 (Genap)", seq: [1,0,1,0, 1,0,1,0], hint: "Ketukan pada hitungan 1, 3, 5..." },
                        { title: "Pola Geometri (x2)", seq: [1,0,1,0, 0,0,1,0], hint: "Ketuk pada 1, 2, 4, 8..." }
                    ]
                },
                { 
                    title: "Studio Rap Aljabar", icon: "fa-microphone-alt", type: "app", appType: "lyrics", 
                    desc: "Isi lirik rap yang hilang agar rimanya pas dengan rumus!",
                    contentList: [
                        { title: "Rap Eliminasi", lyrics: ["Ada dua persamaan, bikin kepala pusing", "Mari kita hilangkan, biar nggak jadi ______", "(asing/pusing)", "Cari nilai X dulu, jangan ragu-ragu", "Metode eliminasi, solusinya ______", "(menunggu/belagu)"] }
                    ]
                },
                { 
                    title: "Osilator Gelombang", icon: "fa-wave-square", type: "app", appType: "wave", 
                    desc: "Lihat dan dengar frekuensi bunyi. (Fungsi Sinus)", 
                },
                { 
                    title: "Kuis Telinga", icon: "fa-headphones", type: "quiz", 
                    desc: "Dengarkan pola nadanya, tebak jenis barisannya.",
                    contentList: [
                        { question: "üéµ (Nada naik stabil: Do-Re-Mi-Fa...). Ini pola apa?", options: ["Aritmatika (Linear)", "Geometri (Eksponensial)", "Acak", "Tetap"], answer: 0 },
                        { question: "üéµ (Nada melompat cepat: Do-Mi-Sol-Do tinggi...). Ini pola?", options: ["Geometri (Rasio)", "Aritmatika (Beda)", "Konstan", "Turun"], answer: 0 }
                    ]
                },

                // --- 2. 12 MEDIA BARU (INSTRUMEN DIGITAL) ---

                // 5. PIANO ALJABAR (Synthesizer)
                {
                    title: "Piano Aljabar", icon: "fa-keyboard", type: "app", appType: "piano",
                    desc: "Mainkan fungsi f(x) = x + 2. Jika kamu tekan tuts 1, bunyinya tuts 3.",
                    func: "x + 2"
                },

                // 6. GRAFIK BERSUARA (Sonification)
                {
                    title: "Melodi Grafik", icon: "fa-chart-line", type: "app", appType: "graph_sound",
                    desc: "Gambar grafik, lalu tekan Play. Dengar nadanya naik/turun sesuai garis!",
                },

                // 7. INTERVAL RASIO (Fractions)
                {
                    title: "Rasio Interval", icon: "fa-music", type: "app", appType: "intervals",
                    desc: "Pecahan dalam musik. 1/2 itu Oktaf, 2/3 itu Fifth.",
                },

                // 8. METRONOME VARIABEL (BPM)
                {
                    title: "Metronome X", icon: "fa-tachometer-alt", type: "app", appType: "metronome",
                    desc: "Atur variabel x (BPM). Rasakan bedanya kecepatan 60 vs 120.",
                },

                // 9. LOOPING TRACKS (Sistem Persamaan)
                {
                    title: "Looping SPLDV", icon: "fa-compact-disc", type: "app", appType: "looper",
                    desc: "Track 1: Pola 2 detik. Track 2: Pola 3 detik. Kapan mereka bunyi bareng? (KPK).",
                },

                // 10. KALKULATOR NADA (Frequency)
                {
                    title: "Kalkulator Hz", icon: "fa-calculator", type: "app", appType: "freq_calc",
                    desc: "Rumus Fisika Musik: f = 440 * 2^(x/12). Masukkan x!",
                },

                // 11. HARMONI ATAU DISONANSI (Logic)
                {
                    title: "Cek Harmoni", icon: "fa-check-double", type: "app", appType: "chord",
                    desc: "Dua nada dimainkan. Apakah 'Cocok' (Solusi Ada) atau 'Fals' (Tanpa Solusi)?",
                },

                // 12. TANGGA NADA FIBONACCI
                {
                    title: "Piano Fibonacci", icon: "fa-shoe-prints", type: "app", appType: "piano_fib",
                    desc: "Piano khusus yang hanya membunyikan nada ke 1, 1, 2, 3, 5, 8...",
                },

                // 13. SOUNDSCAPE EMOSI (Mood)
                {
                    title: "Musik Gradien", icon: "fa-smile", type: "app", appType: "mood_sound",
                    desc: "Gradien Positif = Nada Major (Bahagia). Gradien Negatif = Nada Minor (Sedih).",
                },

                // 14. FLASHCARD NOTASI
                {
                    title: "Notasi Matematika", icon: "fa-sticky-note", type: "flashcard",
                    desc: "Simbol musik vs Simbol Aljabar.",
                    contentList: [
                        { cards: [{f:"Not Penuh (1)", b:"Satu Satuan Utuh (x)"}] },
                        { cards: [{f:"Not 1/4", b:"Pecahan 0.25 atau x/4"}] },
                        { cards: [{f:"Tanda Diam", b:"Nilai Nol (0)"}] }
                    ]
                },

                // 15. BEAT MAKER (Coordinate)
                {
                    title: "Koordinat Beat", icon: "fa-th", type: "app", appType: "sequencer",
                    desc: "Sumbu X = Waktu, Sumbu Y = Nada. Gambar lagumu di diagram Kartesius!",
                },

                // 16. DIRIGEN VIRTUAL (Mouse Interaction)
                {
                    title: "Dirigen Grafik", icon: "fa-hand-pointer", type: "app", appType: "conductor",
                    desc: "Gerakkan mouse naik/turun untuk mengubah tinggi nada secara real-time.",
                }
            ]
        },
        { 
            id: "interpersonal", name: "Interpersonal", icon: "fa-users", color: "accent-orange", hex: "#BC6C25", 
            desc: "Belajar Lewat Interaksi, Diskusi & Empati", 
            media: [
                // --- 1. MEDIA LAMA (DIPERLUAS VARIASINYA) ---
                { 
                    title: "Simulasi Tawar Menawar", icon: "fa-comments-dollar", type: "app", appType: "chat", 
                    desc: "Latihan negosiasi menggunakan model matematika.",
                    contentList: [
                        { title: "Pasar Buah", chatData: [{sender:"Penjual", msg:"2 kg Apel dan 1 kg Jeruk harganya 50rb."}, {sender:"You", msg:"(Modelkan: 2a + j = 50000)"}] },
                        { title: "Toko Baju", chatData: [{sender:"Kasir", msg:"Diskon 20% untuk pembelian di atas 100rb."}, {sender:"You", msg:"(Modelkan: Bayar = 0.8x jika x > 100000)"}] },
                        { title: "Ojek Online", chatData: [{sender:"Driver", msg:"Tarif dasar 10rb, plus 2rb per km."}, {sender:"You", msg:"(Rumus: y = 2000x + 10000)"}] }
                    ]
                },
                { 
                    title: "Survey Sosial", icon: "fa-poll", type: "input", inputType: "textarea", 
                    desc: "Kumpulkan data dari teman-temanmu.",
                    contentList: [
                        { prompt: "Tanya 5 teman: Ukuran sepatu vs Tinggi Badan. Apakah ada pola linear?" },
                        { prompt: "Cek uang saku 3 teman. Buat rata-rata (mean) dalam bentuk aljabar (x+y+z)/3." }
                    ]
                },
                { 
                    title: "Split Bill", icon: "fa-receipt", type: "app", appType: "calculator", calcType: "bill", 
                    desc: "Aplikasi hitung patungan makan biar adil." 
                },
                { 
                    title: "Kartu Diskusi", icon: "fa-comments", type: "task", 
                    desc: "Topik seru untuk dibahas bareng teman sebangku.",
                    contentList: [
                        { content: "Debat: Apakah 0 itu bilangan genap? Gunakan aljabar (2n) untuk membuktikannya!" },
                        { content: "Jelaskan ke temanmu: Kenapa pindah ruas mengubah tanda plus jadi minus? (Analogi Timbangan)" }
                    ]
                },

                // --- 2. 12 MEDIA BARU (INTERAKTIF SOSIAL) ---

                // 5. MAGIC MATH (Tebak Pikiran)
                {
                    title: "Magic Reader", icon: "fa-hat-wizard", type: "app", appType: "magic",
                    desc: "Aku bisa menebak angkamu menggunakan Aljabar! (Buktikan: ((x+5)*2 - 10)/2 = x)",
                },

                // 6. MEDIATOR KONFLIK (Analisis Error)
                {
                    title: "Mediator Konflik", icon: "fa-handshake", type: "quiz",
                    desc: "Dua temanmu berdebat jawaban. Siapa yang benar?",
                    contentList: [
                        { question: "Budi: '3(x+2) = 3x + 2'.\nAni: 'Salah! Harusnya 3x + 6'.\nSiapa yang benar?", options: ["Ani Benar", "Budi Benar", "Keduanya Salah", "Keduanya Benar"], answer: 0, explanation: "Sifat Distributif: a(b+c) = ab + ac." },
                        { question: "Tom: 'x - 5 = 10, jadi x = 5'.\nJerry: 'x = 15'.", options: ["Jerry Benar", "Tom Benar", "Bingung", "Salah Semua"], answer: 0 }
                    ]
                },

                // 7. WAWANCARA TOKOH (Chat Bot)
                {
                    title: "Chat Al-Khwarizmi", icon: "fa-user-astronaut", type: "app", appType: "chat",
                    desc: "Ngobrol imajiner dengan Bapak Aljabar.",
                    chatData: [
                        {sender:"Al-Khwarizmi", msg:"Assalamualaikum. Saya menemukan metode Al-Jabr. Tahukah kamu artinya?"},
                        {sender:"You", msg:"Memperbaiki bagian yang rusak?"},
                        {sender:"Al-Khwarizmi", msg:"Tepat! Memindahkan suku negatif agar menjadi positif. Seperti mengobati tulang patah."}
                    ]
                },

                // 8. DEBAT MATEMATIKA (Chat Skenario)
                {
                    title: "Debat Aljabar", icon: "fa-gavel", type: "app", appType: "chat",
                    desc: "Lawan argumen yang salah!",
                    chatData: [
                        {sender:"Skeptis", msg:"Aljabar itu gak penting. Ngapain cari x?"},
                        {sender:"You", msg:"Tanpa x, kita gak bisa bikin program komputer atau prediksi cuaca!"},
                        {sender:"Skeptis", msg:"Tapi aku mau jadi seniman, bukan ilmuwan."},
                        {sender:"You", msg:"Proporsi wajah, perspektif gambar, semua butuh rasio matematika lho."}
                    ]
                },

                // 9. KONSULTAN AMAL (Budgeting)
                {
                    title: "Konsultan Amal", icon: "fa-hand-holding-heart", type: "app", appType: "budget",
                    desc: "Atur anggaran acara amal. Pastikan Total = Rp 10 Juta.",
                },

                // 10. GURU CILIK (Teaching)
                {
                    title: "Guru Cilik", icon: "fa-chalkboard-teacher", type: "input", inputType: "textarea",
                    desc: "Tantangan: Jelaskan konsep Variabel kepada adik umur 5 tahun.",
                    prompt: "Gunakan analogi 'Kotak Misteri' atau 'Amplop' untuk menjelaskan huruf x."
                },

                // 11. DETEKTIF GOSIP (Logic Puzzle)
                {
                    title: "Detektif Gosip", icon: "fa-user-secret", type: "quiz",
                    desc: "Pecahkan masalah berdasarkan keterangan saksi.",
                    contentList: [
                        { question: "Andi: 'Umurku x'. Budi: 'Umurku 2x'. Cici: 'Umurku x+5'.\nJika total umur mereka 45, berapa umur Andi?", options: ["10 Tahun", "5 Tahun", "15 Tahun", "20 Tahun"], answer: 0, explanation: "x + 2x + x + 5 = 45 -> 4x = 40 -> x = 10." },
                        { question: "Ali punya kelereng y. Baba punya y - 3. Total 17. Berapa kelereng Ali?", options: ["10", "7", "13", "20"], answer: 0 }
                    ]
                },

                // 12. KOLABORASI TIM (Task)
                {
                    title: "Misi Rahasia", icon: "fa-user-friends", type: "task",
                    desc: "Permainan berpasangan.",
                    contentList: [
                        { content: "Cari 1 partner. Kamu pegang angka '5', partnermu pegang 'x'. Lakukan operasi: Kalikan angka kalian, lalu kurangi 2. Berapa hasilnya?" },
                        { content: "Partner A tulis persamaan. Partner B yang menyelesaikannya. Tukar peran!" }
                    ]
                },

                // 13. KASIR DADAKAN (Speed Calc)
                {
                    title: "Kasir Dadakan", icon: "fa-cash-register", type: "app", appType: "cashier",
                    desc: "Hitung total belanja pelanggan secepat mungkin! (x = harga barang)",
                },

                // 14. SURAT SAHABAT (Input)
                {
                    title: "Surat Sahabat", icon: "fa-envelope", type: "input", inputType: "textarea",
                    desc: "Tulis surat untuk teman yang benci Matematika.",
                    prompt: "Yakinkan dia bahwa Aljabar itu seperti puzzle game yang seru, bukan musuh."
                },

                // 15. KOMENTATOR GAME (Narasi)
                {
                    title: "Komentator", icon: "fa-microphone", type: "input", inputType: "textarea",
                    desc: "Jadilah komentator balapan grafik.",
                    prompt: "Grafik A (2x) menyalip Grafik B (x+5)! Tulis narasi seru saat mereka berpotongan (titik temu)."
                },

                // 16. TEBAK KATA (Team Game)
                {
                    title: "Taboo Math", icon: "fa-ban", type: "task",
                    desc: "Jelaskan kata ini ke temanmu TANPA menyebut kata terlarang.",
                    contentList: [
                        { content: "Kata Kunci: 'VARIABEL'. Dilarang sebut: Huruf, Angka, X, Y." },
                        { content: "Kata Kunci: 'GRADIEN'. Dilarang sebut: Miring, Garis, Tanjakan." }
                    ]
                }
            ]
        },
        { 
            id: "intrapersonal", name: "Intrapersonal", icon: "fa-user", color: "earth-600", hex: "#606C38", 
            desc: "Belajar Lewat Refleksi, Emosi & Tujuan Diri", 
            media: [
                // --- 1. MEDIA LAMA (DIPERLUAS MENJADI APLIKASI) ---
                { 
                    title: "Jurnal Kesalahan", icon: "fa-book-open", type: "app", appType: "journal", 
                    desc: "Catat error matematikamu. Apakah karena ceroboh atau belum paham konsep?",
                },
                { 
                    title: "Kalkulator Target", icon: "fa-bullseye", type: "app", appType: "goals", 
                    desc: "Hitung nilai yang harus kamu dapatkan di ujian nanti agar Lulus/Dapat A.", 
                },
                { 
                    title: "Mood Tracker", icon: "fa-smile-beam", type: "app", appType: "mood_tracker", 
                    desc: "Rekam perasaanmu sebelum dan sesudah belajar. Cek pola emosimu.", 
                },
                { 
                    title: "Cek Pemahaman", icon: "fa-clipboard-check", type: "app", appType: "checklist", 
                    desc: "Jujur pada diri sendiri: Konsep mana yang sudah 100% aku kuasai?",
                    items: ["Membedakan Variabel & Konstanta", "Operasi Penjumlahan Aljabar", "Substitusi Nilai x", "Pindah Ruas Persamaan", "Membuat Model Matematika"] 
                },

                // --- 2. 12 MEDIA BARU (SELF-REFLECTION TOOLS) ---

                // 5. MEDITASI MATEMATIKA (Breathing)
                {
                    title: "Meditasi Fokus", icon: "fa-spa", type: "app", appType: "meditation",
                    desc: "Tenangkan kecemasan matematikamu dengan teknik pernapasan 4-7-8.",
                },

                // 6. DETOKS PIKIRAN (Stress Relief)
                {
                    title: "Hancurkan Takut", icon: "fa-bomb", type: "app", appType: "detox",
                    desc: "Tulis ketakutanmu (misal: 'Aku bodoh'), lalu ledakkan tulisan itu secara digital!",
                },

                // 7. RUANG ZEN (Timer Fokus)
                {
                    title: "Ruang Zen", icon: "fa-hourglass-half", type: "app", appType: "zen",
                    desc: "Timer Pomodoro minimalis. 25 menit fokus penuh tanpa gangguan.",
                },

                // 8. AFIRMASI POSITIF (Card Generator)
                {
                    title: "Kartu Kekuatan", icon: "fa-heart", type: "app", appType: "affirmation",
                    desc: "Dapatkan pesan penyemangat acak untuk membangun kepercayaan diri.",
                },

                // 9. ANALISIS SWOT DIRI
                {
                    title: "SWOT Belajar", icon: "fa-table", type: "app", appType: "swot",
                    desc: "Petakan Kekuatan (Strengths) dan Kelemahan (Weaknesses) cara belajarmu.",
                },

                // 10. SURAT MASA DEPAN
                {
                    title: "Surat u/ Aku", icon: "fa-paper-plane", type: "app", appType: "letter",
                    desc: "Tulis pesan untuk dirimu di akhir semester. Apa harapanmu?",
                },

                // 11. ANALOGI KEPRIBADIAN
                {
                    title: "Siapa Aku?", icon: "fa-id-card-alt", type: "app", appType: "analogy",
                    desc: "Jika kamu adalah Grafik Fungsi, kamu tipe yang mana?",
                    contentList: [
                        { title: "Linear", desc: "Lurus, tegas, konsisten. (y = x)" },
                        { title: "Kuadrat", desc: "Emosional, ada naik ada turun. (y = x¬≤)" },
                        { title: "Konstan", desc: "Tenang, tidak mudah berubah. (y = c)" }
                    ]
                },

                // 12. GRAFIK SEMANGAT (Draw)
                {
                    title: "Grafik Semangat", icon: "fa-chart-area", type: "app", appType: "draw",
                    desc: "Gambarlah grafik naik-turun semangat belajarmu minggu ini.",
                },

                // 13. TIME MANAGER (Efficiency)
                {
                    title: "Audit Waktu", icon: "fa-clock", type: "app", appType: "time_calc",
                    desc: "Berapa jam kamu belajar vs main HP? Hitung rasionya.",
                },

                // 14. MY WHY (Deep Reflection)
                {
                    title: "Kenapa Matematika?", icon: "fa-question-circle", type: "input", inputType: "textarea",
                    desc: "Temukan alasan pribadimu belajar ini (Bukan karena disuruh guru).",
                    prompt: "Aku belajar Aljabar agar aku bisa melatih logikaku untuk..."
                },

                // 15. BIOGRAFI CERMIN (Quiz)
                {
                    title: "Kembaran Tokoh", icon: "fa-user-tie", type: "quiz",
                    desc: "Siapa matematikawan yang kepribadiannya mirip kamu?",
                    contentList: [
                        { question: "Saat ada masalah sulit, aku...", options: ["Merenung sendirian (Newton)", "Diskusi ramai-ramai (Erdos)", "Cari pola visual (Fibonacci)", "Menyerah"], answer: 0 }
                    ]
                },

                // 16. KOTAK SYUKUR (Gratitude)
                {
                    title: "Kotak Syukur", icon: "fa-praying-hands", type: "app", appType: "gratitude",
                    desc: "Hal kecil apa yang berhasil kamu pahami hari ini? Rayakanlah.",
                }
            ]
        },
        { 
            id: "naturalist", name: "Naturalist", icon: "fa-leaf", color: "earth-900", hex: "#283618", 
            desc: "Belajar dari Alam: Pola, Lingkungan & Makhluk Hidup", 
            media: [
                // 1. FIBONACCI (Existing)
                { title: "Fibonacci Alam", icon: "fa-seedling", type: "app", appType: "pattern", seq: ["1", "1", "2", "3", "5"], ans: "8", hint: "Jumlahkan 2 angka sebelumnya", opts: ["7", "8", "9", "10"] },

                // 2. SIMULASI TUMBUH (Visual Tanaman)
                { title: "Simulasi Tumbuh", icon: "fa-tree", type: "app", appType: "plant_grow", desc: "Siram tanaman (Variable x) untuk melihat pertumbuhannya (Fungsi y)." },

                // 3. TAKSONOMI (Drag Drop)
                { title: "Taksonomi Aljabar", icon: "fa-sitemap", type: "app", appType: "dragdrop", desc: "Klasifikasikan spesies aljabar.", items: ["2x", "5y", "x¬≤", "7", "-3x", "10"], explanation: "Kelompokkan Suku Sejenis." },

                // 4. POPULASI KELINCI (Quiz)
                { title: "Populasi Kelinci", icon: "fa-paw", type: "quiz", contentList: [{question: "Pola 2, 4, 8, 16... adalah?", options: ["Geometri", "Aritmatika", "Linear", "Tetap"], answer: 0}] },

                // 5. SUHU JANGKRIK (Calculator)
                { title: "Suhu Jangkrik", icon: "fa-bug", type: "app", appType: "cricket", desc: "Jangkrik adalah termometer alami. Hitung suhunya!" },

                // 6. JEJAK KARBON (Environmental)
                { title: "Jejak Karbon", icon: "fa-smog", type: "app", appType: "carbon", desc: "Seimbangkan emisi (x) dengan jumlah pohon (y)." },

                // 7. POLA CUACA (Quiz)
                { title: "Pola Cuaca", icon: "fa-cloud-sun-rain", type: "quiz", contentList: [{question: "Suhu naik 2¬∞C per jam. Modelnya?", options: ["T = 2x + Awal", "T = x - 2", "T = 2x¬≤", "T = 2"], answer: 0}] },

                // 8. GRADIEN SUNGAI (Physics/Canvas)
                { title: "Gradien Sungai", icon: "fa-water", type: "app", appType: "river", desc: "Atur kemiringan sungai (m) untuk mengendalikan arus air." },

                // 9. MESIN DAUN (Photosynthesis)
                { title: "Mesin Daun", icon: "fa-sun", type: "app", appType: "leaf_machine", desc: "Input Cahaya (x) & Air (y) -> Output Gula (z). Cek reaksinya!" },

                // 10. SARANG LEBAH (Pattern)
                { title: "Sarang Lebah", icon: "fa-cube", type: "app", appType: "pattern", seq: ["‚ñ≤", "‚ñ†", "‚¨°", "?"], ans: "‚¨°", hint: "Pilih pola yang paling efisien menutup ruang.", opts: ["‚¨°", "‚óè", "‚òÖ", "‚ñ≤"] },

                // 11. RANTAI MAKANAN (System Balance)
                { title: "Rantai Makanan", icon: "fa-link", type: "app", appType: "food_chain", desc: "Jaga keseimbangan ekosistem Rumput, Rusa, dan Serigala." },

                // 12. HEMAT AIR (Modeling)
                { title: "Hemat Air", icon: "fa-tint", type: "input", inputType: "textarea", prompt: "Keran bocor menetes 5ml/menit. Tulis rumus y (total air) terhadap x (menit)." },

                // 13. LINGKARAN TAHUN (Quiz)
                { title: "Usia Pohon", icon: "fa-history", type: "quiz", contentList: [{question: "1 Lingkaran = 1 Tahun. Jika diameter bertambah 2cm/thn, ini fungsi?", options: ["Linear", "Kuadrat", "Tetap", "Acak"], answer: 0}] },

                // 14. PETRI DISH (Bakteri)
                { title: "Petri Dish", icon: "fa-vial", type: "app", appType: "bacteria", desc: "Simulasi pembelahan sel eksponensial (2^n)." },

                // 15. NAVIGASI BURUNG (Coordinate)
                { title: "Navigasi Burung", icon: "fa-dove", type: "app", appType: "bird_nav", desc: "Bantu burung migrasi dari titik A ke B menggunakan koordinat." },

                // 16. DATA GEMPA (Scatter Plot)
                { title: "Data Gempa", icon: "fa-house-damage", type: "app", appType: "quake", desc: "Analisis persebaran titik gempa pada peta koordinat." }
            ]
        }
    ];

    // --- 2. INITIALIZATION & RENDER LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        loadUser(); renderSidebar(); renderSections(); updateProfileUI();
        if(userProfile.streak > 1) setTimeout(() => confetti({ particleCount: 50, spread: 70, origin: { y: 0.6 }, colors: ['#606C38'] }), 1000);
    });

    const loginForm = document.getElementById('login-form');
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');

    function renderSidebar() {
        const sidebarMenu = document.getElementById('sidebar-menu');
        
        // 1. Bagian Header & Gaya Belajar
        let html = `
        <a href="#introduction" class="group flex items-center gap-3 px-4 py-3 rounded-xl text-earth-800 font-bold hover:bg-earth-200 transition-colors mb-4 border border-transparent hover:border-earth-300">
            <i class="fas fa-home text-earth-600"></i> <span>Beranda</span>
        </a>
        <div class="px-4 text-[10px] font-bold text-earth-500 uppercase mb-2 tracking-widest">Gaya Belajar</div>`;
        
        // Loop menu gaya belajar yang sudah ada
        intelligenceData.forEach(item => {
            html += `<a href="#${item.id}" class="flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-earth-700 hover:bg-earth-100 transition-all group border border-transparent hover:border-earth-200">
                <div class="w-6 h-6 rounded flex items-center justify-center text-xs" style="background-color:${item.hex}20; color:${item.hex}"><i class="fas ${item.icon}"></i></div>
                <span class="group-hover:translate-x-1 transition-transform font-medium">${item.name}</span></a>`;
        });

        // 2. BAGIAN BARU: PUSTAKA E-BOOK (Tambahkan Kode Ini)
        html += `
        <div class="my-4 border-t border-earth-200"></div>
        <div class="px-4 text-[10px] font-bold text-earth-500 uppercase mb-2 tracking-widest">Pustaka Materi</div>
        
        <a href="https://online.fliphtml5.com/USERNAME/BOOK_ID" target="_blank" class="flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-earth-700 hover:bg-blue-50 transition-all group border border-transparent hover:border-blue-200">
            <div class="w-6 h-6 rounded flex items-center justify-center text-xs bg-blue-100 text-blue-600"><i class="fas fa-book-open"></i></div>
            <span class="group-hover:translate-x-1 transition-transform font-medium">Buka Flipbook</span>
        </a>

        <a href="path/to/modul-aljabar.pdf" download class="flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-earth-700 hover:bg-red-50 transition-all group border border-transparent hover:border-red-200">
            <div class="w-6 h-6 rounded flex items-center justify-center text-xs bg-red-100 text-red-600"><i class="fas fa-file-pdf"></i></div>
            <span class="group-hover:translate-x-1 transition-transform font-medium">Download PDF</span>
        </a>
        <button onclick="openTeam()" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-earth-700 hover:bg-purple-50 transition-all group text-left">
            <div class="w-6 h-6 rounded flex items-center justify-center text-xs bg-purple-100 text-purple-600"><i class="fas fa-users-cog"></i></div>
            <span class="group-hover:translate-x-1 transition-transform font-medium">Profil Pengembang</span>
        </button>
        `;
        html += `
        <div class="p-4 mt-4 border-t border-earth-200">
            <button onclick="showClosing()" class="w-full py-3 flex items-center gap-3 px-4 rounded-xl text-accent-red bg-red-50 hover:bg-red-100 transition-colors md:justify-start justify-center font-bold shadow-sm">
                <i class="fas fa-flag-checkered"></i>
                <span class="hidden md:inline">Selesai Belajar</span>
            </button>
        </div>
        `;

        sidebarMenu.innerHTML = html;
    }

    function renderSections() {
        const intContainer = document.getElementById('intelligences-container');
        if (!intContainer) return;
        intContainer.innerHTML = intelligenceData.map(item => `
            <section id="${item.id}" class="scroll-mt-6">
                <div class="glass-card rounded-3xl overflow-hidden p-1 transition-all duration-500 hover:shadow-2xl">
                    <div class="p-8 border-b border-earth-200 flex items-center gap-6 relative overflow-hidden" style="background: linear-gradient(to right, ${item.hex}15, transparent)">
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-sm relative z-10 bg-white border border-earth-100" style="color:${item.hex}">
                            <i class="fas ${item.icon}"></i>
                        </div>
                        <div class="relative z-10">
                            <h3 class="text-2xl md:text-3xl font-serif font-bold text-earth-900">${item.name}</h3>
                            <p class="text-earth-600 text-sm md:text-base mt-1 font-medium">${item.desc}</p>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-32 bg-gradient-to-l from-white/40 to-transparent"></div>
                    </div>
                    <div class="p-6 md:p-8 bg-[#FDFCF5]">
                        <h4 class="text-xs font-bold text-earth-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                            <i class="fas fa-cubes"></i> Media Pembelajaran
                        </h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            ${item.media.map((m, idx) => `
                                <div onclick="openMedia('${item.id}', ${idx})" class="media-card bg-white rounded-xl p-4 border border-earth-200 cursor-pointer flex flex-col items-center text-center h-full group relative overflow-hidden hover:border-[${item.hex}]" style="--hover-color:${item.hex}">
                                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition-transform duration-300 bg-earth-50 text-earth-600" style="color:${item.hex}; background-color:${item.hex}15">
                                        <i class="fas ${m.icon}"></i>
                                    </div>
                                    <h5 class="font-bold text-sm text-earth-800 leading-tight mb-2 line-clamp-2">${m.title}</h5>
                                    <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-1 rounded-full bg-earth-100 text-earth-500">${m.type === 'app' ? 'Interaktif' : m.type}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </section>
        `).join('');
    }

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('student-name').value;
        if(name.trim()) {
            userProfile.name = name; saveUser();
            document.getElementById('user-greeting').textContent = `Halo, ${name}!`;
            loginScreen.style.opacity = '0';
            setTimeout(() => {
                loginScreen.style.display = 'none';
                appContainer.style.display = 'flex'; void appContainer.offsetWidth; appContainer.style.opacity = '1'; appContainer.style.pointerEvents = 'auto';
                renderSidebar(); renderSections();
                const slides = document.querySelectorAll('.story-slide'); if(slides.length > 0) slides[0].classList.add('active');
            }, 500);
        }
    });

    // --- 3. CORE LOGIC (INTERACTIVE APPS) ---
    let currentCatId, currentMediaIndex, currentSubContentIndex = 0, sessionStartTime = 0;
    
    function openMedia(catId, index) {
        currentCatId = catId; currentMediaIndex = index; currentSubContentIndex = 0; sessionStartTime = Date.now();
        renderModalContent();
        document.getElementById('media-modal').classList.remove('hidden');
        
        // Tracking untuk Badge Explorer
        if(!userProfile.progress.modulesVisited) userProfile.progress.modulesVisited = {};
        userProfile.progress.modulesVisited[catId] = (userProfile.progress.modulesVisited[catId] || 0) + 1;
        
        // BADGE PENJELAJAH (Buka 5 Kategori Berbeda)
        if(Object.keys(userProfile.progress.modulesVisited).length >= 5) unlockBadge('explorer');
        
        addXP(5);
    }

    function closeModal() {
        // --- TAMBAHAN FIX ---
        if(window.stopGame) window.stopGame();
        if(window.stopReflex) window.stopReflex(); 
        // --------------------

        document.getElementById('media-modal').classList.add('hidden');
        // ... (lanjutan kode asli) ...
        const duration = (Date.now() - sessionStartTime) / 1000;
        if(!userProfile.progress.timePerType[currentCatId]) userProfile.progress.timePerType[currentCatId] = 0;
        userProfile.progress.timePerType[currentCatId] += duration; saveUser();
        setTimeout(() => document.getElementById('modal-content').innerHTML = '', 300);
    }

    function navContent(dir) {
        const cat = intelligenceData.find(x => x.id === currentCatId);
        const item = cat.media[currentMediaIndex];
        if(!item.contentList) return;
        currentSubContentIndex += dir;
        if(currentSubContentIndex >= item.contentList.length) currentSubContentIndex = 0;
        else if(currentSubContentIndex < 0) currentSubContentIndex = item.contentList.length - 1;
        renderModalContent();
    }

    // Swipe handlers for mobile
    let ts = 0, te = 0;
    document.getElementById('media-modal').addEventListener('touchstart', e => ts = e.changedTouches[0].screenX, {passive:true});
    document.getElementById('media-modal').addEventListener('touchend', e => { te = e.changedTouches[0].screenX; if(te < ts - 50) navContent(1); if(te > ts + 50) navContent(-1); }, {passive:true});

    function renderModalContent() {
        // --- TAMBAHAN FIX: Reset semua game saat pindah konten ---
        if(window.stopGame) window.stopGame();     // Matikan Jumper/Racer/Maze
        if(window.stopReflex) window.stopReflex(); // Matikan Reflex Math
        if(window.stopSimon) window.stopSimon();   // Matikan Simon Says
        if(window.stopLooper) window.stopLooper(); // Matikan Musik Looper
        if(window.stopCond) window.stopCond();     // Matikan Dirigen
        // ---------------------------------------------------------

        const cat = intelligenceData.find(x => x.id === currentCatId);
        // ... (lanjutan kode asli di bawahnya jangan dihapus) ...
        let item = {...cat.media[currentMediaIndex]};
        const controls = document.getElementById('nav-controls');
        
        if(item.contentList && item.contentList.length > 0) {
            item = { ...item, ...item.contentList[currentSubContentIndex] };
            controls.classList.remove('hidden'); controls.classList.add('flex');
            document.getElementById('nav-counter').innerText = `${currentSubContentIndex + 1}/${cat.media[currentMediaIndex].contentList.length}`;
        } else { controls.classList.add('hidden'); }

        document.getElementById('modal-title').innerHTML = item.title;
        document.getElementById('modal-header').style.backgroundColor = cat.hex;
        const container = document.getElementById('modal-content');
        let html = '';

        if(item.type === 'app') html = renderApp(item.appType, cat, item);
        else if(item.type === 'quiz') html = `<div class="max-w-xl mx-auto mt-4 md:mt-10 bg-white p-8 md:p-10 rounded-3xl shadow-lg border border-earth-200 animate-fade-in-up"><div class="w-16 h-16 rounded-full bg-earth-50 text-earth-700 mx-auto flex items-center justify-center text-2xl mb-6 shadow-sm border border-earth-100"><i class="fas fa-question"></i></div><h4 class="text-xl font-bold mb-8 text-earth-800 text-center leading-snug">${item.question}</h4><div class="space-y-3">${item.options.map((opt, i) => `<button onclick="checkQuiz(this, ${i === item.answer}, '${item.explanation || ''}')" class="w-full p-4 rounded-xl border-2 border-earth-100 hover:border-[${cat.hex}] hover:bg-earth-50 transition font-medium text-left relative group flex items-center text-earth-700" style="--hover-color:${cat.hex}"><div class="w-8 h-8 rounded-full bg-earth-200 text-earth-600 font-bold flex items-center justify-center mr-4 text-xs group-hover:bg-[${cat.hex}] group-hover:text-black transition">${String.fromCharCode(65+i)}</div><span class="flex-1">${opt}</span><span class="feedback absolute right-4 hidden text-xl"></span></button>`).join('')}</div><div id="quiz-explanation" class="hidden mt-6 p-4 bg-accent-cream border border-earth-200 rounded-xl text-sm font-medium text-earth-800"></div></div>`;
        else if(item.type === 'flashcard') html = `<div class="flex flex-col items-center justify-center h-full cursor-pointer perspective-1000 animate-fade-in" onclick="this.querySelector('.f-inner').classList.toggle('rotate-y-180')"><div class="relative w-80 h-52 group"><div class="f-inner relative w-full h-full transition-transform duration-700 transform-style-3d"><div class="absolute inset-0 w-full h-full bg-white rounded-3xl shadow-xl border-2 border-earth-200 flex flex-col items-center justify-center backface-hidden p-6 text-center"><span class="text-xs font-bold text-earth-400 uppercase tracking-widest mb-2">Istilah</span><h3 class="text-2xl font-bold text-earth-800 font-serif">${item.cards[0].f}</h3><p class="text-xs text-earth-400 mt-4"><i class="fas fa-sync"></i> Klik balik</p></div><div class="absolute inset-0 w-full h-full bg-earth-700 text-white rounded-3xl shadow-xl flex flex-col items-center justify-center backface-hidden rotate-y-180 p-6 text-center" style="background-color:${cat.hex}"><span class="text-xs font-bold text-white/70 uppercase tracking-widest mb-2">Definisi</span><h3 class="text-lg font-medium leading-relaxed">${item.cards[0].b}</h3></div></div></div></div>`;
        else if(item.type === 'image') html = `<div class="flex flex-col items-center justify-center h-full p-4 animate-fade-in"><img src="${item.imgSrc}" class="max-h-[60vh] rounded-2xl shadow-lg bg-white p-2 border border-earth-200" alt="${item.title}"><p class="mt-6 text-lg font-serif text-earth-700 italic text-center bg-white/50 p-4 rounded-xl max-w-xl">${item.desc}</p></div>`;
        else if(item.type === 'input') html = `<div class="max-w-2xl mx-auto h-full flex flex-col p-4 animate-fade-in"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl bg-earth-100" style="color:${cat.hex}"><i class="fas ${item.icon}"></i></div><div><h3 class="font-bold text-earth-900 text-lg">${item.title}</h3><p class="text-sm text-earth-500">${item.prompt || item.desc}</p></div></div><textarea id="inp-area" class="flex-1 w-full p-6 bg-white rounded-2xl border-2 border-earth-200 focus:border-earth-400 focus:outline-none resize-none shadow-inner font-serif text-lg leading-relaxed text-earth-700" placeholder="Tulis pemikiranmu...">${localStorage.getItem(`inp_${currentCatId}_${currentMediaIndex}_${currentSubContentIndex}`)||''}</textarea><div class="mt-4 flex justify-between"><span id="saved-msg" class="text-green-600 opacity-0 transition text-sm font-bold">Tersimpan!</span><button onclick="saveInp('${cat.hex}')" class="px-6 py-2 bg-earth-700 text-white rounded-lg hover:opacity-90 transition font-bold shadow-md" style="background-color:${cat.hex}">Simpan</button></div></div>`;
        else if(item.type === 'task') html = `<div class="flex flex-col items-center justify-center h-full text-center p-4 animate-fade-in"><div class="w-20 h-20 rounded-full bg-earth-100 flex items-center justify-center mb-6 text-3xl text-earth-600 animate-bounce-slow"><i class="fas fa-tasks"></i></div><h3 class="text-xl font-bold text-earth-800 mb-4">Aktivitas Fisik</h3><div class="text-xl font-serif text-earth-800 max-w-lg leading-relaxed bg-white p-8 rounded-2xl border-2 border-dashed border-earth-300 shadow-sm rotate-1 hover:rotate-0 transition duration-300">"${item.content}"</div><button onclick="this.innerHTML='<i class=\'fas fa-check\'></i> Bagus!'; this.className='mt-8 px-8 py-3 bg-accent-green text-white rounded-full font-bold shadow-lg'; addXP(20);" class="mt-8 px-8 py-3 border-2 border-earth-300 rounded-full font-bold text-earth-600 hover:bg-earth-800 hover:text-white transition-all">Selesai</button></div>`;

        container.innerHTML = html;
        // --- UPDATE BAGIAN INIT DI renderModalContent ---
        setTimeout(() => {
            if(item.appType === 'graph') drawGraph(cat.hex);
            if(item.appType === 'balance') initBalance(cat.hex); // <--- INI BARU
            if(item.appType === 'tiles') initTiles();
            if(item.appType === 'draw') initDraw(cat.hex);
            if(item.appType === 'wave') initWave(cat.hex);
            if(item.appType === 'graph_sound') initGs();
            if(item.appType === 'piano' || item.appType === 'piano_fib') initAudio();
            if(item.appType === 'looper') stopLooper();
            if(item.appType === 'memory') initMemory();
            if(item.appType === 'reflex') stopReflex();
            if(item.appType === 'simon') stopSimon();
        }, 100);
    }

    function renderApp(type, cat, item) {
        const hex = cat.hex;
        
        if(type === 'story') return `
            <div class="max-w-xl mx-auto bg-white p-6 rounded-3xl shadow-sm border border-earth-100 animate-fade-in">
                <div class="space-y-4">
                    <p class="text-sm text-earth-500 italic flex items-center gap-2"><i class="fas fa-info-circle"></i> Contoh Model: ${item.ex}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-earth-400 uppercase">Nama Subjek</label><input id="s-n" placeholder="Mis: Budi" class="w-full p-3 bg-earth-50 rounded-lg border border-earth-200 outline-none focus:border-[${hex}] transition"></div>
                        <div><label class="text-xs font-bold text-earth-400 uppercase">Objek 1 (${item.obj1})</label><input id="s-o1" value="${item.obj1}" class="w-full p-3 bg-earth-50 rounded-lg border border-earth-200"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-earth-400 uppercase">Koefisien/Nilai</label><input type="number" id="s-v" placeholder="Angka (Mis: 5)" class="w-full p-3 bg-earth-50 rounded-lg border border-earth-200"></div>
                        <div><label class="text-xs font-bold text-earth-400 uppercase">Objek 2 (${item.obj2})</label><input id="s-o2" value="${item.obj2}" class="w-full p-3 bg-earth-50 rounded-lg border border-earth-200"></div>
                    </div>
                    <button onclick="genStory('${hex}')" class="w-full py-3 rounded-xl text-white font-bold shadow-md hover:opacity-90 mt-2 transition transform active:scale-95" style="background-color:${hex}"><i class="fas fa-magic mr-2"></i> Buat Soal Cerita</button>
                    <div id="s-res" class="mt-4 p-4 bg-earth-50 rounded-xl hidden border-l-4 text-earth-800 font-serif" style="border-color:${hex}"></div>
                </div>
            </div>`;

        // GANTI BAGIAN 'if(type === "pattern")' DENGAN INI:
        if(type === 'pattern') {
            // Ambil data dari item saat ini, atau gunakan default jika kosong
            const seq = item.seq || ["2", "4", "8"];
            const ans = item.ans || "16";
            const hint = item.hint || "Pola: Geometri (Dikali 2)";
            const opts = item.opts || ["10", "16", "12"];
            
            return `
            <div class="text-center py-8 animate-fade-in">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-earth-200 inline-block mb-8">
                    <div class="flex justify-center items-center gap-2 text-xl md:text-2xl font-mono font-bold text-earth-800 flex-wrap">
                        ${seq.map(n => `
                            <span class="w-12 h-12 flex items-center justify-center bg-earth-100 rounded-lg shadow-inner">${n}</span>
                            <i class="fas fa-arrow-right text-earth-400 text-sm"></i>
                        `).join('')}
                        <span id="p-slot" class="w-12 h-12 flex items-center justify-center bg-earth-200 text-earth-500 rounded-lg animate-pulse border-2 border-dashed border-earth-400">?</span>
                    </div>
                    <p class="text-xs text-earth-500 mt-4 font-medium bg-earth-50 inline-block px-3 py-1 rounded-full border border-earth-100"><i class="fas fa-lightbulb text-accent-yellow"></i> ${hint}</p>
                </div>
                <div class="flex justify-center gap-3 flex-wrap">
                    ${opts.map(opt => `
                        <button onclick="checkPat(this, '${opt}', '${ans}')" 
                            class="min-w-[4rem] px-4 py-3 rounded-xl bg-white border-b-4 border-earth-200 font-bold text-lg text-earth-700 hover:-translate-y-1 shadow-sm transition active:border-b-0 active:translate-y-1">
                            ${opt}
                        </button>
                    `).join('')}
                </div>
                <p id="p-msg" class="mt-6 font-bold text-lg h-8 transition-all"></p>
            </div>`;
        }
        if(type === 'chat') return `
            <div class="max-w-md mx-auto h-full flex flex-col bg-white rounded-2xl shadow-lg border border-earth-200 overflow-hidden animate-fade-in">
                <div class="p-4 bg-earth-100 border-b border-earth-200 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-earth-600"><i class="fas fa-store"></i></div>
                    <div><h4 class="font-bold text-earth-900 text-sm">Pasar Aljabar</h4><p class="text-[10px] text-earth-500">Online</p></div>
                </div>
                <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-4 bg-[#FDFCF5]">
                    ${item.chatData.map(c => `<div class="flex flex-col ${c.sender === 'You' ? 'items-end' : 'items-start'}"><div class="${c.sender === 'You' ? `bg-[${hex}] text-white` : 'bg-white text-earth-800 border border-earth-200'} px-4 py-2 rounded-2xl ${c.sender === 'You' ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm max-w-[85%] text-sm" style="${c.sender === 'You' ? `background-color:${hex}` : ''}">${c.msg}</div><span class="text-[10px] text-earth-400 mt-1 px-1">${c.sender}</span></div>`).join('')}
                </div>
                <div class="p-3 bg-white border-t border-earth-200 flex gap-2">
                    <input type="text" id="chat-inp" placeholder="Tulis model matematikanya..." class="flex-1 bg-earth-50 rounded-full px-4 py-2 text-sm focus:outline-none border border-transparent focus:border-[${hex}] transition">
                    <button onclick="replyChat('${hex}')" class="w-10 h-10 rounded-full text-white flex items-center justify-center shadow-md hover:scale-105 transition" style="background-color:${hex}"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>`;

        if(type === 'rhythm') return `
            <div class="flex flex-col items-center justify-center h-full gap-8 animate-fade-in text-center">
                <div class="bg-earth-800 text-white p-4 rounded-xl shadow-lg mb-4">
                    <p class="font-mono text-2xl tracking-widest" id="beat-display">1 - 2 - 4 - 8</p>
                    <p class="text-xs text-earth-300 mt-1">Barisan Geometri (Rasio 2)</p>
                </div>
                <div class="flex gap-4 items-end justify-center">
                    <button onclick="playBeat(1, this)" class="beat-btn w-16 h-16 rounded-full bg-earth-200 border-4 border-earth-300 flex items-center justify-center text-xl font-bold text-earth-600 hover:bg-white transition active:scale-95">1</button>
                    <button onclick="playBeat(2, this)" class="beat-btn w-20 h-20 rounded-full bg-earth-300 border-4 border-earth-400 flex items-center justify-center text-2xl font-bold text-earth-700 hover:bg-white transition active:scale-95">2</button>
                    <button onclick="playBeat(4, this)" class="beat-btn w-24 h-24 rounded-full bg-earth-400 border-4 border-earth-500 flex items-center justify-center text-3xl font-bold text-earth-800 hover:bg-white transition active:scale-95">4</button>
                    <button onclick="playBeat(8, this)" class="beat-btn w-28 h-28 rounded-full border-4 border-earth-600 flex items-center justify-center text-4xl font-bold text-white shadow-xl hover:scale-105 transition active:scale-95" style="background-color:${hex}">8</button>
                </div>
                <p class="text-sm text-earth-500 bg-earth-100 px-4 py-2 rounded-full">Ketuk tombol untuk mendengar pola pertambahan nilai</p>
            </div>`;

        if(type === 'mood') return `
            <div class="max-w-lg mx-auto h-full flex flex-col justify-center animate-fade-in text-center">
                <h4 class="text-xl font-serif text-earth-800 mb-8">Bagaimana perasaanmu melihat soal Aljabar hari ini?</h4>
                <div class="flex justify-center gap-4 mb-8">
                    <button onclick="setMood('cemas', '${hex}')" class="mood-btn group flex flex-col items-center transition hover:-translate-y-2"><div class="text-5xl mb-2 grayscale group-hover:grayscale-0 transition duration-300">üò∞</div><span class="text-xs font-bold text-earth-400 group-hover:text-earth-800">Cemas</span></button>
                    <button onclick="setMood('bingung', '${hex}')" class="mood-btn group flex flex-col items-center transition hover:-translate-y-2"><div class="text-5xl mb-2 grayscale group-hover:grayscale-0 transition duration-300">ü§î</div><span class="text-xs font-bold text-earth-400 group-hover:text-earth-800">Bingung</span></button>
                    <button onclick="setMood('paham', '${hex}')" class="mood-btn group flex flex-col items-center transition hover:-translate-y-2"><div class="text-5xl mb-2 grayscale group-hover:grayscale-0 transition duration-300">ü§©</div><span class="text-xs font-bold text-earth-400 group-hover:text-earth-800">Paham</span></button>
                </div>
                <div id="mood-response" class="hidden p-6 bg-white rounded-2xl border-2 border-dashed text-earth-700 shadow-sm" style="border-color:${hex}"></div>
            </div>`;

        if(type === 'calculator' && item.calcType === 'bill') return `
            <div class="max-w-sm mx-auto bg-white p-6 rounded-3xl shadow-lg border border-earth-100 animate-fade-in">
                <div class="text-center mb-6"><div class="w-12 h-12 bg-earth-100 rounded-full flex items-center justify-center mx-auto mb-2 text-earth-600"><i class="fas fa-receipt"></i></div><h4 class="font-bold text-earth-800">Patungan Aljabar</h4><p class="text-xs text-earth-500 font-mono">Rumus: y = (Total + Pajak) / n</p></div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b border-earth-100 pb-2"><label class="text-sm text-earth-600">Total Harga (Rp)</label><input type="number" id="bill-tot" value="100000" class="text-right font-bold text-earth-800 outline-none w-24"></div>
                    <div class="flex justify-between items-center border-b border-earth-100 pb-2"><label class="text-sm text-earth-600">Pajak (%)</label><input type="number" id="bill-tax" value="10" class="text-right font-bold text-earth-800 outline-none w-16"></div>
                    <div class="flex justify-between items-center border-b border-earth-100 pb-2"><label class="text-sm text-earth-600">Jml Orang (n)</label><input type="number" id="bill-ppl" value="4" class="text-right font-bold text-earth-800 outline-none w-16"></div>
                    <div class="bg-earth-50 p-4 rounded-xl mt-4 text-center"><p class="text-xs text-earth-400 uppercase tracking-widest mb-1">Per Orang Bayar</p><h2 class="text-3xl font-bold" id="bill-res" style="color:${hex}">Rp 27.500</h2></div>
                    <button onclick="calcBill()" class="w-full py-2 bg-earth-800 text-white rounded-lg text-sm font-bold hover:bg-earth-900 transition">Hitung Ulang</button>
                </div>
            </div>`;

        if(type === 'wave') return `
            <div class="flex flex-col h-full animate-fade-in">
                <div class="bg-earth-900 rounded-2xl p-4 shadow-inner relative overflow-hidden flex-1 mb-4">
                    <canvas id="cv-wave" class="w-full h-full block"></canvas>
                    <div class="absolute top-4 left-4 text-xs font-mono text-green-400 opacity-70">f(x) = A sin(kx)</div>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-earth-200">
                    <div class="mb-4"><label class="flex justify-between text-xs font-bold text-earth-500 uppercase mb-2"><span>Amplitudo (A)</span> <span id="val-amp">50</span></label><input type="range" min="10" max="100" value="50" id="sl-amp" class="w-full accent-[${hex}]" oninput="updateWave('${hex}')"></div>
                    <div><label class="flex justify-between text-xs font-bold text-earth-500 uppercase mb-2"><span>Frekuensi (k)</span> <span id="val-freq">5</span></label><input type="range" min="1" max="20" value="5" id="sl-freq" class="w-full accent-[${hex}]" oninput="updateWave('${hex}')"></div>
                </div>
            </div>`;

        if(type === 'dragdrop') return `
            <div class="h-full flex flex-col animate-fade-in relative">
                <p class="text-center text-earth-600 mb-4 text-sm font-medium">Kelompokkan elemen aljabar ke keranjang yang benar!</p>
                <div class="flex justify-center gap-3 mb-8 flex-wrap">
                    ${['3x', '5', '-2y', '10', 'x', '-7'].map(val => `<div draggable="true" ondragstart="ddStart(event)" id="drag-${val}" class="px-4 py-2 bg-white border-2 rounded-lg shadow-sm cursor-grab hover:scale-105 transition font-bold text-earth-700 select-none z-10" style="border-color:${hex}">${val}</div>`).join('')}
                </div>
                <div class="grid grid-cols-2 gap-4 flex-1">
                    <div ondrop="ddDrop(event, 'var')" ondragover="allowDrop(event)" class="bg-earth-50 border-2 border-dashed border-earth-300 rounded-2xl flex flex-col items-center justify-start p-4 transition hover:bg-white hover:border-[${hex}]"><i class="fas fa-cube text-2xl text-earth-300 mb-2"></i><span class="text-xs font-bold uppercase text-earth-500 mb-4">Variabel (Huruf)</span><div class="w-full flex flex-wrap gap-2 justify-center min-h-[50px]"></div></div>
                    <div ondrop="ddDrop(event, 'const')" ondragover="allowDrop(event)" class="bg-earth-50 border-2 border-dashed border-earth-300 rounded-2xl flex flex-col items-center justify-start p-4 transition hover:bg-white hover:border-[${hex}]"><i class="fas fa-hashtag text-2xl text-earth-300 mb-2"></i><span class="text-xs font-bold uppercase text-earth-500 mb-4">Konstanta (Angka)</span><div class="w-full flex flex-wrap gap-2 justify-center min-h-[50px]"></div></div>
                </div>
            </div>`;

        if(type === 'sort') return `
            <div class="max-w-md mx-auto animate-fade-in">
                <p class="text-center text-earth-500 mb-4 text-sm">Urutkan langkah yang benar</p>
                <div class="space-y-2">${item.items.map((txt,i)=>`<div class="p-3 bg-white border border-earth-200 rounded-lg shadow-sm flex justify-between items-center group hover:border-[${hex}] transition"><span class="font-bold text-earth-700 text-sm">${i+1}. ${txt}</span><i class="fas fa-bars text-earth-300 group-hover:text-[${hex}]"></i></div>`).join('')}</div>
                <button class="w-full mt-6 py-3 text-white font-bold rounded-lg shadow-md hover:opacity-90 transition active:scale-95" style="background-color:${hex}" onclick="this.innerText='Benar! (+10 XP)'; this.style.backgroundColor='#606C38'; addXP(10); confetti({particleCount:30, spread:50});">Cek Jawaban</button>
            </div>`;

        // --- GANTI BAGIAN GRAPH/BALANCE LAMA DENGAN INI ---
        
        if(type === 'graph') return `
            <div class="grid md:grid-cols-3 gap-6 h-full animate-fade-in">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-earth-100 flex flex-col justify-center order-2 md:order-1 space-y-6">
                    <div><label class="flex justify-between text-xs font-bold text-earth-400 uppercase mb-2"><span>Gradien (m)</span> <span class="text-earth-800 font-mono bg-earth-100 px-2 rounded" id="val-m">1</span></label><input type="range" min="-5" max="5" step="0.5" value="1" id="sl-m" class="w-full accent-[${hex}]" oninput="drawGraph('${hex}')"></div>
                    <div><label class="flex justify-between text-xs font-bold text-earth-400 uppercase mb-2"><span>Konstanta (c)</span> <span class="text-earth-800 font-mono bg-earth-100 px-2 rounded" id="val-c">0</span></label><input type="range" min="-5" max="5" value="0" id="sl-c" class="w-full accent-[${hex}]" oninput="drawGraph('${hex}')"></div>
                    <p class="text-[10px] text-earth-400 italic text-center">Geser slider untuk melihat perubahan garis y = mx + c</p>
                </div>
                <div class="md:col-span-2 bg-white rounded-2xl shadow-inner border border-earth-200 relative p-2 order-1 md:order-2 overflow-hidden"><canvas id="cv-graph" width="600" height="350" class="w-full h-full object-contain"></canvas></div>
            </div>`;

        if(type === 'balance') return `
            <div class="flex flex-col h-full animate-fade-in max-w-4xl mx-auto">
                <div class="relative flex-1 bg-gradient-to-b from-blue-50 to-white rounded-3xl border border-earth-200 overflow-hidden mb-6 shadow-inner min-h-[300px]">
                    <canvas id="cv-balance" class="w-full h-full block"></canvas>
                    
                    <div id="bal-msg" class="absolute top-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-6 py-2 rounded-full shadow-lg text-earth-800 font-bold text-sm hidden border border-green-200 transform scale-0 transition-transform duration-300 flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i> <span>Seimbang!</span>
                    </div>

                    <button onclick="initBalance('${hex}')" class="absolute top-4 right-4 w-10 h-10 bg-white rounded-full hover:bg-red-50 hover:text-red-500 text-earth-400 shadow-md transition flex items-center justify-center border border-earth-100" title="Reset Timbangan">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    
                    <div id="x-reveal" class="absolute bottom-4 left-4 text-xs font-mono text-earth-400 opacity-0 transition">Nilai x = ?</div>
                </div>

                <div class="grid grid-cols-2 gap-4 md:gap-8">
                    <div class="bg-white p-5 rounded-3xl border-2 border-blue-100 shadow-sm relative group">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Sisi Kiri</div>
                        <div class="flex justify-center gap-3 mb-3 mt-2">
                            <button onclick="updateBal('L', 'x', 1)" class="w-12 h-12 rounded-xl bg-blue-500 text-white font-bold shadow-blue-200 shadow-lg hover:-translate-y-1 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">+</span>x</button>
                            <button onclick="updateBal('L', '1', 1)" class="w-12 h-12 rounded-xl bg-yellow-400 text-yellow-900 font-bold shadow-yellow-200 shadow-lg hover:-translate-y-1 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">+</span>1</button>
                        </div>
                        <div class="flex justify-center gap-3">
                            <button onclick="updateBal('L', 'x', -1)" class="w-12 h-12 rounded-xl border-2 border-red-100 text-red-400 font-bold hover:bg-red-50 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">-</span>x</button>
                            <button onclick="updateBal('L', '1', -1)" class="w-12 h-12 rounded-xl border-2 border-red-100 text-red-400 font-bold hover:bg-red-50 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">-</span>1</button>
                        </div>
                        <div id="txt-L" class="mt-3 text-center font-mono font-bold text-blue-600 text-lg">0</div>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border-2 border-green-100 shadow-sm relative group">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-green-100 text-green-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Sisi Kanan</div>
                        <div class="flex justify-center gap-3 mb-3 mt-2">
                            <button onclick="updateBal('R', 'x', 1)" class="w-12 h-12 rounded-xl bg-blue-500 text-white font-bold shadow-blue-200 shadow-lg hover:-translate-y-1 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">+</span>x</button>
                            <button onclick="updateBal('R', '1', 1)" class="w-12 h-12 rounded-xl bg-yellow-400 text-yellow-900 font-bold shadow-yellow-200 shadow-lg hover:-translate-y-1 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">+</span>1</button>
                        </div>
                        <div class="flex justify-center gap-3">
                            <button onclick="updateBal('R', 'x', -1)" class="w-12 h-12 rounded-xl border-2 border-red-100 text-red-400 font-bold hover:bg-red-50 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">-</span>x</button>
                            <button onclick="updateBal('R', '1', -1)" class="w-12 h-12 rounded-xl border-2 border-red-100 text-red-400 font-bold hover:bg-red-50 transition active:scale-95 flex flex-col items-center justify-center leading-none"><span class="text-xs opacity-70">-</span>1</button>
                        </div>
                        <div id="txt-R" class="mt-3 text-center font-mono font-bold text-green-600 text-lg">0</div>
                    </div>
                </div>
            </div>`;
        if(type === 'draw') return `
            <div class="h-full flex flex-col animate-fade-in">
                <div class="flex-1 bg-white rounded-2xl shadow-inner border border-earth-200 relative overflow-hidden touch-none cursor-crosshair">
                    <canvas id="cv-draw" class="w-full h-full"></canvas>
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/95 p-1.5 rounded-full shadow-lg border border-earth-100 flex gap-3 backdrop-blur-sm">
                        <button onclick="clsDraw()" class="w-9 h-9 rounded-full bg-red-50 text-red-500 hover:bg-red-100 transition flex items-center justify-center tooltip" title="Hapus"><i class="fas fa-trash"></i></button>
                        <div class="w-px h-6 bg-earth-200 my-auto"></div><div class="flex items-center gap-1 px-2 text-xs font-bold text-earth-400 uppercase">Mode Gambar</div>
                    </div>
                </div>
                <p class="text-center text-xs text-earth-400 mt-2">Gunakan jari atau mouse untuk menggambar</p>
            </div>`;
        if(item.appType === 'piano' || item.appType === 'piano_fib') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-900 rounded-3xl p-6 relative shadow-2xl">
                <div class="mb-6 text-center text-white">
                    <h3 class="text-2xl font-bold font-serif mb-1">${item.title}</h3>
                    <p class="text-white/60 text-sm font-mono">${item.desc}</p>
                </div>
                <div class="flex gap-1 bg-black p-2 rounded-xl shadow-lg overflow-x-auto max-w-full">
                    ${Array.from({length:12}).map((_,i) => `
                        <button onmousedown="playNote(${i}, '${item.appType}')" class="piano-key w-10 h-32 bg-white rounded-b-lg active:bg-accent-yellow active:scale-95 transition relative group">
                            <span class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs font-bold text-gray-400 group-hover:text-black">${i}</span>
                        </button>
                    `).join('')}
                </div>
                <p class="mt-6 text-accent-yellow text-sm"><i class="fas fa-info-circle"></i> Klik tuts untuk mendengar bunyi fungsi!</p>
            </div>`;
        if(item.appType === 'sequencer') return `
            <div class="h-full flex flex-col animate-fade-in bg-earth-800 rounded-3xl p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6 text-white">
                    <h3 class="font-bold text-xl"><i class="fas fa-drum mr-2"></i>Beat Maker</h3>
                    <button onclick="toggleSeq()" id="btn-seq" class="w-10 h-10 rounded-full bg-accent-green flex items-center justify-center shadow hover:scale-110 transition"><i class="fas fa-play"></i></button>
                </div>
                <div class="grid grid-cols-8 gap-2 mb-4">
                    ${Array.from({length:16}).map((_,i) => `
                        <div onclick="toggleStep(this)" class="seq-step w-full aspect-square bg-earth-700 rounded-lg cursor-pointer border border-earth-600 hover:border-white transition relative" data-active="false">
                            <div class="absolute inset-2 bg-accent-yellow rounded-full opacity-0 transition transform scale-0 indicator"></div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-auto bg-earth-900/50 p-4 rounded-xl text-white/70 text-sm font-mono">
                    <p>Baris 1: Hi-Hat (x)</p>
                    <p>Baris 2: Kick (y)</p>
                </div>
            </div>`;
        if(item.appType === 'lyrics') return `
            <div class="h-full flex flex-col animate-fade-in max-w-xl mx-auto">
                <div class="bg-white p-6 rounded-3xl shadow-lg border border-earth-100 flex-1">
                    <h3 class="font-bold text-earth-800 mb-4 text-center">üé§ Sambung Lirik</h3>
                    <div class="space-y-3 font-mono text-sm md:text-base">
                        ${(item.contentList ? item.contentList[0].lyrics : ["Baris 1...", "Baris 2..."]).map((l,i) => 
                            l.includes('______') ? 
                            `<div class="p-3 bg-accent-yellow/10 rounded-lg border border-accent-yellow/30 flex items-center gap-2">
                                <span class="text-earth-400 select-none">${i+1}.</span>
                                <input type="text" placeholder="Isi rima..." class="bg-transparent w-full outline-none font-bold text-earth-800 placeholder-earth-400/50">
                                <span class="text-[10px] text-earth-500 bg-white px-2 py-1 rounded shadow-sm">${l.match(/\((.*?)\)/)?.[1] || '?'}</span>
                             </div>` : 
                            `<div class="p-3 text-earth-600 border-l-2 border-earth-200 pl-4">${l}</div>`
                        ).join('')}
                    </div>
                </div>
                <button onclick="alert('Yo! Rima yang mantap! +10 XP'); addXP(10);" class="mt-4 w-full py-3 bg-earth-800 text-white rounded-xl font-bold shadow-lg">Cek Rima</button>
            </div>`;
        if(item.appType === 'conductor' || item.appType === 'metronome') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-gradient-to-br from-earth-100 to-white rounded-3xl p-6 text-center" onmousemove="${item.appType==='conductor'?'updateConductor(event)':''}">
                <div class="w-40 h-40 rounded-full border-8 border-earth-200 flex items-center justify-center text-4xl text-earth-600 shadow-inner bg-white mb-6 relative">
                    <i class="fas ${item.icon}"></i>
                    ${item.appType==='metronome' ? '<div id="metro-needle" class="absolute bottom-1/2 left-1/2 w-1 h-16 bg-red-500 origin-bottom transition-transform duration-75" style="transform:translateX(-50%)"></div>' : ''}
                </div>
                <h3 class="text-2xl font-bold text-earth-800 mb-2">${item.title}</h3>
                
                ${item.appType==='metronome' ? 
                `<input type="range" min="40" max="200" value="60" class="w-64 accent-earth-700 my-4" oninput="updateMetro(this.value)">
                 <p class="font-mono text-xl font-bold text-earth-600">BPM (x) = <span id="metro-val">60</span></p>` : 
                `<p class="text-sm text-earth-500">Geser mouse ke ATAS untuk nada TINGGI.<br>Geser ke BAWAH untuk nada RENDAH.</p>
                 <button onmousedown="startCond()" onmouseup="stopCond()" class="mt-6 px-8 py-3 bg-accent-green text-white rounded-full font-bold shadow-lg hover:scale-105 transition">TAHAN UNTUK MAIN</button>`}
            </div>`;
        if(item.appType === 'graph_sound') return `
            <div class="h-full flex flex-col animate-fade-in">
                <div class="flex-1 bg-white rounded-2xl border-2 border-earth-200 relative cursor-crosshair shadow-inner" id="gs-canvas-box">
                    <canvas id="cv-gs" class="w-full h-full block"></canvas>
                    <div class="absolute top-4 left-4 bg-white/80 p-2 rounded text-xs font-bold text-earth-500 pointer-events-none">Sumbu Y = Pitch (Nada)</div>
                </div>
                <div class="flex gap-4 mt-4 justify-center">
                    <button onclick="clearGs()" class="px-4 py-2 bg-red-100 text-red-500 rounded-lg font-bold"><i class="fas fa-trash"></i> Hapus</button>
                    <button onclick="playGs()" class="px-6 py-2 bg-earth-700 text-white rounded-lg font-bold shadow-lg hover:bg-earth-800"><i class="fas fa-play"></i> MAINKAN GRAFIK</button>
                </div>
            </div>`;
        if(['jumper', 'maze', 'runner', 'racer', 'cannon'].includes(item.appType)) return `
            <div class="h-full flex flex-col animate-fade-in">
                <div class="relative flex-1 bg-earth-800 rounded-3xl overflow-hidden border-4 border-earth-600 shadow-xl group cursor-pointer select-none" onclick="startGame('${item.appType}')">
                    <canvas id="cv-game-${item.appType}" class="w-full h-full block"></canvas>
                    
                    <div id="overlay-${item.appType}" class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 text-white backdrop-blur-sm z-10 transition-opacity">
                        <i class="fas fa-play-circle text-6xl mb-4 text-accent-yellow animate-pulse"></i>
                        <h3 class="text-2xl font-bold">Klik untuk Main</h3>
                        <p class="text-sm opacity-80 mt-2 text-center max-w-xs">${item.desc}</p>
                    </div>
                    
                    <div class="absolute bottom-4 right-4 bg-white/20 px-3 py-1 rounded text-xs text-white font-mono pointer-events-none">Status: <span id="status-${item.appType}">Ready</span></div>
                </div>

                <div class="mt-4 px-4">
                    ${item.appType === 'jumper' ? '<div class="flex justify-center gap-4"><button onmousedown="gameInput(\'left\')" class="p-4 bg-earth-200 rounded-full shadow-lg active:scale-90"><i class="fas fa-arrow-left"></i></button><button onmousedown="gameInput(\'right\')" class="p-4 bg-earth-200 rounded-full shadow-lg active:scale-90"><i class="fas fa-arrow-right"></i></button></div>' : ''}
                    
                    ${item.appType === 'maze' ? '<div class="grid grid-cols-3 gap-2 w-32 mx-auto"><div class="col-start-2"><button onmousedown="gameInput(\'up\')" class="w-full py-2 bg-earth-200 rounded shadow active:scale-90"><i class="fas fa-arrow-up"></i></button></div><div class="col-start-1 row-start-2"><button onmousedown="gameInput(\'left\')" class="w-full py-2 bg-earth-200 rounded shadow active:scale-90"><i class="fas fa-arrow-left"></i></button></div><div class="col-start-3 row-start-2"><button onmousedown="gameInput(\'right\')" class="w-full py-2 bg-earth-200 rounded shadow active:scale-90"><i class="fas fa-arrow-right"></i></button></div><div class="col-start-2 row-start-3"><button onmousedown="gameInput(\'down\')" class="w-full py-2 bg-earth-200 rounded shadow active:scale-90"><i class="fas fa-arrow-down"></i></button></div></div>' : ''}
                    
                    ${item.appType === 'racer' ? '<div class="px-4"><label class="text-xs font-bold text-earth-500 uppercase block mb-1">Miringkan Sepeda</label><input type="range" min="-45" max="45" value="0" class="w-full h-4 bg-earth-200 rounded-lg appearance-none cursor-pointer accent-earth-700" oninput="gameInput(this.value)"></div>' : ''}

                    ${item.appType === 'runner' ? '<div class="px-4"><label class="text-xs font-bold text-earth-500 uppercase block mb-1">Kecepatan Lari (v)</label><input type="range" min="0" max="20" value="0" class="w-full h-4 bg-earth-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="gameInput(this.value)"></div>' : ''}

                    ${item.appType === 'cannon' ? '<div class="flex gap-4"><div class="flex-1"><label class="text-xs font-bold text-earth-500 uppercase block mb-1">Tinggi (c)</label><input type="range" min="10" max="90" value="50" class="w-full accent-green-600" oninput="gameInput({t:\'h\', v:this.value})"></div><div class="flex-1"><label class="text-xs font-bold text-earth-500 uppercase block mb-1">Sudut (m)</label><input type="range" min="-45" max="45" value="0" class="w-full accent-red-600" oninput="gameInput({t:\'a\', v:this.value})"></div></div>' : ''}
                </div>
            </div>`;
        if(item.appType === 'tiles') return `
            <div class="h-full flex flex-col animate-fade-in relative">
                <div class="flex-1 bg-white border-2 border-dashed border-earth-300 rounded-2xl mb-4 relative overflow-hidden shadow-inner" id="tile-canvas">
                    <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-earth-200 font-bold text-4xl select-none pointer-events-none">AREA KERJA</p>
                    <p class="absolute bottom-2 left-1/2 -translate-x-1/2 text-earth-300 text-xs select-none">Klik 2x pada balok untuk menghapus</p>
                </div>
                
                <div class="flex gap-4 justify-center bg-earth-100 p-4 rounded-xl overflow-x-auto border border-earth-200 shadow-sm">
                    <div draggable="true" ondragstart="ddStartTile(event, 'x2')" class="w-16 h-16 bg-blue-500 border-2 border-blue-600 cursor-grab flex items-center justify-center text-white font-bold shadow hover:scale-105 transition shrink-0 rounded" title="x¬≤ (Persegi Besar)">x¬≤</div>
                    <div draggable="true" ondragstart="ddStartTile(event, 'x')" class="w-8 h-16 bg-green-500 border-2 border-green-600 cursor-grab flex items-center justify-center text-white font-bold shadow hover:scale-105 transition shrink-0 rounded" title="x (Persegi Panjang)">x</div>
                    <div draggable="true" ondragstart="ddStartTile(event, '1')" class="w-8 h-8 bg-yellow-400 border-2 border-yellow-500 cursor-grab flex items-center justify-center text-yellow-900 font-bold shadow hover:scale-105 transition shrink-0 rounded" title="1 (Satuan)">1</div>
                    
                    <div class="w-px h-auto bg-earth-300 mx-2"></div>
                    
                    <button onclick="document.getElementById('tile-canvas').innerHTML='<p class=\'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-earth-200 font-bold text-4xl select-none pointer-events-none\'>AREA KERJA</p>'" class="px-4 py-2 bg-red-100 text-red-500 rounded-lg hover:bg-red-200 font-bold transition flex flex-col items-center justify-center text-xs gap-1">
                        <i class="fas fa-trash text-lg"></i> Reset
                    </button>
                </div>
            </div>`;
        if(item.appType === 'rhythm_game') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-900 rounded-3xl relative overflow-hidden text-center text-white p-4">
                <div class="mb-8">
                    <h3 class="text-2xl font-bold mb-2">Pola: 1 - 2 - 4 - 8</h3>
                    <div class="flex gap-2 justify-center">
                        <div id="rhy-1" class="w-4 h-4 rounded-full bg-white/20"></div>
                        <div id="rhy-2" class="w-4 h-4 rounded-full bg-white/20"></div>
                        <div id="rhy-3" class="w-4 h-4 rounded-full bg-white/20"></div>
                        <div id="rhy-4" class="w-4 h-4 rounded-full bg-white/20"></div>
                    </div>
                </div>
                <div id="rhy-target" class="w-32 h-32 rounded-full border-4 border-white/30 flex items-center justify-center text-4xl shadow-[0_0_30px_rgba(255,255,255,0.1)] transition-transform duration-100">
                    <i class="fas fa-drum"></i>
                </div>
                <p class="mt-8 text-sm opacity-70">Tekan SPASI atau KLIK lingkaran saat lingkaran menyala!</p>
                <div id="rhy-msg" class="absolute bottom-10 font-bold text-xl h-6 text-accent-yellow"></div>
                <button onclick="startRhythm()" class="absolute inset-0 bg-black/60 z-10 flex items-center justify-center text-2xl font-bold hover:bg-black/50 transition">MULAI</button>
            </div>`;
        if(item.appType === 'fingers') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-50 rounded-3xl p-4">
                <h3 class="text-xl font-bold text-earth-800 mb-8">Representasikan x = <span id="fin-target">3</span></h3>
                <div class="flex gap-4">
                    ${[1,2,3,4,5].map(i => `
                        <div onclick="toggleFinger(this)" class="finger w-12 h-32 bg-earth-200 rounded-t-full border-2 border-earth-300 cursor-pointer hover:bg-earth-300 transition-all transform origin-bottom relative shadow-md" data-up="false">
                            <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs font-bold text-earth-500">${i}</div>
                        </div>
                    `).join('')}
                </div>
                <p class="mt-8 text-earth-600 font-medium">Klik jari untuk melipat/mengangkat</p>
                <button onclick="checkFinger()" class="mt-4 px-6 py-2 bg-earth-700 text-white rounded-lg shadow">Cek Jawaban</button>
            </div>`;
        if(item.appType === 'ruler') return `
            <div class="h-full flex flex-col animate-fade-in relative overflow-hidden bg-white rounded-3xl border border-earth-200 select-none">
                <div class="absolute top-20 left-10 w-32 h-20 bg-blue-100 border-2 border-blue-400 flex items-center justify-center text-blue-500 font-bold">Buku (P=?)</div>
                
                <div id="drag-ruler" class="absolute bottom-10 left-10 w-[400px] h-16 bg-yellow-200 border border-yellow-500 shadow-xl cursor-move flex items-end px-2" onmousedown="dragStart(event, this)">
                    ${Array.from({length:21}).map((_,i)=>`<div class="flex-1 border-r border-black/50 h-full relative group"><span class="absolute -top-4 -right-1 text-xs font-mono">${i}</span><div class="h-1/2 border-r border-black/30 absolute right-1/2 bottom-0"></div></div>`).join('')}
                </div>
                <div class="absolute top-4 right-4 bg-earth-50 p-4 rounded-xl shadow border border-earth-100">
                    <p class="text-xs font-bold text-earth-400 uppercase">Hasil Ukur</p>
                    <input type="number" id="ruler-inp" placeholder="cm" class="w-20 p-1 border-b-2 border-earth-300 outline-none font-mono text-lg">
                    <button onclick="if(document.getElementById('ruler-inp').value=='8'){alert('Benar!');addXP(10);}else{alert('Coba lagi. Geser penggaris ke sisi buku.');}" class="bg-earth-700 text-white px-3 py-1 rounded text-sm ml-2">Cek</button>
                </div>
            </div>`;
        if(item.appType === 'intervals') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-800 rounded-3xl p-6 text-center text-white">
                <i class="fas fa-music text-6xl mb-6 text-accent-yellow animate-bounce-slow"></i>
                <h3 class="text-2xl font-bold mb-2">Matematika Interval</h3>
                <p class="mb-8 opacity-80 max-w-md">Dengar bagaimana rasio pecahan sederhana menciptakan harmoni yang indah.</p>
                <div class="grid grid-cols-2 gap-4 w-full max-w-lg">
                    <button onclick="playInterval(1, 1)" class="p-4 bg-earth-700 rounded-xl hover:bg-earth-600 transition border-2 border-transparent hover:border-accent-yellow">
                        <span class="block text-2xl font-bold">1 : 1</span>
                        <span class="text-xs uppercase tracking-widest">Unison (x)</span>
                    </button>
                    <button onclick="playInterval(2, 1)" class="p-4 bg-earth-700 rounded-xl hover:bg-earth-600 transition border-2 border-transparent hover:border-accent-yellow">
                        <span class="block text-2xl font-bold">2 : 1</span>
                        <span class="text-xs uppercase tracking-widest">Oktaf (2x)</span>
                    </button>
                    <button onclick="playInterval(3, 2)" class="p-4 bg-earth-700 rounded-xl hover:bg-earth-600 transition border-2 border-transparent hover:border-accent-yellow">
                        <span class="block text-2xl font-bold">3 : 2</span>
                        <span class="text-xs uppercase tracking-widest">Perfect 5th (1.5x)</span>
                    </button>
                    <button onclick="playInterval(4, 3)" class="p-4 bg-earth-700 rounded-xl hover:bg-earth-600 transition border-2 border-transparent hover:border-accent-yellow">
                        <span class="block text-2xl font-bold">4 : 3</span>
                        <span class="text-xs uppercase tracking-widest">Perfect 4th (1.33x)</span>
                    </button>
                </div>
            </div>`;
        if(item.appType === 'looper') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-900 rounded-3xl p-6 relative overflow-hidden">
                <div class="flex gap-8 items-center mb-10">
                    <div class="relative w-32 h-32 rounded-full border-4 border-earth-600 flex items-center justify-center">
                        <div id="loop-1" class="absolute inset-0 border-t-4 border-accent-yellow rounded-full w-full h-full" style="transform: rotate(0deg)"></div>
                        <span class="font-bold text-white text-xl">2 Detik</span>
                    </div>
                    <div class="relative w-32 h-32 rounded-full border-4 border-earth-600 flex items-center justify-center">
                        <div id="loop-2" class="absolute inset-0 border-t-4 border-blue-400 rounded-full w-full h-full" style="transform: rotate(0deg)"></div>
                        <span class="font-bold text-white text-xl">3 Detik</span>
                    </div>
                </div>
                <div id="loop-msg" class="text-accent-green font-bold text-2xl h-8 mb-4"></div>
                <p class="text-white/60 text-sm mb-6 text-center">Kapan mereka bertemu di titik awal bersamaan? (KPK)</p>
                <button onclick="toggleLooper()" id="btn-looper" class="px-8 py-3 bg-white text-earth-900 rounded-full font-bold hover:scale-105 transition">MULAI LOOP</button>
            </div>`;
        if(item.appType === 'freq_calc') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-white rounded-3xl p-6 border-2 border-earth-200">
                <div class="w-full max-w-md bg-earth-50 p-6 rounded-2xl border border-earth-200 shadow-sm">
                    <h3 class="font-bold text-earth-800 mb-4 text-center border-b border-earth-200 pb-2">Rumus Fisika Musik</h3>
                    <p class="font-mono text-center text-lg mb-6 bg-white p-3 rounded border border-earth-200">f = 440 √ó 2<sup>(x/12)</sup></p>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <label class="font-bold text-earth-600 w-24">Variabel x:</label>
                        <input type="number" id="hz-x" value="0" class="flex-1 p-2 border border-earth-300 rounded font-bold text-center" oninput="calcHz()">
                        <span class="text-xs text-earth-400">(Semitone)</span>
                    </div>
                    
                    <div class="flex items-center gap-4 mb-6">
                        <label class="font-bold text-earth-600 w-24">Hasil (f):</label>
                        <div class="flex-1 p-2 bg-earth-200 rounded font-bold text-center text-earth-800" id="hz-res">440.00 Hz</div>
                    </div>

                    <button onclick="playHz()" class="w-full py-3 bg-earth-700 text-white rounded-xl font-bold shadow-lg hover:bg-earth-800 transition"><i class="fas fa-volume-up mr-2"></i> DENGAR SUARA</button>
                </div>
            </div>`;
        if(item.appType === 'chord') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-gradient-to-br from-earth-100 to-white rounded-3xl p-6 text-center">
                <h3 class="text-2xl font-bold text-earth-800 mb-8">Apakah nadanya punya solusi?</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                    <button onclick="playChordType('consonant')" class="group relative p-8 bg-white border-2 border-green-100 rounded-2xl hover:border-green-400 hover:shadow-xl transition flex flex-col items-center">
                        <div class="text-5xl mb-4 text-green-500 group-hover:scale-110 transition"><i class="fas fa-check-circle"></i></div>
                        <h4 class="font-bold text-earth-800 text-lg">Solusi Tunggal</h4>
                        <p class="text-sm text-earth-500 mt-2">Garis Berpotongan (Harmonis)</p>
                    </button>
                    <button onclick="playChordType('dissonant')" class="group relative p-8 bg-white border-2 border-red-100 rounded-2xl hover:border-red-400 hover:shadow-xl transition flex flex-col items-center">
                        <div class="text-5xl mb-4 text-red-500 group-hover:scale-110 transition"><i class="fas fa-times-circle"></i></div>
                        <h4 class="font-bold text-earth-800 text-lg">Tanpa Solusi</h4>
                        <p class="text-sm text-earth-500 mt-2">Garis Sejajar (Disonan/Fals)</p>
                    </button>
                </div>
            </div>`;
        if(item.appType === 'mood_sound') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-50 rounded-3xl p-6 border border-earth-200">
                <div class="w-full max-w-lg text-center">
                    <div id="grad-icon" class="text-6xl mb-6 transition-all duration-500">üòê</div>
                    <h3 class="text-2xl font-bold text-earth-800 mb-2">Gradien: <span id="grad-val" class="font-mono">0</span></h3>
                    <p id="grad-desc" class="text-earth-500 mb-8 font-serif italic">"Datar seperti jalanan rata..."</p>
                    
                    <input type="range" min="-5" max="5" value="0" step="1" class="w-full h-4 bg-earth-200 rounded-lg appearance-none cursor-pointer accent-earth-700 mb-8" oninput="checkGradientSound(this.value)">
                    
                    <p class="text-xs text-earth-400 bg-white p-2 rounded-full border border-earth-100 inline-block">Geser slider untuk mengubah emosi musik!</p>
                </div>
            </div>`;
        if(item.appType === 'reflex') return `
            <div class="h-full flex flex-col animate-fade-in relative overflow-hidden bg-earth-900 rounded-3xl border-4 border-earth-600 shadow-2xl">
                <div class="absolute top-0 left-0 w-full z-20 p-4 flex justify-between items-start pointer-events-none">
                    <div class="bg-[#FDFCF5] px-6 py-2 rounded-xl shadow-lg border-b-4 border-earth-300">
                        <span class="text-[10px] font-bold text-earth-400 uppercase tracking-widest block">Soal</span>
                        <h2 id="ref-q" class="text-3xl font-mono font-bold text-earth-800">???</h2>
                    </div>
                    <div class="text-white font-mono text-right">
                        <div class="text-2xl font-bold text-yellow-400">Skor: <span id="ref-score">0</span></div>
                        <div class="text-sm opacity-80">Waktu: <span id="ref-time">30</span>s</div>
                    </div>
                </div>

                <div id="ref-area" class="flex-1 relative w-full h-full cursor-crosshair overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/basketball.png')]">
                    <div id="ref-overlay" class="absolute inset-0 z-50 bg-earth-900/90 flex flex-col items-center justify-center text-white text-center p-6 backdrop-blur-sm">
                        <i class="fas fa-basketball-ball text-6xl mb-6 text-accent-orange animate-bounce"></i>
                        <h3 class="text-3xl font-bold mb-2">Reflex Math</h3>
                        <p class="mb-8 text-earth-200">Klik bola jawaban yang BENAR sebelum jatuh!</p>
                        <button onclick="startReflex()" class="px-10 py-4 bg-accent-orange text-white rounded-full font-bold text-xl shadow-lg hover:scale-105 transition"><i class="fas fa-play mr-2"></i> MULAI</button>
                    </div>
                </div>
                <div class="h-4 bg-earth-600 w-full z-10 border-t border-earth-400"></div>
            </div>`;
        if(item.appType === 'memory') return `
            <div class="h-full flex flex-col items-center animate-fade-in bg-earth-100 rounded-3xl p-4">
                <div class="flex justify-between w-full max-w-lg mb-4 items-center">
                    <h3 class="font-bold text-earth-800"><i class="fas fa-layer-group mr-2"></i>Cari Pasangan</h3>
                    <button onclick="initMemory()" class="px-4 py-2 bg-earth-700 text-white rounded-lg text-sm shadow hover:bg-earth-800"><i class="fas fa-sync-alt"></i> Reset</button>
                </div>
                <div id="mem-grid" class="grid grid-cols-4 gap-3 w-full max-w-lg aspect-square">
                    </div>
                <div id="mem-msg" class="mt-4 font-bold text-earth-600 h-6"></div>
                <script>setTimeout(()=>initMemory(), 500);
            </div>`;
        if(item.appType === 'simon') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-800 rounded-3xl p-4 relative overflow-hidden">
                <div class="mb-8 text-center text-white">
                    <h3 class="text-2xl font-bold mb-1">Senam Simbol</h3>
                    <p class="text-white/60 text-xs">Hafalkan urutan gerakan & ulangi!</p>
                    <div class="mt-2 text-3xl font-mono font-bold text-accent-yellow" id="simon-level">Level 1</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <button id="sim-0" onclick="simonInput(0)" class="simon-btn w-32 h-32 bg-red-500 rounded-2xl border-b-8 border-red-700 active:border-b-0 active:translate-y-2 shadow-xl flex flex-col items-center justify-center text-white transition hover:brightness-110">
                        <i class="fas fa-child text-4xl mb-2"></i><span class="font-bold">x¬≤ (Kepala)</span>
                    </button>
                    <button id="sim-1" onclick="simonInput(1)" class="simon-btn w-32 h-32 bg-blue-500 rounded-2xl border-b-8 border-blue-700 active:border-b-0 active:translate-y-2 shadow-xl flex flex-col items-center justify-center text-white transition hover:brightness-110">
                        <i class="fas fa-walking text-4xl mb-2"></i><span class="font-bold">Konstanta (Kaki)</span>
                    </button>
                    <button id="sim-2" onclick="simonInput(2)" class="simon-btn w-32 h-32 bg-green-500 rounded-2xl border-b-8 border-green-700 active:border-b-0 active:translate-y-2 shadow-xl flex flex-col items-center justify-center text-white transition hover:brightness-110">
                        <i class="fas fa-hand-point-left text-4xl mb-2"></i><span class="font-bold">-x (Kiri)</span>
                    </button>
                    <button id="sim-3" onclick="simonInput(3)" class="simon-btn w-32 h-32 bg-yellow-400 rounded-2xl border-b-8 border-yellow-600 active:border-b-0 active:translate-y-2 shadow-xl flex flex-col items-center justify-center text-white transition hover:brightness-110">
                        <i class="fas fa-hand-point-right text-4xl mb-2"></i><span class="font-bold">+x (Kanan)</span>
                    </button>
                </div>

                <button onclick="startSimon()" id="simon-start" class="absolute inset-0 z-20 bg-black/70 flex flex-col items-center justify-center text-white backdrop-blur-sm">
                    <i class="fas fa-play-circle text-6xl mb-4 text-accent-yellow animate-pulse"></i>
                    <span class="font-bold text-xl">TAP UNTUK MAIN</span>
                </button>
            </div>`;
        if(item.appType === 'magic') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-purple-900 rounded-3xl p-6 text-center text-white relative overflow-hidden">
                <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
                <i class="fas fa-hat-wizard text-6xl mb-6 text-yellow-300 animate-bounce-slow"></i>
                <div id="magic-step" class="z-10 w-full max-w-md">
                    <h3 class="text-2xl font-bold mb-4">Pikirkan satu angka (x)...</h3>
                    <p class="mb-8 opacity-80">Jangan beritahu aku!</p>
                    <button onclick="nextMagic(1)" class="px-8 py-3 bg-yellow-400 text-purple-900 rounded-full font-bold hover:scale-105 transition shadow-lg">Lanjut <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>`;
        if(item.appType === 'budget') return `
            <div class="h-full flex flex-col animate-fade-in bg-white rounded-3xl p-6 border-2 border-earth-200">
                <h3 class="text-xl font-bold text-earth-800 mb-2 text-center">Anggaran Acara Amal</h3>
                <div class="bg-earth-100 p-3 rounded-xl mb-6 flex justify-between items-center">
                    <span class="text-sm font-bold text-earth-600">Target: 10 Juta</span>
                    <span id="bud-total" class="text-xl font-bold text-earth-800">0</span>
                </div>
                
                <div class="space-y-6 flex-1 overflow-y-auto pr-2">
                    <div>
                        <div class="flex justify-between mb-1"><label class="font-bold text-earth-700">Makanan (x)</label><span id="val-b1" class="text-sm">0</span></div>
                        <input type="range" max="10000000" step="500000" value="0" class="w-full accent-orange-500" oninput="updateBudget()">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><label class="font-bold text-earth-700">Dekorasi (y)</label><span id="val-b2" class="text-sm">0</span></div>
                        <input type="range" max="10000000" step="500000" value="0" class="w-full accent-blue-500" oninput="updateBudget()">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><label class="font-bold text-earth-700">Hiburan (z)</label><span id="val-b3" class="text-sm">0</span></div>
                        <input type="range" max="10000000" step="500000" value="0" class="w-full accent-green-500" oninput="updateBudget()">
                    </div>
                </div>
                <div id="bud-msg" class="mt-4 text-center text-sm font-bold h-6 text-red-500"></div>
            </div>`;
        if(item.appType === 'cashier') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-50 rounded-3xl p-6 border border-earth-200">
                <div class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-lg border border-earth-100 text-center relative">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-earth-700 text-white px-3 py-1 rounded-full text-xs font-bold">Pelanggan #1</div>
                    <div class="text-4xl mb-4">üõí</div>
                    <p class="text-earth-600 mb-2 font-mono text-sm">3 Buku (x) + 2 Pena (y)</p>
                    <p class="text-xs text-earth-400 mb-6">x = 5.000, y = 2.000</p>
                    
                    <div class="flex gap-2">
                        <input type="number" id="cash-inp" placeholder="Total?" class="flex-1 p-2 border-2 border-earth-200 rounded-lg text-center font-bold text-lg outline-none focus:border-earth-500">
                        <button onclick="checkCashier()" class="bg-green-500 text-white px-4 rounded-lg font-bold hover:bg-green-600"><i class="fas fa-check"></i></button>
                    </div>
                    <div id="cash-msg" class="mt-4 font-bold h-6"></div>
                </div>
            </div>`;
        if(item.appType === 'journal') return `
            <div class="h-full flex flex-col animate-fade-in bg-earth-50 rounded-3xl p-6 border border-earth-200">
                <h3 class="font-bold text-earth-800 mb-4"><i class="fas fa-book-open mr-2"></i>Log Error Matematika</h3>
                <div class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2" id="journal-list">
                    <div class="text-center text-earth-400 italic text-sm mt-10">Belum ada catatan. Tulis kesalahanmu di bawah.</div>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-earth-200">
                    <input type="text" id="j-topic" placeholder="Topik (mis: PLSV)" class="w-full mb-2 p-2 border-b border-earth-100 outline-none text-sm font-bold">
                    <textarea id="j-desc" placeholder="Apa salahnya? (mis: Lupa ganti tanda min saat pindah ruas)" class="w-full p-2 outline-none text-sm h-16 resize-none"></textarea>
                    <button onclick="addJournal()" class="w-full py-2 bg-earth-700 text-white rounded-lg font-bold hover:bg-earth-800 transition">Simpan Catatan</button>
                </div>
            </div>`;
        if(item.appType === 'goals') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-white rounded-3xl p-6 border-2 border-earth-100">
                <div class="w-full max-w-sm">
                    <h3 class="font-bold text-center text-earth-800 mb-6 text-xl">üéØ Target Nilai</h3>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="text-xs font-bold text-earth-500 uppercase">Nilai Saat Ini (Rata-rata)</label>
                            <input type="number" id="g-curr" value="70" class="w-full p-3 bg-earth-50 rounded-xl font-bold text-earth-800 border border-earth-200">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-earth-500 uppercase">Target Nilai Akhir</label>
                            <input type="number" id="g-target" value="85" class="w-full p-3 bg-earth-50 rounded-xl font-bold text-earth-800 border border-earth-200">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-earth-500 uppercase">Bobot Ujian Nanti (%)</label>
                            <input type="number" id="g-weight" value="40" class="w-full p-3 bg-earth-50 rounded-xl font-bold text-earth-800 border border-earth-200">
                        </div>
                    </div>
                    
                    <div class="bg-earth-800 text-white p-6 rounded-2xl text-center shadow-lg relative overflow-hidden">
                        <p class="text-xs opacity-70 mb-1">Kamu harus dapat nilai:</p>
                        <h2 id="g-res" class="text-4xl font-bold">107.5?!</h2>
                        <p id="g-msg" class="text-xs text-red-300 mt-2">Mustahil! Target terlalu tinggi.</p>
                        <button onclick="calcGoal()" class="absolute bottom-2 right-2 w-8 h-8 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/40"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <script>setTimeout(calcGoal, 500);
            </div>`;
        if(item.appType === 'mood_tracker') return `
            <div class="h-full flex flex-col animate-fade-in bg-earth-50 rounded-3xl p-6">
                <h3 class="font-bold text-center text-earth-800 mb-6">Bagaimana perasaanmu hari ini?</h3>
                <div class="flex justify-center gap-2 mb-8">
                    ${['üò´','üòï','üòê','üôÇ','ü§©'].map((e,i) => `<button onclick="logMood(${i})" class="text-4xl hover:scale-125 transition transform p-2 hover:bg-white rounded-full">${e}</button>`).join('')}
                </div>
                <h4 class="text-xs font-bold text-earth-400 uppercase tracking-widest mb-3">Riwayat Emosi</h4>
                <div class="flex-1 bg-white rounded-xl border border-earth-200 p-4 grid grid-cols-7 content-start gap-2" id="mood-grid">
                    ${Array.from({length:14}).map(()=>`<div class="aspect-square rounded-lg bg-earth-100"></div>`).join('')}
                </div>
            </div>`;
        if(item.appType === 'checklist') return `
            <div class="h-full flex flex-col animate-fade-in bg-white rounded-3xl p-6 border border-earth-200">
                <h3 class="font-bold text-earth-800 mb-4">Self-Check: Aljabar</h3>
                <div class="space-y-3 flex-1 overflow-y-auto">
                    ${item.items.map((txt, i) => `
                        <label class="flex items-center gap-4 p-4 bg-earth-50 rounded-xl cursor-pointer hover:bg-earth-100 transition group">
                            <div class="relative">
                                <input type="checkbox" class="peer sr-only" onchange="if(this.checked) addXP(5)">
                                <div class="w-6 h-6 border-2 border-earth-300 rounded-md peer-checked:bg-green-500 peer-checked:border-green-500 transition"></div>
                                <i class="fas fa-check text-white absolute top-1 left-1 opacity-0 peer-checked:opacity-100 text-sm"></i>
                            </div>
                            <span class="font-medium text-earth-700 group-hover:text-earth-900 select-none">${txt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>`;
        if(item.appType === 'meditation') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-900 rounded-3xl relative overflow-hidden text-white">
                <div id="breath-circle" class="w-48 h-48 rounded-full border-4 border-white/30 flex items-center justify-center relative transition-all duration-[4000ms] ease-in-out">
                    <div class="text-center relative z-10">
                        <div id="breath-txt" class="text-2xl font-bold tracking-widest">SIAP?</div>
                        <div id="breath-sub" class="text-sm opacity-70 mt-1">Ketuk untuk mulai</div>
                    </div>
                    <div class="absolute inset-0 bg-accent-green/20 rounded-full blur-xl animate-pulse"></div>
                </div>
                <button onclick="startBreath()" class="absolute inset-0 z-20 w-full h-full cursor-pointer"></button>
            </div>`;
        if(item.appType === 'detox') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-gray-100 rounded-3xl p-6 relative overflow-hidden">
                <div id="detox-form" class="w-full max-w-md text-center transition-all duration-500">
                    <i class="fas fa-trash-alt text-4xl text-gray-400 mb-4"></i>
                    <h3 class="font-bold text-gray-700 mb-2">Buang Pikiran Negatif</h3>
                    <p class="text-sm text-gray-500 mb-6">Tuliskan apa yang membuatmu takut/malas, lalu hancurkan.</p>
                    <textarea id="detox-inp" class="w-full p-4 rounded-xl border-2 border-gray-300 focus:border-red-400 outline-none mb-4 bg-white" placeholder="Contoh: Aku takut salah hitung..."></textarea>
                    <button onclick="destroyDetox()" class="px-8 py-3 bg-red-500 text-white rounded-full font-bold shadow-lg hover:bg-red-600 hover:scale-105 transition">HANCURKAN! üí•</button>
                </div>
                <div id="detox-boom" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 bg-white z-10">
                    <h1 class="text-6xl font-black text-red-600 rotate-12">POW!!</h1>
                </div>
                <div id="detox-msg" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-0 z-0 text-center">
                    <i class="fas fa-wind text-6xl text-green-500 mb-4"></i>
                    <h3 class="text-2xl font-bold text-green-700">Pikiranmu Lebih Lega.</h3>
                    <button onclick="resetDetox()" class="mt-8 px-6 py-2 border-2 border-green-500 text-green-600 rounded-full font-bold pointer-events-auto hover:bg-green-50">Tulis Lagi</button>
                </div>
            </div>`;
        if(item.appType === 'zen') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-[#F5F5DC] rounded-3xl p-6 relative">
                <div class="absolute inset-4 border border-[#8B4513]/20 rounded-2xl pointer-events-none"></div>
                <h3 class="font-serif text-[#8B4513] text-xl mb-8">Ruang Fokus</h3>
                <div class="text-7xl font-mono font-bold text-[#5E4934] mb-8" id="zen-time">25:00</div>
                <div class="flex gap-4">
                    <button onclick="toggleZen()" id="zen-btn" class="w-16 h-16 rounded-full bg-[#8B4513] text-white text-xl flex items-center justify-center shadow-lg hover:scale-105 transition"><i class="fas fa-play"></i></button>
                    <button onclick="resetZen()" class="w-16 h-16 rounded-full border-2 border-[#8B4513] text-[#8B4513] text-xl flex items-center justify-center hover:bg-[#8B4513]/10 transition"><i class="fas fa-redo"></i></button>
                </div>
                <p class="mt-8 text-xs text-[#8B4513]/60 italic">"Satu soal pada satu waktu."</p>
            </div>`;
        if(item.appType === 'affirmation') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in p-4 bg-gradient-to-br from-pink-50 to-orange-50 rounded-3xl" onclick="newAffirmation()">
                <div class="card-stack relative w-full max-w-sm aspect-[3/4] cursor-pointer group perspective-1000">
                    <div class="absolute inset-0 bg-white rounded-2xl shadow-xl transform rotate-3 opacity-50 scale-95"></div>
                    <div class="absolute inset-0 bg-white rounded-2xl shadow-xl transform -rotate-2 opacity-70 scale-95"></div>
                    <div id="aff-card" class="absolute inset-0 bg-white rounded-2xl shadow-2xl border border-orange-100 p-8 flex flex-col items-center justify-center text-center transition-all duration-500 group-hover:-translate-y-2">
                        <i class="fas fa-quote-left text-4xl text-orange-200 mb-6"></i>
                        <h2 id="aff-txt" class="text-2xl font-serif text-earth-800 leading-relaxed font-bold">"Kesalahan adalah bukti bahwa kamu sedang berusaha."</h2>
                        <div class="mt-8 w-12 h-1 bg-orange-300 rounded-full"></div>
                        <p class="mt-4 text-xs text-earth-400 uppercase tracking-widest">Ketuk untuk ganti</p>
                    </div>
                </div>
            </div>`;
        if(['swot', 'analogy', 'time_calc', 'gratitude', 'letter'].includes(item.appType)) {
            return renderIntraForms(item.appType, item);
        }

        // --- DEFINISI FUNGSI HELPER (Bersarang di dalam renderApp) ---
        function renderIntraForms(t, item) {
            if(t === 'swot') return `
                <div class="h-full flex flex-col animate-fade-in bg-white rounded-3xl p-6 overflow-y-auto">
                    <h3 class="font-bold text-center mb-4">Analisis SWOT Belajarmu</h3>
                    <div class="grid grid-cols-2 gap-4 flex-1 min-h-[300px]">
                        <div class="bg-green-50 p-3 rounded-xl"><div class="font-bold text-green-700 text-xs mb-2">KEKUATAN (Strengths)</div><textarea class="w-full h-24 bg-transparent resize-none text-sm outline-none" placeholder="Mis: Jago hitung cepat..."></textarea></div>
                        <div class="bg-red-50 p-3 rounded-xl"><div class="font-bold text-red-700 text-xs mb-2">KELEMAHAN (Weaknesses)</div><textarea class="w-full h-24 bg-transparent resize-none text-sm outline-none" placeholder="Mis: Malas baca soal..."></textarea></div>
                        <div class="bg-blue-50 p-3 rounded-xl"><div class="font-bold text-blue-700 text-xs mb-2">PELUANG (Opportunities)</div><textarea class="w-full h-24 bg-transparent resize-none text-sm outline-none" placeholder="Mis: Ada teman pintar..."></textarea></div>
                        <div class="bg-orange-50 p-3 rounded-xl"><div class="font-bold text-orange-700 text-xs mb-2">ANCAMAN (Threats)</div><textarea class="w-full h-24 bg-transparent resize-none text-sm outline-none" placeholder="Mis: Banyak main game..."></textarea></div>
                    </div>
                    <button class="w-full py-3 bg-earth-800 text-white rounded-xl mt-4 font-bold shadow" onclick="alert('Analisis Tersimpan! Kenali dirimu.'); addXP(10)">Simpan Analisis</button>
                </div>`;

            if(t === 'analogy') return `
                <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-earth-100 rounded-3xl p-6 text-center">
                    <h3 class="text-xl font-bold mb-6">Tipe Matematika Apakah Kamu?</h3>
                    <div class="grid gap-3 w-full">
                        ${item.contentList.map(c => `
                            <button onclick="alert('Menarik! Kamu tipe: ${c.title}.'); addXP(5);" class="bg-white p-4 rounded-xl shadow-sm hover:bg-accent-yellow hover:text-white transition text-left group">
                                <span class="font-bold block text-lg">${c.title}</span>
                                <span class="text-sm opacity-70 group-hover:opacity-100">${c.desc}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>`;

            if(t === 'gratitude') return `
                <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-gradient-to-t from-yellow-100 to-white rounded-3xl p-6 text-center">
                    <i class="fas fa-sun text-6xl text-yellow-400 mb-6 animate-pulse"></i>
                    <h3 class="font-serif text-2xl font-bold text-earth-800 mb-2">Kotak Syukur</h3>
                    <p class="text-earth-500 mb-6">Apa satu hal kecil yang berhasil kamu pelajari hari ini?</p>
                    <textarea class="w-full max-w-xs p-4 rounded-xl border border-yellow-200 bg-white/50 shadow-inner mb-4 outline-none focus:bg-white transition" placeholder="Hari ini aku paham bedanya x dan y..."></textarea>
                    <button onclick="confetti(); addXP(10); alert('Hebat! Rayakan prosesmu.');" class="px-8 py-2 bg-yellow-400 text-yellow-900 rounded-full font-bold shadow-lg hover:-translate-y-1 transition">Syukuri üôè</button>
                </div>`;
            
            if(t === 'letter') return `
                <div class="h-full flex flex-col animate-fade-in bg-[#f4f1ea] rounded-3xl p-6 relative">
                    <div class="border-2 border-dashed border-earth-300 h-full rounded-2xl p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-earth-200">
                            <span class="font-serif italic text-earth-600">To: Future Me</span>
                            <i class="fas fa-stamp text-red-400 text-3xl opacity-50 transform rotate-12"></i>
                        </div>
                        <textarea class="flex-1 w-full bg-transparent resize-none outline-none font-serif text-earth-800 leading-relaxed" placeholder="Hai aku di masa depan. Aku harap kamu sudah paham Aljabar, terutama bagian..."></textarea>
                        <button onclick="this.innerHTML='<i class=\'fas fa-check\'></i> Terkirim ke Masa Depan'; this.className='mt-4 w-full py-3 bg-green-600 text-white rounded-xl font-bold shadow'; addXP(10);" class="mt-4 w-full py-3 bg-earth-800 text-white rounded-xl font-bold shadow hover:bg-earth-900 transition">Kirim Surat üìÆ</button>
                    </div>
                </div>`;
            if(t === 'time_calc') return `
                <div class="h-full flex flex-col items-center animate-fade-in bg-white rounded-3xl p-6 overflow-y-auto">
                    <h3 class="font-bold text-earth-800 mb-6 text-xl"><i class="fas fa-clock mr-2"></i>Audit Waktu Harian</h3>
                    
                    <div class="flex flex-col md:flex-row gap-8 w-full items-center justify-center flex-1">
                        <div class="relative w-48 h-48 rounded-full border-4 border-earth-100 shadow-inner flex items-center justify-center transition-all duration-500" 
                             style="background: conic-gradient(#606C38 0% 0%, #BC6C25 0% 100%)" id="time-chart">
                            <div class="absolute inset-4 bg-white rounded-full flex flex-col items-center justify-center shadow-sm">
                                <span class="text-xs text-earth-400 font-bold uppercase tracking-wider">Produktif</span>
                                <span id="time-score" class="text-4xl font-bold text-earth-800">0%</span>
                            </div>
                        </div>

                        <div class="w-full max-w-xs space-y-6 bg-earth-50 p-6 rounded-2xl border border-earth-200">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <label class="font-bold text-earth-700 text-sm"><i class="fas fa-book-reader text-earth-600 mr-2"></i>Belajar (Jam)</label>
                                    <span id="val-study" class="font-mono font-bold bg-white border border-earth-200 px-2 rounded text-earth-700 text-sm">0h</span>
                                </div>
                                <input type="range" id="inp-study" min="0" max="12" step="0.5" value="0" class="w-full h-2 bg-earth-200 rounded-lg appearance-none cursor-pointer accent-earth-600" oninput="updateTimeAudit()">
                            </div>

                            <div>
                                <div class="flex justify-between mb-2">
                                    <label class="font-bold text-accent-orange text-sm"><i class="fas fa-gamepad text-accent-orange mr-2"></i>Hiburan (Jam)</label>
                                    <span id="val-play" class="font-mono font-bold bg-white border border-orange-200 px-2 rounded text-orange-700 text-sm">0h</span>
                                </div>
                                <input type="range" id="inp-play" min="0" max="12" step="0.5" value="0" class="w-full h-2 bg-orange-100 rounded-lg appearance-none cursor-pointer accent-accent-orange" oninput="updateTimeAudit()">
                            </div>
                        </div>
                    </div>

                    <div id="time-msg" class="mt-6 p-4 bg-blue-50 rounded-xl text-center text-blue-800 font-bold border border-blue-100 w-full animate-fade-in-up">
                        <i class="fas fa-info-circle mr-2"></i> Geser slider untuk melihat analisismu.
                    </div>
                </div>`;
            if(item.appType === 'plant_grow') return `
            <div class="h-full flex flex-col items-center justify-end animate-fade-in relative overflow-hidden bg-gradient-to-t from-[#8D6E63] to-[#B3E5FC] rounded-3xl border-4 border-[#5D4037]">
                <div class="absolute top-6 right-6 text-6xl animate-spin-slow opacity-90">‚òÄÔ∏è</div>
                <div class="absolute top-10 left-10 text-4xl opacity-80 animate-bounce-slow" style="animation-duration: 3s">‚òÅÔ∏è</div>

                <div id="plant-root" class="relative z-10 transition-all duration-700 ease-out origin-bottom flex flex-col items-center" style="height: 50px; width: 20px; background: #4CAF50;">
                    <div id="plant-flower" class="absolute -top-10 scale-0 transition-transform duration-500 text-5xl">üåª</div>
                    <div class="absolute bottom-10 -left-8 w-8 h-4 bg-green-600 rounded-tl-full rounded-bl-full origin-right transform rotate-[-20deg]"></div>
                    <div class="absolute bottom-20 -right-8 w-8 h-4 bg-green-600 rounded-tr-full rounded-br-full origin-left transform rotate-[20deg]"></div>
                </div>
                
                <div class="w-full h-16 bg-[#5D4037] z-20 flex items-center justify-center relative shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
                    <span class="text-white/50 text-xs italic absolute bottom-2">Tanah Subur (Konstanta)</span>
                </div>

                <div class="absolute top-4 left-4 bg-white/90 backdrop-blur p-4 rounded-xl shadow-lg border border-green-200 w-64">
                    <div class="flex justify-between text-xs font-bold text-green-800 uppercase mb-2">
                        <span>Air (x)</span> <span id="p-x-val">0 L</span>
                    </div>
                    <input type="range" min="0" max="10" value="0" class="w-full accent-green-600 h-2 bg-green-200 rounded-lg appearance-none cursor-pointer" oninput="growPlant(this.value)">
                    <div class="mt-3 pt-3 border-t border-green-100">
                        <p class="text-xs text-earth-600">Model: <b class="text-green-700">y = 2x + 5</b></p>
                        <p class="text-lg font-bold text-earth-800">Tinggi: <span id="p-y-val">5</span> cm</p>
                    </div>
                </div>
            </div>`;
            if(item.appType === 'cricket') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-gradient-to-b from-[#1a237e] to-[#000000] rounded-3xl p-6 relative overflow-hidden text-white">
                <div class="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
                <div class="z-10 text-center">
                    <div class="relative inline-block">
                        <i class="fas fa-bug text-6xl text-green-400 mb-4 animate-bounce" id="cricket-icon" style="animation-duration: 0.5s"></i>
                        <div class="absolute -right-4 -top-2 text-yellow-300 font-bold text-xs bg-black/50 px-2 rounded-full border border-yellow-300">Chirp!</div>
                    </div>
                    <h3 class="text-2xl font-bold mb-2 text-green-200">Termometer Alam</h3>
                    <p class="text-sm text-blue-200 mb-8 max-w-xs mx-auto">Jangkrik berbunyi lebih cepat saat suhu panas. Coba atur jumlah bunyi!</p>
                    
                    <div class="bg-white/10 p-6 rounded-2xl backdrop-blur-md border border-white/20">
                        <label class="block text-xs font-bold text-green-300 uppercase mb-2">Bunyi per Menit (n)</label>
                        <input type="range" min="40" max="200" value="40" class="w-full accent-green-400 mb-4" oninput="calcCricket(this.value)">
                        <div class="text-4xl font-mono font-bold text-yellow-300" id="crick-res">10¬∞C</div>
                        <p class="text-xs text-white/50 mt-2">Rumus: T = 10 + (n - 40) / 7</p>
                    </div>
                </div>
            </div>`;
            if(item.appType === 'carbon') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-[#E0F7FA] rounded-3xl p-6 relative">
                <div class="flex gap-8 items-end mb-8 relative z-10">
                    <div class="text-center group">
                        <i class="fas fa-smog text-6xl text-gray-600 transition-transform duration-500" id="carb-icon"></i>
                        <p class="text-xs font-bold text-gray-500 mt-2">Emisi (x)</p>
                    </div>
                    <div class="text-2xl font-bold text-red-500">VS</div>
                    <div class="text-center group">
                        <i class="fas fa-tree text-6xl text-green-600 transition-transform duration-500" id="tree-icon"></i>
                        <p class="text-xs font-bold text-green-600 mt-2">Penyerap (y)</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm z-10">
                    <div class="mb-4">
                        <label class="flex justify-between text-xs font-bold text-gray-500 uppercase mb-1"><span>üöó Perjalanan (km)</span> <span id="c-km">0</span></label>
                        <input type="range" min="0" max="100" value="0" class="w-full accent-gray-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="calcCarbon()">
                    </div>
                    <div class="mb-6">
                        <label class="flex justify-between text-xs font-bold text-green-600 uppercase mb-1"><span>üå≥ Pohon Ditanam</span> <span id="c-tree">0</span></label>
                        <input type="range" min="0" max="20" value="0" class="w-full accent-green-600 h-2 bg-green-100 rounded-lg appearance-none cursor-pointer" oninput="calcCarbon()">
                    </div>
                    <div class="p-4 rounded-xl text-center transition-colors duration-300" id="carb-status">
                        <div class="text-xs uppercase font-bold opacity-70">Status Neraca</div>
                        <div class="text-xl font-bold" id="carb-res">Seimbang</div>
                    </div>
                </div>
            </div>`;
            if(item.appType === 'river') return `
            <div class="h-full flex flex-col animate-fade-in relative rounded-3xl overflow-hidden border-2 border-blue-200 cursor-pointer" onclick="addRock(event)">
                <canvas id="cv-river" class="w-full h-full block bg-[#81D4FA]"></canvas>
                <div class="absolute top-4 left-4 bg-white/80 backdrop-blur p-3 rounded-xl shadow-lg">
                    <label class="text-xs font-bold text-blue-800 uppercase block mb-1">Kemiringan (m)</label>
                    <input type="range" min="0" max="40" value="10" class="w-32 accent-blue-600" oninput="drawRiver(this.value)">
                </div>
                <div class="absolute bottom-4 left-4 text-xs font-bold text-white bg-black/20 px-3 py-1 rounded-full pointer-events-none">Klik sungai untuk taruh batu!</div>
                <script>setTimeout(()=>drawRiver(10), 500);
            </div>`;
            if(item.appType === 'leaf_machine') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-green-50 rounded-3xl relative overflow-hidden">
                <div class="relative w-64 h-80">
                    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-xl text-green-500 fill-current">
                        <path d="M50 95 C 20 80, 0 50, 50 5 C 100 50, 80 80, 50 95 Z" />
                    </svg>
                    
                    <div class="absolute top-1/4 -left-10 bg-yellow-100 p-2 rounded-lg shadow border border-yellow-300 flex items-center gap-2">
                        <i class="fas fa-sun text-yellow-500 animate-spin-slow"></i> 
                        <input type="number" id="in-light" value="0" class="w-10 bg-transparent font-bold text-center outline-none" oninput="calcLeaf()">
                    </div>
                    <div class="absolute bottom-1/4 -left-10 bg-blue-100 p-2 rounded-lg shadow border border-blue-300 flex items-center gap-2">
                        <i class="fas fa-tint text-blue-500 animate-bounce"></i> 
                        <input type="number" id="in-water" value="0" class="w-10 bg-transparent font-bold text-center outline-none" oninput="calcLeaf()">
                    </div>

                    <div class="absolute top-1/2 -right-12 bg-white p-2 rounded-lg shadow border border-green-300">
                        <div class="text-xs font-bold text-green-800">GULA (z)</div>
                        <div id="out-sugar" class="text-xl font-bold text-green-600">0</div>
                    </div>
                </div>
                <p class="mt-4 text-earth-600 text-sm font-medium">Rumus Daun: z = 2x + y</p>
            </div>`;
            if(item.appType === 'food_chain') return `
            <div class="h-full flex flex-col items-center animate-fade-in bg-[#FFF8E1] rounded-3xl p-6">
                <h3 class="font-bold text-earth-800 mb-6">Neraca Ekosistem</h3>
                <div class="flex items-center gap-4 w-full max-w-md flex-1">
                    <div class="flex-1 flex flex-col items-center gap-2">
                        <div id="fc-grass" class="w-16 h-16 bg-green-200 rounded-full flex items-center justify-center text-2xl transition-all duration-500">üåø</div>
                        <input type="range" min="0" max="100" value="50" class="h-32 -rotate-90 accent-green-600 w-8" oninput="updateEco('grass', this.value)">
                    </div>
                    <i class="fas fa-chevron-right text-earth-300"></i>
                    <div class="flex-1 flex flex-col items-center gap-2">
                        <div id="fc-deer" class="w-16 h-16 bg-orange-200 rounded-full flex items-center justify-center text-2xl transition-all duration-500">ü¶å</div>
                        <div class="h-32 w-2 bg-gray-100 rounded-full relative overflow-hidden">
                            <div id="bar-deer" class="absolute bottom-0 w-full bg-orange-400 transition-all duration-500" style="height: 50%"></div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-earth-300"></i>
                    <div class="flex-1 flex flex-col items-center gap-2">
                        <div id="fc-wolf" class="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center text-2xl transition-all duration-500">üê∫</div>
                        <div class="h-32 w-2 bg-gray-100 rounded-full relative overflow-hidden">
                            <div id="bar-wolf" class="absolute bottom-0 w-full bg-gray-600 transition-all duration-500" style="height: 50%"></div>
                        </div>
                    </div>
                </div>
                <div id="eco-msg" class="mt-4 p-3 bg-white rounded-xl shadow text-sm font-bold text-earth-600 w-full text-center">
                    Geser populasi rumput!
                </div>
            </div>`;
            if(item.appType === 'bacteria') return `
            <div class="h-full flex flex-col items-center justify-center animate-fade-in bg-gray-900 rounded-3xl p-6 relative">
                <div class="w-64 h-64 rounded-full border-4 border-white/10 bg-black relative shadow-[0_0_30px_rgba(74,222,128,0.2)] overflow-hidden cursor-pointer active:scale-95 transition" id="petri-dish" onclick="splitBacteria()">
                    <div class="bacteria w-4 h-4 bg-green-500 rounded-full absolute top-1/2 left-1/2 -ml-2 -mt-2 shadow-[0_0_10px_#4ade80] animate-pulse"></div>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition hover:opacity-100">
                        <span class="text-white/80 font-bold bg-black/50 px-2 py-1 rounded">Klik untuk Belah</span>
                    </div>
                </div>
                
                <div class="mt-8 grid grid-cols-2 gap-8 w-full max-w-xs text-white">
                    <div class="bg-white/5 p-3 rounded-xl border border-white/10 text-center">
                        <div class="text-xs text-gray-400 uppercase">Waktu (n)</div>
                        <div id="bac-n" class="text-3xl font-mono font-bold text-green-400">0</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-xl border border-white/10 text-center">
                        <div class="text-xs text-gray-400 uppercase">Total (2‚Åø)</div>
                        <div id="bac-total" class="text-3xl font-mono font-bold text-green-400">1</div>
                    </div>
                </div>
            </div>`;
            if(item.appType === 'bird_nav') return `
            <div class="h-full flex flex-col animate-fade-in bg-blue-50 rounded-3xl relative overflow-hidden border-2 border-blue-200">
                <canvas id="cv-bird" class="w-full h-full block cursor-crosshair" onmousedown="moveBird(event)"></canvas>
                <div class="absolute top-4 right-4 bg-white/90 p-3 rounded-xl shadow text-right">
                    <div class="text-xs font-bold text-blue-400 uppercase">Koordinat</div>
                    <div id="bird-coor" class="text-xl font-mono font-bold text-blue-800">(0, 0)</div>
                </div>
                <div class="absolute bottom-4 left-4 text-xs font-bold text-blue-500 bg-white/80 px-3 py-1 rounded-full pointer-events-none">
                    Klik peta untuk memandu burung!
                </div>
                <script>setTimeout(initBirdMap, 500);
            </div>`;
            if(item.appType === 'quake') return `
            <div class="h-full flex flex-col animate-fade-in bg-earth-50 rounded-3xl p-4 border border-earth-200">
                <h3 class="font-bold text-earth-800 text-center mb-2">Peta Sebaran Gempa</h3>
                <div class="flex-1 bg-white rounded-xl border border-earth-200 relative overflow-hidden" id="quake-map">
                    <div class="absolute inset-0" style="background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px); background-size: 20px 20px;"></div>
                    </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-xs text-earth-500">Sumbu X: Jarak (km)<br>Sumbu Y: Kekuatan (SR)</div>
                    <button onclick="genQuake()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold shadow hover:bg-red-600"><i class="fas fa-sync mr-2"></i>Data Baru</button>
                </div>
                <script>setTimeout(genQuake, 500);
            </div>`;

            // Fallback untuk helper forms
            return `<div class="p-10 text-center">App Under Construction</div>`;
        }
            
        // --- FALLBACK UTAMA RENDERAPP (Jika tidak ada tipe yang cocok) ---
        return `<div class="text-center animate-fade-in p-10"><i class="fas ${item.icon} text-6xl opacity-20 mb-4" style="color:${cat.hex}"></i><p class="text-earth-600 font-serif text-lg">Modul Interaktif Siap.</p></div>`;

    } // <--- PASTIKAN KURUNG KURAWAL INI ADA! (Penutup renderApp)

    // --- 4. APP HELPER FUNCTIONS ---
    
    // Quiz
    window.checkQuiz = function(btn, cor, exp) {
        userProfile.progress.quizzesTaken++;
        const fb = btn.querySelector('.feedback'); fb.classList.remove('hidden');
        
        if(cor) { 
            userProfile.progress.quizzesCorrect++; 
            addXP(15); 
            btn.className = "w-full p-4 rounded-xl border-2 border-green-500 bg-green-50 text-green-800 font-bold text-left flex items-center"; 
            fb.innerHTML='<i class="fas fa-check"></i>'; 
            
            // BADGE MASTER KUIS (10 Benar)
            if(userProfile.progress.quizzesCorrect >= 10) unlockBadge('quiz_master');
        } else { 
            btn.className = "w-full p-4 rounded-xl border-2 border-red-400 bg-red-50 text-red-800 font-bold text-left flex items-center"; 
            fb.innerHTML='<i class="fas fa-times"></i>'; 
        }
        
        if(exp) {
            const expBox = document.getElementById('quiz-explanation');
            if(expBox) {
                expBox.innerHTML = `<strong class="block mb-1 text-earth-900">üí° Penjelasan:</strong> ${exp}`; 
                expBox.classList.remove('hidden');
            }
        }
        saveUser();
    };

    // Story Builder
    window.genStory = function(hex) {
        const n = document.getElementById('s-n').value||'Budi'; const v = document.getElementById('s-v').value||5;
        const o1 = document.getElementById('s-o1').value||'Buku'; const res = document.getElementById('s-res');
        res.classList.remove('hidden');
        res.innerHTML = `<b>Cerita Aljabar:</b><br>"${n} membeli ${v} buah ${o1} dengan harga total y rupiah."<br><br><span class="bg-earth-100 px-2 py-1 rounded text-sm font-mono border border-earth-200">Model: y = ${v}x</span>`;
        unlockBadge('linguist');
        addXP(10);
    };

    // Pattern
    // GANTI FUNGSI checkPat DENGAN INI:
    window.checkPat = function(btn, val, ans) {
        const msg = document.getElementById('p-msg');
        const slot = document.getElementById('p-slot');
        
        if(String(val) === String(ans)) { 
            msg.innerHTML = '<i class="fas fa-check-circle"></i> Benar! (+10 XP)'; 
            msg.className = "mt-6 font-bold text-lg h-8 text-green-600 animate-bounce"; 
            
            slot.innerText = ans; 
            slot.className = "w-12 h-12 flex items-center justify-center bg-green-100 text-green-700 rounded-lg font-bold border-2 border-green-500 shadow-lg transform scale-110 transition";
            
            btn.className = "min-w-[4rem] px-4 py-3 rounded-xl bg-green-500 border-b-4 border-green-700 text-white font-bold text-lg shadow-md";
            unlockBadge('logician');
            addXP(10); 
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
        } else { 
            msg.innerText = "Coba lagi..."; 
            msg.className = "mt-6 font-bold text-lg h-8 text-red-500"; 
            btn.classList.add('bg-red-50', 'text-red-500', 'border-red-200');
        }
    };

    // Input Save
    window.saveInp = function(hex) {
        const val = document.getElementById('inp-area').value;
        localStorage.setItem(`inp_${currentCatId}_${currentMediaIndex}_${currentSubContentIndex}`, val);
        const m = document.getElementById('saved-msg'); m.style.opacity=1; setTimeout(()=>m.style.opacity=0, 2000); addXP(5);
    };

    // Graph Canvas
    window.drawGraph = function(hex) {
        const cv = document.getElementById('cv-graph'); if(!cv)return; const ctx = cv.getContext('2d');
        const m = parseFloat(document.getElementById('sl-m').value); const c = parseFloat(document.getElementById('sl-c').value);
        if(document.getElementById('val-m')) document.getElementById('val-m').innerText = m;
        if(document.getElementById('val-c')) document.getElementById('val-c').innerText = c;
        const w = cv.width, h = cv.height; ctx.clearRect(0,0,w,h);
        ctx.strokeStyle='#E6E2D3'; ctx.lineWidth=1; ctx.beginPath(); for(let i=0;i<=w;i+=40){ctx.moveTo(i,0);ctx.lineTo(i,h);} for(let i=0;i<=h;i+=40){ctx.moveTo(0,i);ctx.lineTo(w,i);} ctx.stroke();
        ctx.strokeStyle='#B09E80'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(w/2,0); ctx.lineTo(w/2,h); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
        ctx.strokeStyle=hex; ctx.lineWidth=4; ctx.beginPath();
        const sc=40, x1=-8, y1=m*x1+c, x2=8, y2=m*x2+c;
        ctx.moveTo(w/2+x1*sc, h/2-y1*sc); ctx.lineTo(w/2+x2*sc, h/2-y2*sc); ctx.stroke();
        if(!userProfile.badges.includes('visualizer')) unlockBadge('visualizer');
    };

    // Free Draw
    window.initDraw = function(hex) {
        const cv = document.getElementById('cv-draw'); if(!cv)return; const ctx = cv.getContext('2d');
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        let p = false; 
        const start = e => { p=true; draw(e); }; const end = () => { p=false; ctx.beginPath(); };
        const draw = e => { 
            if(!p) return; const r = cv.getBoundingClientRect();
            ctx.lineWidth=3; ctx.lineCap='round'; ctx.strokeStyle=hex;
            const x = (e.clientX||e.touches[0].clientX)-r.left; const y = (e.clientY||e.touches[0].clientY)-r.top;
            ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
        };
        cv.onmousedown=start; cv.onmouseup=end; cv.onmousemove=draw; cv.ontouchstart=start; cv.ontouchend=end; cv.ontouchmove=draw;
    };
    window.clsDraw = function() { const cv=document.getElementById('cv-draw'); cv.getContext('2d').clearRect(0,0,cv.width,cv.height); };

    // Chat Reply
    window.replyChat = function(hex) {
        const inp = document.getElementById('chat-inp'); const box = document.getElementById('chat-box');
        if(!inp.value.trim()) return;
        unlockBadge('socialite');
        box.innerHTML += `<div class="flex flex-col items-end animate-fade-in-up"><div class="bg-[${hex}] text-white px-4 py-2 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-sm" style="background-color:${hex}">${inp.value}</div><span class="text-[10px] text-earth-400 mt-1 px-1">You</span></div>`;
        const txt = inp.value; inp.value=''; box.scrollTop=box.scrollHeight;
        setTimeout(() => {
            let r = "Coba lagi..."; if(txt.includes('=')||txt.includes('+')) { r="Model matematikanya terlihat bagus!"; addXP(5); }
            box.innerHTML += `<div class="flex flex-col items-start animate-fade-in-up"><div class="bg-white text-earth-800 border border-earth-200 px-4 py-2 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-sm">${r}</div><span class="text-[10px] text-earth-400 mt-1 px-1">Penjual</span></div>`; box.scrollTop=box.scrollHeight;
        }, 800);
    };

    // Rhythm
    window.playBeat = function(val, btn) {
        btn.classList.add('scale-90', 'ring-4'); setTimeout(()=>btn.classList.remove('scale-90','ring-4'), 150);
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        const f = {1:261.63, 2:329.63, 4:392.00, 8:523.25}; osc.frequency.value=f[val];
        osc.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.5); setTimeout(()=>osc.stop(),500);
    };

    // Mood
    window.setMood = function(m, hex) {
        const r = document.getElementById('mood-response');
        const map = {'cemas':"Tarik napas, matematika itu proses.", 'bingung':"Bingung tanda belajar!", 'paham':"Pertahankan!"};
        r.classList.remove('hidden'); r.innerHTML=`<b>AI:</b> "${map[m]}"`; addXP(5);
    };

    // Bill
    window.calcBill = function() {
        const t = parseFloat(document.getElementById('bill-tot').value)||0;
        const tx = parseFloat(document.getElementById('bill-tax').value)||0;
        const n = parseFloat(document.getElementById('bill-ppl').value)||1;
        document.getElementById('bill-res').innerText = "Rp "+Math.round((t+(t*tx/100))/n).toLocaleString('id-ID');
    };

    // Wave
    window.initWave = function(hex) { window.updateWave(hex); };
    window.updateWave = function(hex) {
        const cv = document.getElementById('cv-wave'); if(!cv)return; const ctx = cv.getContext('2d');
        const w=cv.width=cv.parentElement.clientWidth; const h=cv.height=cv.parentElement.clientHeight;
        const a=parseInt(document.getElementById('sl-amp').value); const f=parseInt(document.getElementById('sl-freq').value);
        if(document.getElementById('val-amp')) document.getElementById('val-amp').innerText=a;
        if(document.getElementById('val-freq')) document.getElementById('val-freq').innerText=f;
        ctx.clearRect(0,0,w,h); ctx.beginPath(); ctx.moveTo(0,h/2); ctx.strokeStyle=hex; ctx.lineWidth=3;
        for(let x=0;x<w;x++) ctx.lineTo(x, h/2 + a*Math.sin((f*0.01)*x)); ctx.stroke();
    };

    // Drag Drop
    window.allowDrop = e => e.preventDefault();
    window.ddStart = e => e.dataTransfer.setData("text", e.target.id);
    window.ddDrop = (e, t) => {
        e.preventDefault(); const id = e.dataTransfer.getData("text"); const el = document.getElementById(id); if(!el)return;
        const isV = /[a-zA-Z]/.test(el.innerText); const ok = (t==='var'&&isV) || (t==='const'&&!isV);
        if(ok) { e.currentTarget.querySelector('div').appendChild(el); el.className="px-3 py-1 bg-white border border-green-500 text-green-700 rounded shadow-sm text-sm font-bold"; el.draggable=false; addXP(5); }
        else { el.classList.add('bg-red-100','shake'); setTimeout(()=>el.classList.remove('bg-red-100','shake'),500); }
    };
    
    // --- 8. LOGIKA GAME KINESTETIK (ALL IN ONE) ---
    
    // Global Game State
    let gameLoop, gameState = { active: false, type: '', pos: 0, score: 0 };

    // --- FIX LOGIKA GAME KINESTETIK (Agar bisa ganti game) ---
    
    // Tambahkan fungsi ini untuk mematikan game
    window.stopGame = function() {
        if(gameLoop) cancelAnimationFrame(gameLoop); // Hentikan animasi
        gameLoop = null;
        gameState.active = false; // Reset status aktif
    };

    // Update fungsi startGame
    window.startGame = function(type) {
        // FIX: Selalu matikan game sebelumnya sebelum memulai yang baru
        stopGame(); 

        gameState = { active: true, type: type, pos: 50, score: 0, enemy: 100, vel: 0 };
        
        // Hilangkan Overlay (Judul Klik Main)
        const overlay = document.getElementById(`overlay-${type}`);
        if(overlay) {
            overlay.style.opacity = '0';
            overlay.style.pointerEvents = 'none';
        }
        
        // Inisialisasi Posisi Awal
        if(type === 'jumper') gameState.pos = 1;
        if(type === 'maze') gameState.pos = {x:1, y:1};
        if(type === 'racer') gameState.angle = 0;

        // Mulai Loop
        gameLoop = requestAnimationFrame(() => gameTick(type));
    };
    // --- UPDATE FUNGSI INPUT ---
    window.gameInput = function(val) {
        if(!gameState.active) return;
        
        // Jumper
        if(gameState.type === 'jumper') {
            if(val === 'right') gameState.pos++;
            if(val === 'left') gameState.pos--;
            document.getElementById(`status-jumper`).innerText = `Posisi: ${gameState.pos}`;
        }
        // Maze
        if(gameState.type === 'maze') {
            if(val==='up') gameState.pos.y--;
            if(val==='down') gameState.pos.y++;
            if(val==='left') gameState.pos.x--;
            if(val==='right') gameState.pos.x++;
            gameState.pos.x = Math.max(0, Math.min(10, gameState.pos.x));
            gameState.pos.y = Math.max(0, Math.min(10, gameState.pos.y));
        }
        // Racer
        if(gameState.type === 'racer') gameState.angle = parseInt(val);
        // Runner (Speed)
        if(gameState.type === 'runner') gameState.vel = parseInt(val);
        // Cannon (Meriam)
        if(gameState.type === 'cannon') {
            if(val.t === 'h') gameState.pos.y = parseInt(val.v); // Height (c)
            if(val.t === 'a') gameState.angle = parseInt(val.v); // Angle (m)
        }
    };

    // --- UPDATE FUNGSI TICK (LOGIKA UTAMA) ---
    function gameTick(type) {
        if(!gameState.active) return;
        const cv = document.getElementById(`cv-game-${type}`);
        if(!cv) return;
        const ctx = cv.getContext('2d');
        
        // Resize Canvas
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        const w = cv.width, h = cv.height;

        ctx.clearRect(0,0,w,h);

        // --- 1. SPEED RUNNER (NEW) ---
        if(type === 'runner') {
            // Background Track
            ctx.fillStyle = '#1F2937'; ctx.fillRect(0,0,w,h);
            ctx.fillStyle = '#374151'; // Jalur Lari
            ctx.fillRect(0, h/2 - 20, w, 40);
            ctx.strokeStyle = '#fff'; ctx.setLineDash([10, 10]);
            ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke(); ctx.setLineDash([]);

            // Garis Finish
            ctx.fillStyle = '#EF4444'; ctx.fillRect(w-40, h/2-30, 10, 60);
            ctx.fillStyle = '#fff'; ctx.font='10px sans-serif'; ctx.fillText('FINISH', w-45, h/2-40);

            // Update Posisi Player (v * t)
            gameState.pos += (gameState.vel * 0.05); // Kecepatan simulasi
            
            // Update Hantu (Kecepatan Tetap: 10)
            gameState.enemy += (10 * 0.05);

            // Gambar Hantu (Target)
            const ghostX = Math.min(gameState.enemy, w-40);
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = '#9CA3AF'; ctx.beginPath(); ctx.arc(ghostX, h/2 - 10, 10, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;

            // Gambar Player
            const playerX = Math.min(gameState.pos, w-40);
            ctx.fillStyle = '#3B82F6'; 
            ctx.beginPath(); ctx.arc(playerX, h/2 + 10, 10, 0, Math.PI*2); ctx.fill();
            
            // Info HUD
            ctx.fillStyle = 'white'; ctx.font = 'bold 14px monospace';
            ctx.fillText(`Kecepatanmu: ${gameState.vel} m/s`, 10, 30);
            ctx.fillText(`Target: 10 m/s`, 10, 50);

            // Cek Menang/Kalah
            if(gameState.enemy >= w-50) {
                const diff = Math.abs(gameState.pos - gameState.enemy);
                if(diff < 20) { ctx.fillStyle='#4ADE80'; ctx.font='30px bold'; ctx.fillText("HEBAT!", w/2-50, h/2); addXP(1); }
                else { ctx.fillStyle='#F87171'; ctx.font='20px bold'; ctx.fillText(gameState.pos>gameState.enemy?"Terlalu Cepat!":"Terlalu Lambat!", w/2-80, h/2); }
                // Reset setelah 2 detik
                if(gameState.active) setTimeout(()=>{ gameState.pos=0; gameState.enemy=0; }, 2000);
                unlockBadge('athlete'); // <--- TAMBAHKAN INI
            }
        }

        // --- 2. MERIAM LINEAR (NEW) ---
        if(type === 'cannon') {
            // Inisialisasi posisi awal (jika belum)
            if(!gameState.target) gameState.target = {x: w-50, y: Math.random()*(h-40)+20};
            if(!gameState.pos) gameState.pos = {y: 50}; // Tinggi meriam default

            // Background
            ctx.fillStyle = '#0F172A'; ctx.fillRect(0,0,w,h);
            
            // Gambar Target (Lingkaran Merah)
            ctx.fillStyle = '#EF4444';
            ctx.beginPath(); ctx.arc(gameState.target.x, gameState.target.y, 15, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();

            // Gambar Meriam (Kotak Hijau di Kiri)
            const cY = h - (gameState.pos.y / 100 * h); // Map 0-100 ke Tinggi Canvas
            ctx.fillStyle = '#22C55E';
            ctx.fillRect(0, cY - 15, 40, 30);

            // Hitung Jalur Laser (Persamaan Garis Lurus: y = mx + c)
            // m = tan(angle)
            const angleRad = -gameState.angle * (Math.PI / 180); // Negatif karena Y canvas terbalik
            const startX = 40;
            const startY = cY;
            const endX = w;
            const endY = startY + (Math.tan(angleRad) * (endX - startX));

            // Gambar Laser
            ctx.strokeStyle = '#FACC15'; ctx.lineWidth = 3; ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); ctx.stroke(); ctx.setLineDash([]);

            // Cek Kena Sasaran (Collision sederhana pada garis X target)
            const targetHitY = startY + (Math.tan(angleRad) * (gameState.target.x - startX));
            const dist = Math.abs(targetHitY - gameState.target.y);

            // Teks Info
            ctx.fillStyle = 'white'; ctx.font = '12px monospace';
            ctx.fillText(`Tinggi (c): ${gameState.pos.y}`, 10, 20);
            ctx.fillText(`Sudut (m): ${gameState.angle}¬∞`, 10, 35);

            if(dist < 20) {
                ctx.fillStyle = '#FACC15'; ctx.font = '30px bold'; 
                ctx.fillText("KENA! üí•", w/2 - 60, h/2);
                if(Math.random() < 0.05) addXP(5); // Random reward agar tidak spam XP
                unlockBadge('sniper'); // <--- TAMBAHKAN INI
            }
        }

        // --- 3. JUMPER (EXISTING) ---
        if(type === 'jumper') {
            ctx.strokeStyle = '#fff'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
            const unit = w/10;
            const x = gameState.pos * unit + (w/2);
            ctx.fillStyle = '#4ADE80'; ctx.beginPath(); ctx.arc(x, h/2 - 20, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(x-5, h/2-25, 2, 0, Math.PI*2); ctx.arc(x+5, h/2-25, 2, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,0,0.3)'; ctx.beginPath(); ctx.arc((3*unit + w/2), h/2, 20, 0, Math.PI*2); ctx.fill();
            if(gameState.pos === 3) { ctx.fillStyle='gold'; ctx.fillText('MENANG!', w/2-30, h/2-50); addXP(1); }
                unlockBadge('athlete'); // <--- TAMBAHKAN INI
        }

        // --- 4. MAZE (EXISTING) ---
        if(type === 'maze') {
            const size = Math.min(w,h)/10;
            ctx.strokeStyle = '#ffffff20';
            for(let i=0;i<10;i++) for(let j=0;j<10;j++) ctx.strokeRect(i*size, j*size, size, size);
            ctx.fillStyle = '#F87171'; ctx.fillRect(gameState.pos.x * size + 2, gameState.pos.y * size + 2, size-4, size-4);
            ctx.fillStyle = '#34D399'; ctx.fillRect(5 * size, 5 * size, size, size);
            if(gameState.pos.x===5 && gameState.pos.y===5) { gameState.active=false; alert('Sampai!'); addXP(10); }
        }

        // --- 5. RACER (EXISTING) ---
        if(type === 'racer') {
            ctx.fillStyle = '#38BDF8'; ctx.fillRect(0,0,w,h/2);
            ctx.fillStyle = '#166534'; ctx.fillRect(0,h/2,w,h/2);
            ctx.save(); ctx.translate(w/2, h/2); ctx.rotate(gameState.angle * Math.PI / 180);
            ctx.fillStyle = '#65A30D'; ctx.fillRect(-w, 0, w*2, h);
            ctx.fillStyle = 'white'; ctx.fillRect(-20, -30, 40, 30);
            ctx.beginPath(); ctx.arc(-15, 0, 10, 0, Math.PI*2); ctx.arc(15, 0, 10, 0, Math.PI*2); ctx.fillStyle='black'; ctx.fill();
            ctx.restore();
            ctx.fillStyle = 'white'; ctx.font = 'bold 16px sans-serif'; ctx.fillText(`Sudut: ${gameState.angle}¬∞`, 20, 30);
        }

        gameLoop = requestAnimationFrame(() => gameTick(type));
    }

    // --- Helper untuk Fingers & Rhythm ---
    window.toggleFinger = function(el) {
        const isUp = el.dataset.up === 'true';
        if(isUp) {
            el.style.transform = 'scaleY(1)'; 
            el.style.backgroundColor = '#E6E2D3'; // Warna kulit
            el.dataset.up = 'false';
        } else {
            el.style.transform = 'scaleY(0.6)'; // Melipat
            el.style.backgroundColor = '#BC6C25'; // Warna gelap
            el.dataset.up = 'true';
        }
    };
    window.checkFinger = function() {
        const folded = document.querySelectorAll('.finger[data-up="true"]').length;
        // Logic terbalik: Jari terlipat biasanya menghitung 0, tapi di sini kita anggap 'menunjukkan angka' dengan sisa jari berdiri?
        // Sederhananya: Hitung jari yang BERDIRI (scaleY 1).
        const standing = document.querySelectorAll('.finger[data-up="false"]').length;
        if(standing === 3) { alert("Benar! 3 Jari."); addXP(10); } else alert(`Itu ${standing} jari. Coba buat 3.`);
    };

    window.startRhythm = function() {
        // Simple mock rhythm
        const target = document.getElementById('rhy-target');
        const seq = [1, 2, 4, 8];
        let i = 0;
        target.parentElement.querySelector('button').style.display='none';
        
        const interval = setInterval(() => {
            if(i >= seq.length) { clearInterval(interval); return; }
            target.style.transform = 'scale(1.2)';
            target.style.borderColor = '#FACC15';
            document.getElementById(`rhy-${i+1}`).style.backgroundColor = '#FACC15';
            setTimeout(() => {
                target.style.transform = 'scale(1)';
                target.style.borderColor = 'rgba(255,255,255,0.3)';
            }, 200);
            i++;
        }, 1000);
        
        // Input handler
        document.body.onkeydown = (e) => {
            if(e.code === 'Space') {
                document.getElementById('rhy-msg').innerText = "GREAT!";
                setTimeout(()=>document.getElementById('rhy-msg').innerText="", 500);
                addXP(2);
            }
        };
    };

    // --- Helper Drag Ruler ---
    window.dragStart = function(e, el) {
        e.preventDefault();
        let shiftX = e.clientX - el.getBoundingClientRect().left;
        let shiftY = e.clientY - el.getBoundingClientRect().top;
        document.onmousemove = function(ev) {
            el.style.left = ev.pageX - shiftX - 20 + 'px'; // -20 offset parent padding
            el.style.top = ev.pageY - shiftY - 100 + 'px';
        };
        document.onmouseup = function() { document.onmousemove = null; };
    };

    // --- 12. LOGIKA INTERPERSONAL APPS ---

    // A. MAGIC MATH
    const magicSteps = [
        { t: "Kalikan angkamu dengan 2 (2x)", i: "fa-times" },
        { t: "Tambah dengan 10 (2x + 10)", i: "fa-plus" },
        { t: "Bagi dengan 2 (x + 5)", i: "fa-divide" },
        { t: "Kurangi dengan angka awalmu (x + 5 - x)", i: "fa-minus" },
        { t: "Hasilnya pasti 5! üòé", i: "fa-magic", end: true }
    ];
    window.nextMagic = function(step) {
        const box = document.getElementById('magic-step');
        if(!box) return;
        
        if(step >= magicSteps.length) {
            // Reset
            box.innerHTML = `<h3 class="text-2xl font-bold mb-4">Pikirkan satu angka (x)...</h3><p class="mb-8 opacity-80">Jangan beritahu aku!</p><button onclick="nextMagic(0)" class="px-8 py-3 bg-yellow-400 text-purple-900 rounded-full font-bold hover:scale-105 transition shadow-lg">Lanjut <i class="fas fa-arrow-right ml-2"></i></button>`;
            return;
        }

        const s = magicSteps[step];
        box.innerHTML = `
            <i class="fas ${s.i} text-4xl mb-4 text-yellow-300 block animate-bounce-slow"></i>
            <h3 class="text-2xl font-bold mb-8">${s.t}</h3>
            <button onclick="nextMagic(${step+1})" class="px-8 py-3 ${s.end?'bg-green-500 text-white':'bg-yellow-400 text-purple-900'} rounded-full font-bold hover:scale-105 transition shadow-lg">${s.end?'Main Lagi':'Lanjut'} <i class="fas ${s.end?'fa-redo':'fa-arrow-right'} ml-2"></i></button>
        `;
        if(s.end) confetti();
    };

    // B. BUDGETING
    window.updateBudget = function() {
        const inps = document.querySelectorAll('input[type="range"]');
        const vals = [document.getElementById('val-b1'), document.getElementById('val-b2'), document.getElementById('val-b3')];
        let sum = 0;
        
        inps.forEach((inp, i) => {
            const v = parseInt(inp.value);
            sum += v;
            vals[i].innerText = "Rp " + v.toLocaleString('id-ID');
        });

        const totalEl = document.getElementById('bud-total');
        totalEl.innerText = "Rp " + sum.toLocaleString('id-ID');
        
        const msg = document.getElementById('bud-msg');
        if(sum === 10000000) {
            totalEl.className = "text-xl font-bold text-green-600";
            msg.innerText = "Pas! Anggaran Disetujui ‚úÖ"; msg.className = "mt-4 text-center text-sm font-bold h-6 text-green-600";
        } else if(sum > 10000000) {
            totalEl.className = "text-xl font-bold text-red-600";
            msg.innerText = "Over Budget! Kurangi Rp " + (sum-10000000).toLocaleString('id-ID'); msg.className = "mt-4 text-center text-sm font-bold h-6 text-red-500";
        } else {
            totalEl.className = "text-xl font-bold text-earth-800";
            msg.innerText = "Masih sisa Rp " + (10000000-sum).toLocaleString('id-ID'); msg.className = "mt-4 text-center text-sm font-bold h-6 text-earth-500";
        }
    };

    // C. KASIR
    window.checkCashier = function() {
        const val = parseInt(document.getElementById('cash-inp').value);
        const ans = (3 * 5000) + (2 * 2000); // 19000
        const msg = document.getElementById('cash-msg');
        
        if(val === ans) {
            msg.innerText = "Benar! (19.000) +10 XP";
            msg.className = "mt-4 font-bold h-6 text-green-600";
            unlockBadge('money_maker');
            addXP(10);
        } else {
            msg.innerText = "Salah. Coba hitung lagi (3x + 2y)";
            msg.className = "mt-4 font-bold h-6 text-red-500";
        }
    };

    // --- 10. LOGIKA 5 MEDIA MUSIKAL BARU ---

    // 1. INTERVALS
    window.playInterval = function(num, den) {
        initAudio();
        const now = audioCtx.currentTime;
        const base = 261.63; // C4
        const target = base * (num / den);
        
        // Mainkan Base (Kiri)
        const o1 = audioCtx.createOscillator(); const g1 = audioCtx.createGain();
        o1.connect(g1); g1.connect(audioCtx.destination);
        o1.frequency.value = base;
        g1.gain.setValueAtTime(0.3, now); g1.gain.exponentialRampToValueAtTime(0.01, now+1.5);
        o1.start(now); o1.stop(now+1.5);

        // Mainkan Target (Kanan/Harmoni)
        const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
        o2.connect(g2); g2.connect(audioCtx.destination);
        o2.frequency.value = target;
        g2.gain.setValueAtTime(0.3, now); g2.gain.exponentialRampToValueAtTime(0.01, now+1.5);
        o2.start(now); o2.stop(now+1.5);
    };

    // 2. LOOPER (SPLDV)
    let loopId;
    window.toggleLooper = function() {
        const btn = document.getElementById('btn-looper');
        if(loopId) { stopLooper(); btn.innerText = "MULAI LOOP"; return; }
        
        btn.innerText = "STOP";
        initAudio();
        const start = Date.now();
        const l1 = document.getElementById('loop-1');
        const l2 = document.getElementById('loop-2');
        const msg = document.getElementById('loop-msg');
        
        loopId = requestAnimationFrame(function tick() {
            if(!loopId) return;
            const elapsed = (Date.now() - start) / 1000;
            
            // Rotasi visual (360 derajat per periode)
            const deg1 = (elapsed % 2) / 2 * 360;
            const deg2 = (elapsed % 3) / 3 * 360;
            l1.style.transform = `rotate(${deg1}deg)`;
            l2.style.transform = `rotate(${deg2}deg)`;
            
            // Cek Tabrakan (KPK 6 detik)
            // Toleransi 0.05 detik
            if(Math.abs((elapsed % 6)) < 0.05 && elapsed > 0.5) {
                msg.innerText = "SYNC! (KPK = 6s)";
                // Bunyi 'Ping'
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = 880; 
                g.gain.setValueAtTime(0.5, audioCtx.currentTime); 
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.2);
                o.start(); o.stop(audioCtx.currentTime+0.2);
            } else {
                msg.innerText = "";
            }
            
            // Bunyi Tik per putaran
            if(Math.abs((elapsed % 2)) < 0.05 && elapsed > 0.1) playClick(400); // Loop 1
            if(Math.abs((elapsed % 3)) < 0.05 && elapsed > 0.1) playClick(600); // Loop 2
            
            loopId = requestAnimationFrame(tick);
        });
    };
    function playClick(f) {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type='square'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.05);
        o.start(); o.stop(audioCtx.currentTime+0.05);
    }
    window.stopLooper = function() {
        if(loopId) cancelAnimationFrame(loopId);
        loopId = null;
    };

    // 3. FREQ CALC
    window.calcHz = function() {
        const x = parseFloat(document.getElementById('hz-x').value) || 0;
        const f = 440 * Math.pow(2, x/12);
        document.getElementById('hz-res').innerText = f.toFixed(2) + " Hz";
    };
    window.playHz = function() {
        initAudio();
        const f = parseFloat(document.getElementById('hz-res').innerText);
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = f;
        g.gain.setValueAtTime(0.5, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+1);
        o.start(); o.stop(audioCtx.currentTime+1);
    };

    // 4. CHORD CHECK
    window.playChordType = function(type) {
        initAudio();
        const now = audioCtx.currentTime;
        const notes = type === 'consonant' ? [261.63, 329.63, 392.00] : [261.63, 277.18, 293.66]; // C Maj vs Cluster C-C#-D
        
        notes.forEach(f => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'triangle'; o.frequency.value = f;
            o.connect(g); g.connect(audioCtx.destination);
            g.gain.setValueAtTime(0.2, now); g.gain.exponentialRampToValueAtTime(0.01, now+1);
            o.start(now); o.stop(now+1);
        });
        
        if(type==='dissonant') alert("Suara Disonan! Seperti garis sejajar yang menolak bertemu.");
    };

    // 5. MOOD SOUND (GRADIENT)
    window.checkGradientSound = function(val) {
        const v = parseInt(val);
        const icon = document.getElementById('grad-icon');
        const desc = document.getElementById('grad-desc');
        document.getElementById('grad-val').innerText = v;

        if(v > 0) {
            icon.innerText = "üòÑ";
            desc.innerText = "Positif (Naik) - Major Chord - Semangat!";
            playArp([261.63, 329.63, 392.00, 523.25]); // C Major Arp
        } else if (v < 0) {
            icon.innerText = "üò¢";
            desc.innerText = "Negatif (Turun) - Minor Chord - Sedih/Meluruh";
            playArp([440.00, 349.23, 261.63, 220.00]); // A Minor Arp Down
        } else {
            icon.innerText = "üòê";
            desc.innerText = "Nol (Datar) - Monotone - Konstan";
            playArp([261.63, 261.63, 261.63]);
        }
    };
    function playArp(notes) {
        initAudio();
        const now = audioCtx.currentTime;
        notes.forEach((f, i) => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = f;
            g.gain.setValueAtTime(0.1, now + i*0.1); 
            g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.5);
            o.start(now + i*0.1); o.stop(now + i*0.1 + 0.5);
        });
    }

    // --- 11. LOGIKA GAME TAMBAHAN (Reflex, Memory, Simon) ---

    // A. REFLEX MATH
    let refState = { active: false, score: 0, time: 30, q: {}, balls: [], timerId: null, spawnId: null };

    window.startReflex = function() {
        refState = { active: true, score: 0, time: 30, q: {}, balls: [], timerId: null, spawnId: null };
        document.getElementById('ref-overlay').classList.add('hidden');
        document.getElementById('ref-score').innerText = '0';
        updateRefQ();
        
        refState.timerId = setInterval(() => {
            refState.time--;
            document.getElementById('ref-time').innerText = refState.time;
            if(refState.time <= 0) stopReflex(true);
        }, 1000);

        refState.spawnId = setInterval(spawnRefBall, 1000);
        requestAnimationFrame(animRef);
    };

    window.stopReflex = function(showRes) {
        refState.active = false;
        clearInterval(refState.timerId);
        clearInterval(refState.spawnId);
        const balls = document.querySelectorAll('.ref-ball');
        balls.forEach(b => b.remove());
        
        if(showRes) {
            document.getElementById('ref-overlay').classList.remove('hidden');
            document.querySelector('#ref-overlay h3').innerText = "Waktu Habis!";
            document.querySelector('#ref-overlay p').innerHTML = `Skor Akhir: <b class="text-accent-yellow">${refState.score}</b>`;
            if(refState.score > 0) addXP(refState.score);
        }
    };

    function updateRefQ() {
        const a = Math.floor(Math.random()*4)+1;
        const x = Math.floor(Math.random()*9)+1;
        const b = Math.floor(Math.random()*10);
        refState.q = { txt: `${a>1?a:''}x + ${b} = ${a*x+b}`, ans: x };
        document.getElementById('ref-q').innerText = refState.q.txt;
    }

    function spawnRefBall() {
        if(!refState.active) return;
        const area = document.getElementById('ref-area');
        if(!area) return; // Safety

        const ball = document.createElement('div');
        const isCor = Math.random() < 0.4; // 40% chance benar
        const val = isCor ? refState.q.ans : Math.floor(Math.random()*20);
        
        ball.className = 'ref-ball absolute w-14 h-14 rounded-full bg-orange-500 border-2 border-orange-300 shadow-lg flex items-center justify-center text-white font-bold text-xl cursor-pointer select-none hover:brightness-110 active:scale-90';
        ball.innerText = val;
        ball.style.left = Math.random() * 80 + 10 + '%';
        ball.style.top = '-60px';
        ball.dataset.speed = Math.random() * 2 + 2;
        ball.dataset.y = -60;

        ball.onmousedown = () => {
            if(!refState.active) return;
            if(val === refState.q.ans) {
                refState.score += 10;
                document.getElementById('ref-score').innerText = refState.score;
                ball.remove();
                updateRefQ(); // Ganti soal
                // Efek visual
                const fx = document.createElement('div'); fx.className = 'absolute text-green-400 font-bold text-2xl animate-bounce'; 
                fx.innerText = '+10'; fx.style.left = ball.style.left; fx.style.top = ball.style.top; area.appendChild(fx); setTimeout(()=>fx.remove(), 500);
            } else {
                refState.score = Math.max(0, refState.score - 5);
                document.getElementById('ref-score').innerText = refState.score;
                ball.style.backgroundColor = 'red';
                setTimeout(()=>ball.remove(), 200);
            }
        };
        area.appendChild(ball);
    }

    function animRef() {
        if(!refState.active) return;
        const balls = document.querySelectorAll('.ref-ball');
        const h = document.getElementById('ref-area')?.clientHeight || 400;
        
        balls.forEach(b => {
            let y = parseFloat(b.dataset.y) + parseFloat(b.dataset.speed);
            b.style.top = y + 'px';
            b.dataset.y = y;
            if(y > h) b.remove();
        });
        requestAnimationFrame(animRef);
    }

    // B. MEMORY ISYARAT
    let memState = { lock: false, first: null, matches: 0 };
    window.initMemory = function() {
        const grid = document.getElementById('mem-grid');
        if(!grid) return;
        grid.innerHTML = '';
        memState = { lock: false, first: null, matches: 0 };
        document.getElementById('mem-msg').innerText = '';

        // Pasangan Kartu (Simbol vs Gambar Tangan/Deskripsi)
        const pairs = [
            { id: 1, a: '+', b: 'ü§û (Tambah)' },
            { id: 2, a: '-', b: 'üôÖ‚Äç‚ôÇÔ∏è (Kurang)' },
            { id: 3, a: '=', b: 'ü§ù (Sama)' },
            { id: 4, a: 'x', b: 'ü§∑ (Variabel)' },
            { id: 5, a: '>', b: 'üëâ (Lebih)' },
            { id: 6, a: '<', b: 'üëà (Kurang)' }
        ];
        
        // Ambil 6 pasang (12 kartu)
        let cards = [];
        pairs.forEach(p => {
            cards.push({ id: p.id, val: p.a, type: 'sym' });
            cards.push({ id: p.id, val: p.b, type: 'img' });
        });
        
        // Shuffle
        cards.sort(() => Math.random() - 0.5);

        // Render
        cards.forEach(c => {
            const card = document.createElement('div');
            card.className = 'mem-card bg-white rounded-xl shadow cursor-pointer flex items-center justify-center text-2xl font-bold text-earth-800 border-2 border-earth-200 hover:-translate-y-1 transition h-full';
            card.innerHTML = `<span class="hidden">${c.val}</span><i class="fas fa-question text-earth-300"></i>`;
            card.dataset.id = c.id;
            
            card.onclick = () => flipCard(card);
            grid.appendChild(card);
        });
    };

    function flipCard(card) {
        if(memState.lock || card.classList.contains('flipped') || card.classList.contains('matched')) return;
        
        card.classList.add('flipped', 'bg-yellow-50', 'border-yellow-400');
        card.innerHTML = card.querySelector('span').innerHTML; // Show content

        if(!memState.first) {
            memState.first = card;
        } else {
            memState.lock = true;
            // Cek Match
            if(card.dataset.id === memState.first.dataset.id) {
                // Match!
                memState.first.classList.add('matched', 'bg-green-100', 'border-green-500', 'text-green-700');
                card.classList.add('matched', 'bg-green-100', 'border-green-500', 'text-green-700');
                memState.first = null;
                memState.lock = false;
                memState.matches++;
                if(memState.matches === 6) {
                    document.getElementById('mem-msg').innerText = "Semua Terbuka! +20 XP";
                    addXP(20); confetti();
                }
            } else {
                // Fail
                card.classList.add('bg-red-50'); memState.first.classList.add('bg-red-50');
                setTimeout(() => {
                    card.classList.remove('flipped', 'bg-red-50', 'bg-yellow-50', 'border-yellow-400');
                    card.innerHTML = `<span class="hidden">${card.innerText}</span><i class="fas fa-question text-earth-300"></i>`;
                    
                    memState.first.classList.remove('flipped', 'bg-red-50', 'bg-yellow-50', 'border-yellow-400');
                    memState.first.innerHTML = `<span class="hidden">${memState.first.innerText}</span><i class="fas fa-question text-earth-300"></i>`;
                    
                    memState.first = null;
                    memState.lock = false;
                }, 1000);
            }
        }
    }

    // C. SIMON SAYS (SENAM SIMBOL)
    let simState = { seq: [], userIdx: 0, level: 1, active: false };
    
    window.startSimon = function() {
        simState = { seq: [], userIdx: 0, level: 1, active: true };
        document.getElementById('simon-start').classList.add('hidden');
        nextSimonLevel();
    };
    
    window.stopSimon = function() {
        simState.active = false;
        // Reset UI if needed
    };

    function nextSimonLevel() {
        if(!simState.active) return;
        simState.userIdx = 0;
        document.getElementById('simon-level').innerText = "Level " + simState.level;
        
        // Tambah 1 gerakan baru
        simState.seq.push(Math.floor(Math.random() * 4));
        
        // Mainkan Sequence
        playSimonSeq();
    }

    function playSimonSeq() {
        let i = 0;
        // Disable input while playing
        document.querySelectorAll('.simon-btn').forEach(b => b.style.pointerEvents = 'none');
        
        const interval = setInterval(() => {
            if(i >= simState.seq.length) {
                clearInterval(interval);
                // Enable input
                document.querySelectorAll('.simon-btn').forEach(b => b.style.pointerEvents = 'auto');
                return;
            }
            flashSimon(simState.seq[i]);
            i++;
        }, 800);
    }

    function flashSimon(idx) {
        const btn = document.getElementById('sim-' + idx);
        btn.style.opacity = '0.5';
        btn.style.transform = 'scale(0.95)';
        
        // Bunyi (Opsional jika audioCtx ada)
        if(window.playNote) window.playNote(idx * 2, 'piano');

        setTimeout(() => {
            btn.style.opacity = '1';
            btn.style.transform = 'scale(1)';
        }, 400);
    }

    window.simonInput = function(idx) {
        if(!simState.active) return;
        flashSimon(idx);
        
        if(idx === simState.seq[simState.userIdx]) {
            // Benar
            simState.userIdx++;
            if(simState.userIdx >= simState.seq.length) {
                // Level Complete
                simState.level++;
                setTimeout(nextSimonLevel, 1000);
                addXP(5);
            }
        } else {
            // Salah - Game Over
            document.getElementById('simon-start').classList.remove('hidden');
            document.querySelector('#simon-start span').innerText = "SALAH! ULANGI?";
            simState.active = false;
        }
    };

    // --- 13. LOGIKA INTRAPERSONAL APPS ---

    // A. JOURNAL
    let journalData = [];
    window.addJournal = function() {
        const t = document.getElementById('j-topic').value;
        const d = document.getElementById('j-desc').value;
        if(!t || !d) return alert("Isi dulu topiknya!");
        
        journalData.unshift({t, d, date: new Date().toLocaleDateString()});
        document.getElementById('j-topic').value = '';
        document.getElementById('j-desc').value = '';
        renderJournal();
        unlockBadge('philosopher');
        addXP(5);
    };
    function renderJournal() {
        const el = document.getElementById('journal-list');
        if(!el) return;
        el.innerHTML = journalData.map(j => `
            <div class="bg-white p-3 rounded-xl border border-earth-100 shadow-sm animate-fade-in">
                <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-earth-700 text-sm">${j.t}</span>
                    <span class="text-[10px] text-earth-400">${j.date}</span>
                </div>
                <p class="text-xs text-earth-600">${j.d}</p>
            </div>
        `).join('');
    }

    // B. GOALS CALCULATOR
    window.calcGoal = function() {
        const curr = parseFloat(document.getElementById('g-curr').value) || 0;
        const target = parseFloat(document.getElementById('g-target').value) || 0;
        const weight = parseFloat(document.getElementById('g-weight').value) || 40; // Bobot UAS misal 40%
        
        // Rumus: Target = (Curr * (100-w) + Needed * w) / 100
        // Needed = (Target * 100 - Curr * (100-w)) / w
        
        const w_curr = 100 - weight;
        const needed = (target * 100 - (curr * w_curr)) / weight;
        
        const resEl = document.getElementById('g-res');
        const msgEl = document.getElementById('g-msg');
        
        resEl.innerText = needed.toFixed(1);
        
        if(needed > 100) {
            resEl.className = "text-4xl font-bold text-red-400";
            msgEl.innerText = "Mustahil! Kamu butuh lebih dari 100.";
        } else if(needed < 0) {
            resEl.className = "text-4xl font-bold text-green-400";
            msgEl.innerText = "Selamat! Kamu pasti lulus meski nilai 0.";
        } else {
            resEl.className = "text-4xl font-bold text-white";
            msgEl.innerText = needed > 80 ? "Harus belajar keras!" : "Bisa dicapai!";
        }
    };

    // C. MOOD TRACKER
    window.logMood = function(idx) {
        const grid = document.getElementById('mood-grid');
        const colors = ['bg-red-400', 'bg-orange-300', 'bg-gray-300', 'bg-green-300', 'bg-green-500'];
        if(grid) {
            const dot = document.createElement('div');
            dot.className = `aspect-square rounded-lg ${colors[idx]} animate-fade-in`;
            grid.appendChild(dot);
            addXP(2);
        }
    };

    // D. MEDITASI (BREATH)
    let breathState = 0; // 0:In, 1:Hold, 2:Out
    let breathInt;
    window.startBreath = function() {
        if(breathInt) { clearInterval(breathInt); breathInt=null; document.getElementById('breath-txt').innerText="STOP"; return; }
        
        const txt = document.getElementById('breath-txt');
        const sub = document.getElementById('breath-sub');
        const circ = document.getElementById('breath-circle');
        
        function cycle() {
            // IN (4s)
            txt.innerText = "TARIK..."; sub.innerText = "Napas dalam (4d)";
            circ.style.transform = "scale(1.2)";
            circ.className = "w-48 h-48 rounded-full border-4 border-green-300 flex items-center justify-center relative transition-all duration-[4000ms] ease-out";
            
            setTimeout(() => {
                // HOLD (4s - simplified from 7)
                txt.innerText = "TAHAN"; sub.innerText = "Rasakan tenang (4d)";
                circ.style.borderColor = "white";
                
                setTimeout(() => {
                    // OUT (4s - simplified from 8)
                    txt.innerText = "HEMBUS..."; sub.innerText = "Lepaskan beban (4d)";
                    circ.style.transform = "scale(1)";
                    circ.className = "w-48 h-48 rounded-full border-4 border-white/30 flex items-center justify-center relative transition-all duration-[4000ms] ease-in";
                }, 4000);
            }, 4000);
        }
        
        cycle();
        breathInt = setInterval(cycle, 12000);
    };

    // E. DETOX
    window.destroyDetox = function() {
        const inp = document.getElementById('detox-inp');
        if(!inp.value) return;
        
        const form = document.getElementById('detox-form');
        const boom = document.getElementById('detox-boom');
        const msg = document.getElementById('detox-msg');
        
        // Shake
        form.classList.add('shake');
        
        setTimeout(() => {
            // Boom
            form.style.opacity = '0';
            form.style.pointerEvents = 'none';
            boom.style.opacity = '1';
            boom.style.transform = 'scale(1.5)';
            boom.style.transition = 'all 0.3s';
            
            setTimeout(() => {
                boom.style.opacity = '0';
                msg.style.opacity = '1';
                msg.style.pointerEvents = 'auto';
                addXP(15);
            }, 500);
        }, 1000);
    };
    window.resetDetox = function() {
        document.getElementById('detox-inp').value = '';
        document.getElementById('detox-form').style.opacity = '1';
        document.getElementById('detox-form').style.pointerEvents = 'auto';
        document.getElementById('detox-form').classList.remove('shake');
        document.getElementById('detox-msg').style.opacity = '0';
        document.getElementById('detox-msg').style.pointerEvents = 'none';
    };

    // F. ZEN TIMER
    let zenTime = 25 * 60;
    let zenInt;
    window.toggleZen = function() {
        const btn = document.getElementById('zen-btn');
        if(zenInt) {
            clearInterval(zenInt); zenInt = null;
            btn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            btn.innerHTML = '<i class="fas fa-pause"></i>';
            zenInt = setInterval(() => {
                zenTime--;
                const m = Math.floor(zenTime / 60).toString().padStart(2,'0');
                const s = (zenTime % 60).toString().padStart(2,'0');
                document.getElementById('zen-time').innerText = `${m}:${s}`;
                if(zenTime <= 0) { clearInterval(zenInt); alert("Selesai!"); addXP(20); }
            }, 1000);
        }
    };
    window.resetZen = function() {
        if(zenInt) clearInterval(zenInt); zenInt=null;
        zenTime = 25 * 60;
        document.getElementById('zen-time').innerText = "25:00";
        document.getElementById('zen-btn').innerHTML = '<i class="fas fa-play"></i>';
    };

    // G. AFFIRMATION
    const affs = [
        "Matematika itu kemampuan yang bisa dilatih, bukan bakat lahir.",
        "Kesalahan adalah bukti aku sedang mencoba hal baru.",
        "Aku tidak harus cepat, aku hanya harus terus maju.",
        "X dan Y hanyalah teka-teki yang menunggu dipecahkan.",
        "Satu soal sehari membuatku makin ahli."
    ];
    window.newAffirmation = function() {
        const txt = document.getElementById('aff-txt');
        if(txt) {
            txt.style.opacity = 0;
            setTimeout(() => {
                txt.innerText = `"${affs[Math.floor(Math.random()*affs.length)]}"`;
                txt.style.opacity = 1;
            }, 300);
        }
    };
    // H. TIME AUDIT LOGIC
    window.updateTimeAudit = function() {
        const s = parseFloat(document.getElementById('inp-study').value);
        const p = parseFloat(document.getElementById('inp-play').value);
        
        // Update Label Angka
        document.getElementById('val-study').innerText = s + 'h';
        document.getElementById('val-play').innerText = p + 'h';
        
        const total = s + p;
        
        // Default jika 0
        if(total === 0) {
            document.getElementById('time-chart').style.background = `conic-gradient(#E6E2D3 0% 100%)`;
            document.getElementById('time-score').innerText = "0%";
            return;
        }
        
        // Hitung Persentase
        const sPct = (s / total) * 100;
        
        // Update Grafik Pie (CSS Conic Gradient)
        // Hijau (#606C38) untuk Belajar, Oranye (#BC6C25) untuk Main
        document.getElementById('time-chart').style.background = `conic-gradient(#606C38 0% ${sPct}%, #BC6C25 ${sPct}% 100%)`;
        
        // Animasi Angka
        document.getElementById('time-score').innerText = Math.round(sPct) + '%';
        
        // Pesan Feedback
        const msg = document.getElementById('time-msg');
        if(s > p) {
            msg.className = "mt-6 p-4 bg-green-100 rounded-xl text-center text-green-800 font-bold border border-green-200 w-full animate-fade-in-up";
            msg.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Mantap! Investasi waktumu produktif. (+5 XP)`;
            if(Math.random() < 0.1) addXP(5); // Bonus XP kecil
        } else if (s === p) {
            msg.className = "mt-6 p-4 bg-blue-100 rounded-xl text-center text-blue-800 font-bold border border-blue-200 w-full animate-fade-in-up";
            msg.innerHTML = `<i class="fas fa-balance-scale mr-2"></i> Seimbang. Work hard, play hard.`;
        } else {
            msg.className = "mt-6 p-4 bg-orange-100 rounded-xl text-center text-orange-800 font-bold border border-orange-200 w-full animate-fade-in-up";
            msg.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Awas! Hiburan terlalu mendominasi.`;
        }
    };

    // --- 14. LOGIKA NATURALIST APPS ---

    // A. PLANT GROW
    window.updatePlant = function(x) {
        // y = 2x + 5
        const y = (2 * x) + 5;
        document.getElementById('plant-x').innerText = x;
        document.getElementById('plant-y').innerText = y;
        
        // Visual Update
        const stem = document.getElementById('plant-stem');
        const h = Math.min(200, y * 5); // Scale visual
        stem.style.height = h + 'px';
        
        // Flower bloom at max
        const flo = document.getElementById('plant-flower');
        if(x >= 9) { flo.style.opacity = 1; flo.classList.add('animate-bounce'); }
        else { flo.style.opacity = 0; flo.classList.remove('animate-bounce'); }
    };

    // B. NATURE CALCULATOR
    window.calcCricket = function() {
        const n = parseFloat(document.getElementById('nat-inp').value);
        if(!n) return;
        // T = 50 + (n-40)/4 (Fahrenheit approx formula)
        // Let's use simpler Celcius logic for students: T_celcius = 10 + (n - 40) / 7
        const t = 10 + (n - 40) / 7;
        const res = document.getElementById('nat-res');
        res.innerText = `Suhu Sekitar: ¬±${t.toFixed(1)}¬∞C`;
        res.style.opacity = 1;
        addXP(5);
    };
    window.calcCarbon = function() {
        const dist = parseFloat(document.getElementById('nat-inp').value) || 0;
        const elec = parseFloat(document.getElementById('nat-inp2').value) || 0;
        // Dummy formula: 0.2kg per km + 0.5kg per kWh
        const total = (dist * 0.2) + (elec * 0.5);
        const res = document.getElementById('nat-res');
        res.innerText = `Jejak Karbon: ${total.toFixed(1)} kg CO‚ÇÇ`;
        res.style.opacity = 1;
        addXP(5);
    };

    // C. RIVER (CANVAS)
    window.drawRiver = function(slope) {
        const cv = document.getElementById('cv-river');
        if(!cv) return;
        const ctx = cv.getContext('2d');
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        const w=cv.width, h=cv.height;

        ctx.clearRect(0,0,w,h);

        // Tanah (Segitiga miring)
        ctx.fillStyle = '#5D4037';
        ctx.beginPath();
        ctx.moveTo(0, h);
        const startY = h - (slope * 5); // Semakin besar slope, semakin tinggi titik awal
        ctx.lineTo(0, startY);
        ctx.lineTo(w, h);
        ctx.fill();

        // Air
        ctx.strokeStyle = '#4FC3F7';
        ctx.lineWidth = 10;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(0, startY);
        ctx.lineTo(w, h);
        ctx.stroke();

        // Teks Speed
        const spd = document.getElementById('river-speed');
        if(slope < 10) spd.innerText = "Aliran: Lambat (Arus Tenang)";
        else if(slope < 30) spd.innerText = "Aliran: Sedang (Ideal)";
        else spd.innerText = "Aliran: Cepat (Air Terjun!)";
    };

    // D. BACTERIA (EXPONENTIAL)
    let bacGen = 0;
    window.splitBacteria = function() {
        if(bacGen >= 6) { alert("Petri Dish Penuh! Reset."); bacGen=0; document.getElementById('petri-dish').innerHTML='<div class="bacteria w-4 h-4 bg-green-400 rounded-full absolute shadow-[0_0_10px_#4ade80]" style="top:50%; left:50%"></div>'; }
        
        bacGen++;
        const count = Math.pow(2, bacGen);
        document.getElementById('bac-gen').innerText = bacGen;
        document.getElementById('bac-count').innerText = count;

        const dish = document.getElementById('petri-dish');
        // Tambah visual bakteri
        // Kita tambah sejumlah (count - count_prev) bakteri baru
        const newBac = count - Math.pow(2, bacGen-1);
        
        for(let i=0; i<newBac; i++) {
            const b = document.createElement('div');
            b.className = "bacteria w-3 h-3 bg-green-400 rounded-full absolute shadow-[0_0_5px_#4ade80] transition transform scale-0";
            // Random pos
            const r = (Math.random() * 80) + 10;
            const theta = Math.random() * 360;
            b.style.top = (Math.random() * 80 + 10) + '%';
            b.style.left = (Math.random() * 80 + 10) + '%';
            dish.appendChild(b);
            
            setTimeout(() => b.style.transform = "scale(1)", 50);
        }
        addXP(2);
    };

    // --- 15. LOGIKA NATURALIST APPS ---

    // A. PLANT GROW
    window.growPlant = function(val) {
        const h = 50 + (val * 20); // Base height + growth
        const stem = document.getElementById('plant-root');
        const flower = document.getElementById('plant-flower');
        
        stem.style.height = h + 'px';
        document.getElementById('p-x-val').innerText = val + " L";
        document.getElementById('p-y-val').innerText = (parseInt(val)*2 + 5);

        if(val >= 8) {
            flower.style.transform = "scale(1)";
            unlockBadge('ranger');
            addXP(1);
        } else {
            flower.style.transform = "scale(0)";
        }
    };

    // B. CRICKET
    window.calcCricket = function(n) {
        // T = 10 + (n - 40) / 7
        const t = 10 + (n - 40) / 7;
        document.getElementById('crick-res').innerText = Math.round(t) + "¬∞C";
        
        // Animasi ikon jangkrik makin cepat jika n tinggi
        const dur = 100 / n; 
        document.getElementById('cricket-icon').style.animationDuration = dur + "s";
    };

    // C. CARBON
    window.calcCarbon = function() {
        const km = document.getElementById('c-km').innerText = document.querySelector('input[oninput="calcCarbon()"]').value;
        const tree = document.getElementById('c-tree').innerText = document.querySelectorAll('input[oninput="calcCarbon()"]')[1].value;
        
        // Emisi: 0.2kg per km. Serap: 1kg per pohon
        const emit = km * 0.2;
        const absorb = tree * 1;
        const res = document.getElementById('carb-res');
        const st = document.getElementById('carb-status');
        const icon1 = document.getElementById('carb-icon');
        const icon2 = document.getElementById('tree-icon');

        if(absorb > emit) {
            res.innerText = "Positif! (Udara Bersih)";
            st.className = "p-4 rounded-xl text-center bg-green-100 text-green-800";
            icon2.style.transform = "scale(1.2)"; icon1.style.transform = "scale(0.8)";
        } else if (absorb < emit) {
            res.innerText = "Negatif! (Polusi)";
            st.className = "p-4 rounded-xl text-center bg-gray-200 text-gray-800";
            icon1.style.transform = "scale(1.2)"; icon2.style.transform = "scale(0.8)";
        } else {
            res.innerText = "Netral (Seimbang)";
            st.className = "p-4 rounded-xl text-center bg-blue-100 text-blue-800";
            icon1.style.transform = "scale(1)"; icon2.style.transform = "scale(1)";
        }
    };

    // D. RIVER (CANVAS)
    window.drawRiver = function(slope) {
        const cv = document.getElementById('cv-river');
        if(!cv) return;
        const ctx = cv.getContext('2d');
        const w = cv.width = cv.parentElement.clientWidth;
        const h = cv.height = cv.parentElement.clientHeight;

        ctx.clearRect(0,0,w,h);
        
        // Langit
        const grad = ctx.createLinearGradient(0,0,0,h);
        grad.addColorStop(0, '#81D4FA');
        grad.addColorStop(1, '#B3E5FC');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,w,h);

        // Gunung (Miring sesuai slope)
        ctx.fillStyle = '#5D4037';
        ctx.beginPath();
        const startY = h/2 - (slope * 2); 
        ctx.moveTo(0, h);
        ctx.lineTo(0, startY); // Titik kiri atas gunung
        ctx.lineTo(w, h);      // Titik kanan bawah
        ctx.fill();

        // Air Sungai
        ctx.strokeStyle = '#29B6F6';
        ctx.lineWidth = 15;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(0, startY + 10);
        // Bezier curve untuk efek air
        ctx.quadraticCurveTo(w/2, h - 20, w, h + 10);
        ctx.stroke();

        // Buih air (Particles) - Static representation
        ctx.fillStyle = 'white';
        for(let i=0; i<slope; i++) {
            const rx = Math.random() * w;
            const ry = h - (Math.random() * 50);
            ctx.beginPath(); ctx.arc(rx, ry, 2, 0, Math.PI*2); ctx.fill();
        }
    };
    window.addRock = function(e) {
        // Efek visual klik (splash)
        const el = document.createElement('div');
        el.className = 'absolute text-xl animate-ping pointer-events-none';
        el.innerHTML = 'ü™®';
        el.style.left = e.offsetX + 'px';
        el.style.top = e.offsetY + 'px';
        e.target.parentElement.appendChild(el);
        setTimeout(()=>el.remove(), 500);
    };

    // E. LEAF MACHINE
    window.calcLeaf = function() {
        const l = parseInt(document.getElementById('in-light').value)||0;
        const w = parseInt(document.getElementById('in-water').value)||0;
        const sugar = (2 * l) + w;
        document.getElementById('out-sugar').innerText = sugar;
        if(sugar > 20) addXP(1);
    };

    // F. FOOD CHAIN
    window.updateEco = function(type, val) {
        // Logic: Rumput naik -> Rusa naik -> Serigala naik
        // Rumus Rusa = 0.8 * Rumput
        // Rumus Serigala = 0.5 * Rusa
        
        const deerH = val * 0.8;
        const wolfH = deerH * 0.5;

        document.getElementById('bar-deer').style.height = deerH + '%';
        document.getElementById('bar-wolf').style.height = wolfH + '%';

        const msg = document.getElementById('eco-msg');
        if(val < 20) msg.innerText = "Bahaya! Kelaparan massal.";
        else if(val > 80) msg.innerText = "Hutan rimbun, semua kenyang!";
        else msg.innerText = "Ekosistem Seimbang.";
    };

    // G. BACTERIA
    let bacN = 0;
    window.splitBacteria = function() {
        if(bacN > 8) {
            // Reset
            bacN = 0;
            document.getElementById('petri-dish').innerHTML = '<div class="bacteria w-4 h-4 bg-green-500 rounded-full absolute top-1/2 left-1/2 -ml-2 -mt-2 shadow-[0_0_10px_#4ade80] animate-pulse"></div><div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition hover:opacity-100"><span class="text-white/80 font-bold bg-black/50 px-2 py-1 rounded">Klik untuk Belah</span></div>';
        } else {
            bacN++;
            const total = Math.pow(2, bacN);
            // Tambah bakteri baru (visual)
            const parent = document.getElementById('petri-dish');
            const currentCount = parent.querySelectorAll('.bacteria').length;
            const needed = total - currentCount;
            
            for(let i=0; i<needed; i++) {
                const b = document.createElement('div');
                b.className = 'bacteria w-3 h-3 bg-green-400 rounded-full absolute shadow-[0_0_5px_#4ade80] transition transform scale-0';
                b.style.top = (Math.random()*80 + 10) + '%';
                b.style.left = (Math.random()*80 + 10) + '%';
                parent.appendChild(b);
                setTimeout(()=>b.style.transform="scale(1)", 50);
            }
        }
        document.getElementById('bac-n').innerText = bacN;
        document.getElementById('bac-total').innerText = Math.pow(2, bacN);
    };

    // H. BIRD NAV
    window.initBirdMap = function() {
        const cv = document.getElementById('cv-bird');
        if(!cv) return;
        const ctx = cv.getContext('2d');
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        
        // Draw Grid
        ctx.strokeStyle = '#BFDBFE';
        ctx.lineWidth = 1;
        const step = 40;
        for(let x=0; x<cv.width; x+=step) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cv.height); ctx.stroke(); }
        for(let y=0; y<cv.height; y+=step) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cv.width,y); ctx.stroke(); }

        // Start Point A
        ctx.fillStyle = '#EF4444'; ctx.beginPath(); ctx.arc(40, cv.height-40, 5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#1E3A8A'; ctx.font='12px bold sans-serif'; ctx.fillText("A (Home)", 50, cv.height-40);
    };
    window.moveBird = function(e) {
        const cv = document.getElementById('cv-bird');
        const ctx = cv.getContext('2d');
        const rect = cv.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Draw Line from Home
        initBirdMap(); // Clear old lines
        ctx.beginPath();
        ctx.moveTo(40, cv.height-40);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#2563EB'; ctx.lineWidth=2; ctx.setLineDash([5,5]);
        ctx.stroke();

        // Draw Bird
        ctx.font = '20px serif'; ctx.fillText('üïäÔ∏è', x-10, y);
        
        // Update Coor text (Map canvas pixels to Cartesian approx)
        const mapX = Math.round((x - 40) / 40);
        const mapY = Math.round((cv.height - 40 - y) / 40);
        document.getElementById('bird-coor').innerText = `(${mapX}, ${mapY})`;
    };

    // I. QUAKE DATA
    window.genQuake = function() {
        const map = document.getElementById('quake-map');
        if(!map) return;
        // Clear old dots (keep grid bg)
        map.innerHTML = '<div class="absolute inset-0" style="background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px); background-size: 20px 20px;"></div>';
        
        // Generate 20 points
        for(let i=0; i<20; i++) {
            const dot = document.createElement('div');
            // Random Pos
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            // Logic: Dekat pusat (0,0) = Besar (Kuat). Jauh = Kecil.
            // Distance from bottom-left (0, 100% top)
            // Let's say epicenter is bottom left (0,0 in math terms)
            const dist = Math.sqrt(x*x + y*y);
            const size = Math.max(5, 30 - (dist * 0.2)); // Max 30px
            const color = size > 20 ? 'bg-red-500' : (size > 10 ? 'bg-orange-400' : 'bg-yellow-300');

            dot.className = `absolute rounded-full opacity-70 border border-white shadow-sm ${color} transition transform scale-0`;
            dot.style.left = x + '%';
            dot.style.bottom = y + '%';
            dot.style.width = size + 'px';
            dot.style.height = size + 'px';
            
            map.appendChild(dot);
            setTimeout(() => dot.style.transform = "scale(1)", i*50);
        }
    };
    
    // --- 16. LOGIKA CLOSING / CELEBRATION ---
    window.showClosing = function() {
        // 1. Update Data di Layar
        document.getElementById('close-name').innerText = userProfile.name || 'Sobat';
        document.getElementById('close-xp').innerText = userProfile.xp;
        document.getElementById('close-badge').innerText = userProfile.badges.length;

        // 2. Random Quotes Lucu/Bijak
        const quotes = [
            "Otakmu hari ini makin 'berotot' üí™!",
            "Istirahatlah, kamu sudah hebat hari ini! üåü",
            "Matematika takluk di tanganmu! üòé",
            "Simpan energimu, besok kita petualang lagi! üöÄ",
            "Rumus hari ini: Kamu + Belajar = Sukses! ‚ú®"
        ];
        document.getElementById('close-quote').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

        // 3. Tampilkan Overlay dengan Animasi
        const overlay = document.getElementById('closing-overlay');
        overlay.classList.remove('hidden');
        // Delay sedikit agar transisi opacity jalan halus
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);

        // 4. Mainkan Efek Confetti (Hujan Kertas Warna-Warni)
        playSuperConfetti();
        
        // 5. Mainkan Suara (Opsional jika audio context aktif)
        if(window.playNote) {
            playNote(0, 'piano'); setTimeout(()=>playNote(4, 'piano'), 200); setTimeout(()=>playNote(7, 'piano'), 400);
        }
    };

    function playSuperConfetti() {
        // Tembakan kiri
        confetti({
            particleCount: 100, spread: 70, origin: { x: 0.1, y: 0.6 },
            colors: ['#606C38', '#BC6C25', '#DDA15E']
        });
        // Tembakan kanan
        setTimeout(() => {
            confetti({
                particleCount: 100, spread: 70, origin: { x: 0.9, y: 0.6 },
                colors: ['#283618', '#FEFAE0', '#DDA15E']
            });
        }, 300);
        // Hujan dari atas
        setTimeout(() => {
            confetti({
                particleCount: 150, spread: 100, origin: { y: 0 }, gravity: 1.5,
                scalar: 1.2
            });
        }, 800);
    }

    // --- 17. LOGIKA TIM PENGEMBANG ---
    window.openTeam = function() {
        const el = document.getElementById('team-modal');
        el.classList.remove('hidden');
        // Delay sedikit agar animasi opacity berjalan halus
        setTimeout(() => el.classList.remove('opacity-0'), 10);
    };

    window.closeTeam = function() {
        const el = document.getElementById('team-modal');
        el.classList.add('opacity-0');
        // Tunggu animasi selesai baru hidden
        setTimeout(() => el.classList.add('hidden'), 500);
    };

    // --- LOGIKA MENU MOBILE ---
    function toggleSidebar() {
        const sb = document.getElementById('main-sidebar');
        // Cek apakah sidebar sedang sembunyi (memiliki class -translate-x-full)
        if (sb.classList.contains('-translate-x-full')) {
            // Buka Sidebar
            sb.classList.remove('-translate-x-full');
        } else {
            // Tutup Sidebar
            sb.classList.add('-translate-x-full');
        }
    }

    // Tutup sidebar otomatis saat menu diklik (khusus mobile)
    document.addEventListener('click', (e) => {
        const sb = document.getElementById('main-sidebar');
        const btn = document.querySelector('button[onclick="toggleSidebar()"]');
        
        // Jika layar kecil (Mobile) DAN klik terjadi di luar sidebar/tombol
        if (window.innerWidth < 768 && !sb.contains(e.target) && !btn.contains(e.target)) {
            sb.classList.add('-translate-x-full');
        }
    });

    // --- 5. PROFILE & AI ---
    window.openProfile = function() {
        updateProfileUI(); genAI(); document.getElementById('profile-modal').classList.remove('hidden');
    }
    function updateProfileUI() {
        document.getElementById('profile-name').innerText = userProfile.name || 'Tamu';
        document.getElementById('streak-count').innerText = userProfile.streak;
        document.getElementById('xp-count').innerText = userProfile.xp;

        // --- DAFTAR 16 BADGES BARU ---
        const badges = [
            // UMUM
            { id: 'explorer', n: 'Penjelajah', i: 'fa-compass', desc: 'Membuka 5 menu berbeda' },
            { id: 'quiz_master', n: 'Master Kuis', i: 'fa-crown', desc: 'Benar 10 soal kuis' },
            { id: 'streak_3', n: 'Konsisten', i: 'fa-fire', desc: 'Login 3 hari berturut-turut' },
            { id: 'xp_500', n: 'Veteran', i: 'fa-star', desc: 'Mencapai 500 XP' },

            // PER KECERDASAN
            { id: 'linguist', n: 'Pujangga', i: 'fa-feather-alt', desc: 'Menulis Pantun/Cerita' }, // Linguistic
            { id: 'logician', n: 'Detektif', i: 'fa-search', desc: 'Memecahkan Pola/Kode' }, // Logical
            { id: 'visualizer', n: 'Visioner', i: 'fa-eye', desc: 'Menggambar Grafik/Peta' }, // Spatial
            { id: 'athlete', n: 'Atlet Math', i: 'fa-running', desc: 'Memainkan Game Lari/Lompat' }, // Kinesthetic
            
            { id: 'maestro', n: 'Komposer', i: 'fa-music', desc: 'Membuat Musik/Beat' }, // Musical
            { id: 'socialite', n: 'Mediator', i: 'fa-users', desc: 'Simulasi Debat/Pasar' }, // Interpersonal
            { id: 'philosopher', n: 'Reflektif', i: 'fa-user-astronaut', desc: 'Mengisi Jurnal/Meditasi' }, // Intrapersonal
            { id: 'ranger', n: 'Penjaga Alam', i: 'fa-leaf', desc: 'Simulasi Karbon/Tanaman' }, // Naturalist

            // SPESIAL GAME
            { id: 'builder', n: 'Arsitek', i: 'fa-cubes', desc: 'Menyusun Aljabar Tiles' },
            { id: 'racer', n: 'Pembalap', i: 'fa-flag-checkered', desc: 'Main Gradient Racer' },
            { id: 'sniper', n: 'Jitu', i: 'fa-bullseye', desc: 'Menembak di Meriam Linear' },
            { id: 'money_maker', n: 'Ekonom', i: 'fa-wallet', desc: 'Menghitung Anggaran/Kasir' }
        ];

        // RENDER BADGES
        document.getElementById('badge-container').innerHTML = badges.map(b => {
            const un = userProfile.badges.includes(b.id);
            // Style: Jika unlocked (berwarna), jika locked (abu-abu/transparan)
            const style = un ? 
                'bg-gradient-to-br from-yellow-100 to-yellow-300 text-yellow-800 border-yellow-400 shadow-md transform hover:scale-105' : 
                'bg-gray-100 text-gray-400 border-gray-200 grayscale opacity-60';
            
            const iconColor = un ? 'text-yellow-700' : 'text-gray-400';

            return `
            <div class="flex flex-col items-center text-center p-2 rounded-xl border ${style} transition-all duration-300 group relative cursor-help" title="${b.desc}">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl mb-1 bg-white/50 ${iconColor}">
                    <i class="fas ${b.i}"></i>
                </div>
                <span class="text-[9px] font-bold uppercase tracking-wider">${b.n}</span>
                ${un ? '<div class="absolute -top-1 -right-1 text-green-500 bg-white rounded-full text-xs shadow-sm"><i class="fas fa-check-circle"></i></div>' : ''}
                
                <div class="absolute bottom-full mb-2 w-32 bg-black/80 text-white text-[10px] p-2 rounded-lg opacity-0 group-hover:opacity-100 pointer-events-none transition z-50">
                    ${un ? 'Tercapai!' : 'Syarat: ' + b.desc}
                </div>
            </div>`;
        }).join('');
    }
    // --- 18. LOGIKA AI CHART (CHART.JS) ---
    let aiChartInstance = null; // Variabel global untuk menyimpan grafik

    function genAI() {
        const visited = userProfile.progress.modulesVisited || {};
        const time = userProfile.progress.timePerType || {}; // (Jika Anda melacak waktu)
        
        // 1. HITUNG SKOR UNTUK SETIAP KECERDASAN
        // Skor = (Jumlah Klik Modul * 10) + (Bonus Aktivitas Lain)
        // Kita mapping data agar urutannya sesuai dengan intelligenceData
        const scores = intelligenceData.map(item => {
            const v = visited[item.id] || 0;
            // Kita beri nilai minimal 2 agar grafik tidak kosong melompong
            return Math.max(2, v * 10); 
        });

        const labels = intelligenceData.map(item => item.name.split(' ')[0]); // Ambil nama depan saja (misal: "Verbal" dari "Verbal Linguistic")

        // 2. ANALISIS TEKS (DOMINAN)
        let maxScore = 0;
        let dominantId = '';
        intelligenceData.forEach((item, idx) => {
            if (scores[idx] > maxScore) {
                maxScore = scores[idx];
                dominantId = item.id;
            }
        });

        const el = document.getElementById('ai-feedback-text');
        if (maxScore <= 20) {
            el.innerHTML = `<i class="fas fa-info-circle"></i> Data belum cukup. Jelajahi lebih banyak modul untuk melihat potensimu!`;
        } else {
            const insights = {
                linguistic: "Kamu <b>Si Ahli Bahasa</b>! Kamu memahami Aljabar paling cepat lewat cerita dan analogi kata.",
                logical: "Kamu <b>Detektif Logika</b>! Pola angka dan analisis rumus adalah kekuatan utamamu.",
                spatial: "Kamu <b>Visioner</b>! Grafik dan visualisasi membantu otakmu memproses info dengan cepat.",
                kinesthetic: "Kamu <b>Praktisi</b>! Belajar sambil bergerak/menyentuh alat peraga adalah kuncinya.",
                musical: "Kamu <b>Harmonis</b>! Pola irama dan frekuensi membantumu mengingat rumus.",
                interpersonal: "Kamu <b>Mediator</b>! Diskusi dan studi kasus sosial membuatmu lebih paham.",
                intrapersonal: "Kamu <b>Reflektif</b>! Kamu butuh ketenangan untuk merenung dan mengevaluasi diri.",
                naturalist: "Kamu <b>Penjelajah Alam</b>! Menghubungkan rumus dengan fenomena alam sangat efektif bagimu."
            };
            el.innerHTML = insights[dominantId] || "Teruslah bereksplorasi untuk menemukan gayamu!";
        }

        // 3. RENDER GRAFIK RADAR
        const ctx = document.getElementById('ai-radar-chart').getContext('2d');

        // Hancurkan grafik lama jika ada (agar tidak menumpuk/glitch)
        if (aiChartInstance) {
            aiChartInstance.destroy();
        }

        aiChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Potensi Diri',
                    data: scores,
                    backgroundColor: 'rgba(96, 108, 56, 0.5)', // Warna Earth-600 transparan
                    borderColor: '#606C38',
                    pointBackgroundColor: '#BC6C25', // Accent Orange
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#BC6C25',
                    borderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        angleLines: { color: 'rgba(0,0,0,0.1)' },
                        grid: { color: 'rgba(94, 73, 52, 0.1)' }, // Garis jaring tipis
                        pointLabels: {
                            font: { family: '"Plus Jakarta Sans", sans-serif', size: 11, weight: 'bold' },
                            color: '#5E4934' // Warna Earth-800
                        },
                        ticks: { display: false, stepSize: 20 } // Sembunyikan angka skala agar bersih
                    }
                },
                plugins: {
                    legend: { display: false }, // Sembunyikan legenda
                    tooltip: {
                        backgroundColor: '#283618',
                        titleFont: { family: 'serif' },
                        callbacks: {
                            label: function(context) {
                                return `Skor Aktivitas: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
    window.nextSlide = function(n) { document.querySelectorAll('.story-slide').forEach(e=>e.classList.remove('active')); document.getElementById(`slide-${n}`).classList.add('active'); };
    window.startApp = function() { document.getElementById('linguistic').scrollIntoView({behavior:'smooth'}); };

    // --- 9. AUDIO ENGINE (MUSICAL INTELLIGENCE) ---
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx, osc, gainNode;

    function initAudio() {
        if(!audioCtx) {
            audioCtx = new AudioCtx();
            // Master Gain (Volume)
            gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.1; // Low volume default
            gainNode.connect(audioCtx.destination);
        }
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    // A. PIANO
    window.playNote = function(idx, type) {
        initAudio();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        
        // Logika Nada
        let freq = 261.63; // C4
        if(type === 'piano') {
            // f(x) = x + 2 (Contoh sederhana: geser 2 semitone)
            // Rumus frekuensi nada: f = f0 * (2)^(n/12)
            let n = idx + 2; 
            freq = 261.63 * Math.pow(2, n/12);
        } else if(type === 'piano_fib') {
            // Hanya bunyi jika idx adalah angka Fibonacci? (Visual saja mungkin lebih mudah)
            const fib = [0, 1, 1, 2, 3, 5, 8, 13];
            if(fib.includes(idx)) freq = 261.63 * Math.pow(2, idx/12);
            else { freq = 100; g.gain.value = 0.05; } // Nada 'salah' (buzz)
        }

        o.frequency.value = freq;
        o.type = 'triangle';
        
        // Envelope (ADSR simple)
        g.gain.setValueAtTime(0, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
        
        o.start(); o.stop(audioCtx.currentTime + 0.5);
    };

    // B. GRAPH SOUND
    let gsPoints = [];
    window.initGs = function() {
        const cv = document.getElementById('cv-gs');
        if(!cv) return;
        const ctx = cv.getContext('2d');
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        
        let isDrawing = false;
        cv.onmousedown = e => { isDrawing=true; gsPoints=[]; };
        cv.onmouseup = () => isDrawing=false;
        cv.onmousemove = e => {
            if(!isDrawing) return;
            const rect = cv.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            gsPoints.push({x, y});
            
            // Draw
            ctx.fillStyle = '#606C38';
            ctx.fillRect(x, y, 3, 3);
        };
    };
    window.clearGs = function() {
        const cv = document.getElementById('cv-gs');
        cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
        gsPoints = [];
    };
    window.playGs = function() {
        if(gsPoints.length === 0) return alert("Gambar dulu grafiknya!");
        initAudio();
        // Urutkan point berdasarkan X (Waktu)
        gsPoints.sort((a,b) => a.x - b.x);
        
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'sine';
        
        const now = audioCtx.currentTime;
        const duration = 2; // 2 detik durasi total
        const maxH = document.getElementById('cv-gs').height;
        
        g.gain.setValueAtTime(0.2, now);
        
        gsPoints.forEach(p => {
            // Map X ke Waktu, Y ke Frekuensi (Y makin kecil = Posisi makin atas = Frekuensi Tinggi)
            const time = now + (p.x / document.getElementById('cv-gs').width) * duration;
            // Y terbalik di canvas (0 di atas)
            const normY = 1 - (p.y / maxH); 
            const freq = 200 + (normY * 800); // Range 200Hz - 1000Hz
            
            o.frequency.linearRampToValueAtTime(freq, time);
        });
        
        g.gain.linearRampToValueAtTime(0, now + duration);
        o.start(now); o.stop(now + duration);
    };

    // C. SEQUENCER
    window.toggleStep = function(el) {
        const active = el.dataset.active === 'true';
        el.dataset.active = !active;
        el.querySelector('.indicator').style.opacity = !active ? '1' : '0';
        el.querySelector('.indicator').style.transform = !active ? 'scale(1)' : 'scale(0)';
    };
    let seqInterval;
    window.toggleSeq = function() {
        const btn = document.getElementById('btn-seq');
        if(seqInterval) {
            clearInterval(seqInterval); seqInterval=null;
            btn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            unlockBadge('maestro');
            initAudio();
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            let step = 0;
            const steps = document.querySelectorAll('.seq-step');
            seqInterval = setInterval(() => {
                // Visual Highlight
                steps.forEach(s => s.style.borderColor = '#606C38');
                // Check Row 1 (0-7) and Row 2 (8-15)
                const s1 = steps[step];
                const s2 = steps[step+8];
                
                s1.style.borderColor = 'white';
                s2.style.borderColor = 'white';
                
                // Play Sound
                if(s1.dataset.active === 'true') playDrum(800, 'square'); // Hi-hatish
                if(s2.dataset.active === 'true') playDrum(150, 'sine');   // Kickish
                
                step = (step + 1) % 8;
            }, 250); // Tempo
        }
    };
    function playDrum(f, type) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = f; o.type = type;
        g.gain.setValueAtTime(0.5, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    // D. CONDUCTOR
    let condOsc, condGain;
    window.startCond = function() {
        initAudio();
        condOsc = audioCtx.createOscillator();
        condGain = audioCtx.createGain();
        condOsc.connect(condGain); condGain.connect(audioCtx.destination);
        condOsc.start();
        condGain.gain.value = 0;
    };
    window.stopCond = function() {
        if(condOsc) { condOsc.stop(); condOsc = null; }
    };
    window.updateConductor = function(e) {
        if(!condOsc) return;
        const y = e.offsetY;
        const h = e.target.closest('.rounded-3xl').clientHeight; // approximate height
        const freq = 1000 - (y/h * 800);
        condOsc.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.1);
        condGain.gain.setTargetAtTime(0.3, audioCtx.currentTime, 0.1);
    };

    // E. METRONOME
    let metroInt;
    window.updateMetro = function(val) {
        document.getElementById('metro-val').innerText = val;
        if(metroInt) clearInterval(metroInt);
        const ms = 60000 / val;
        const needle = document.getElementById('metro-needle');
        let tick = false;
        metroInt = setInterval(() => {
            playDrum(1000, 'triangle'); // Tick sound
            if(needle) needle.style.transform = tick ? 'translateX(-50%) rotate(30deg)' : 'translateX(-50%) rotate(-30deg)';
            tick = !tick;
        }, ms);
    };

    // --- LOGIKA KONSTRUKTOR TILES (DRAG & DROP) ---
    
    // 1. Fungsi Utama (Dipanggil saat modal buka)
    window.initTiles = function() {
        const canvas = document.getElementById('tile-canvas');
        if(!canvas) return;

        // Izinkan Drop
        canvas.addEventListener('dragover', e => e.preventDefault());

        // Handle Drop (Saat balok dilepas)
        canvas.addEventListener('drop', e => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            if(!type) return;

            // Buat Element Baru
            const el = document.createElement('div');
            
            // Styling sesuai tipe
            const styles = {
                'x2': 'w-16 h-16 bg-blue-500 border-2 border-blue-600 text-white',
                'x':  'w-8 h-16 bg-green-500 border-2 border-green-600 text-white',
                '1':  'w-8 h-8 bg-yellow-400 border-2 border-yellow-500 text-yellow-900'
            };
            const labels = {'x2': 'x¬≤', 'x': 'x', '1': '1'};

            el.className = `${styles[type]} absolute shadow-md flex items-center justify-center font-bold select-none cursor-move rounded transition-transform active:scale-105 z-10`;
            el.innerText = labels[type];
            
            // Posisi Jatuh (Relatif terhadap Canvas)
            const rect = canvas.getBoundingClientRect();
            // Pusatkan kursor
            const offsetX = (type === 'x2' ? 32 : 16);
            const offsetY = (type === 'x' || type === 'x2' ? 32 : 16);
            
            let x = e.clientX - rect.left - offsetX;
            let y = e.clientY - rect.top - offsetY;

            el.style.left = x + 'px';
            el.style.top = y + 'px';

            // FITUR: Geser Balok yang sudah ada
            el.onmousedown = function(ev) {
                ev.stopPropagation(); // Jangan trigger event lain
                this.style.zIndex = 50; // Bawa ke depan
                
                const shiftX = ev.clientX - this.getBoundingClientRect().left;
                const shiftY = ev.clientY - this.getBoundingClientRect().top;

                function moveAt(pageX, pageY) {
                    let newX = pageX - shiftX - rect.left;
                    let newY = pageY - shiftY - rect.top;
                    
                    // Batas Canvas (Optional)
                    // newX = Math.max(0, Math.min(newX, rect.width - el.offsetWidth));
                    // newY = Math.max(0, Math.min(newY, rect.height - el.offsetHeight));

                    el.style.left = newX + 'px';
                    el.style.top = newY + 'px';
                }

                function onMouseMove(event) {
                    moveAt(event.clientX, event.clientY);
                }

                document.addEventListener('mousemove', onMouseMove);

                document.onmouseup = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    el.style.zIndex = 10;
                    document.onmouseup = null;
                };
            };

            // FITUR: Hapus Balok (Double Click)
            el.ondblclick = function() {
                this.classList.add('scale-0', 'opacity-0');
                setTimeout(() => this.remove(), 200);
            };

            canvas.appendChild(el);
            unlockBadge('builder');
            addXP(1); // Reward kecil
        });
    };

    // 2. Helper untuk memulai Drag dari Palette
    window.ddStartTile = function(e, type) {
        e.dataTransfer.setData('type', type);
    };
    
    // --- 6. LOGIKA LAB TIMBANGAN (PHYSICS) ---
    let balState = { Lx:0, L1:0, Rx:0, R1:0, xVal:0, hex:'' };

    window.initBalance = function(hex) {
        // Tentukan nilai x misterius (antara 2 sampai 6)
        const randX = Math.floor(Math.random() * 5) + 2;
        balState = { Lx:0, L1:0, Rx:0, R1:0, xVal: randX, hex: hex || balState.hex };
        
        drawBalance();
        updateBalUI();
        document.getElementById('bal-msg').classList.add('hidden');
        document.getElementById('bal-msg').classList.remove('scale-100');
        document.getElementById('x-reveal').style.opacity = 0;
    };

    window.updateBal = function(side, type, diff) {
        const key = side + type;
        // Mencegah nilai negatif
        if(balState[key] + diff >= 0) {
            balState[key] += diff;
            // Animasi kecil saat tombol ditekan
            drawBalance();
            updateBalUI();
        }
    };

    window.updateBalUI = function() {
        // Update teks persamaan matematika
        const format = (x, c) => {
            if(x===0 && c===0) return "0";
            let s = "";
            if(x > 0) s += (x===1 ? "x" : x+"x");
            if(x > 0 && c > 0) s += " + ";
            if(c > 0) s += c;
            return s;
        };
        document.getElementById('txt-L').innerText = format(balState.Lx, balState.L1);
        document.getElementById('txt-R').innerText = format(balState.Rx, balState.R1);
    };

    window.drawBalance = function() {
        const cv = document.getElementById('cv-balance');
        if(!cv) return;
        const ctx = cv.getContext('2d');
        
        // Resize canvas agar tajam
        const rect = cv.parentElement.getBoundingClientRect();
        cv.width = rect.width;
        cv.height = rect.height;
        
        const w = cv.width, h = cv.height;
        const cx = w/2, cy = h/2; // Titik pusat pivot

        // --- 1. HITUNG FISIKA (TILT/KEMIRINGAN) ---
        const totalL = (balState.Lx * balState.xVal) + balState.L1;
        const totalR = (balState.Rx * balState.xVal) + balState.R1;
        
        // Hitung sudut kemiringan (max 20 derajat atau 0.35 radian)
        // Jika Kanan lebih berat, sudut Positif (searah jarum jam)
        // Jika Kiri lebih berat, sudut Negatif (lawan jarum jam)
        let diff = totalR - totalL; 
        let angle = diff * 0.05; 
        angle = Math.max(-0.35, Math.min(0.35, angle)); // Clamp limit

        // Cek Kemenangan
        const msg = document.getElementById('bal-msg');
        const reveal = document.getElementById('x-reveal');
        if(totalL === totalR && totalL > 0) {
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('scale-100'), 50); // Animasi pop
            msg.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> <span>Seimbang! (x = ${balState.xVal})</span>`;
            reveal.innerText = `Karena seimbang, maka nilai x terbukti adalah ${balState.xVal}`;
            reveal.style.opacity = 1;
            // Rayakan hanya jika baru pertama kali seimbang di sesi ini
            if(!balState.won) { addXP(10); confetti({particleCount: 50, spread: 60, origin: {y: 0.5}}); balState.won = true; }
        } else {
            msg.classList.add('hidden');
            msg.classList.remove('scale-100');
            reveal.style.opacity = 0;
            balState.won = false;
        }

        // --- 2. GAMBAR TIMBANGAN ---
        ctx.clearRect(0,0,w,h);

        // A. Gambar Tiang (Base)
        ctx.fillStyle = balState.hex || '#5E4934';
        ctx.beginPath();
        ctx.moveTo(cx, cy); 
        ctx.lineTo(cx - 15, h - 20); 
        ctx.lineTo(cx + 15, h - 20); 
        ctx.fill();
        // Alas bawah
        ctx.beginPath(); 
        ctx.roundRect(cx - 40, h - 25, 80, 10, 5);
        ctx.fill();

        // B. Gambar Lengan (Beam) - ROTASI DIMULAI
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);

        // Batang Lengan
        ctx.fillStyle = '#8C7B5D';
        ctx.strokeStyle = '#5E4934';
        ctx.lineWidth = 2;
        const beamLen = w * 0.35; // Panjang setengah lengan
        ctx.beginPath();
        ctx.roundRect(-beamLen, -5, beamLen * 2, 10, 5);
        ctx.fill(); ctx.stroke();

        // Titik Pivot
        ctx.fillStyle = '#FDFCF5';
        ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI*2); ctx.fill();

        // --- 3. GAMBAR PAN (PIRINGAN) ---
        // Fungsi helper gambar piringan
        const drawPan = (xPos, countX, count1) => {
            ctx.save();
            ctx.translate(xPos, 0); // Pindah ke ujung lengan
            ctx.rotate(-angle); // ROTASI BALIK agar piringan tetap tegak lurus gravitasi!
            
            // Tali
            ctx.strokeStyle = '#B09E80';
            ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, 80); ctx.stroke();
            
            // Piringan
            ctx.fillStyle = '#F4F1EA';
            ctx.strokeStyle = '#8C7B5D';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(0, 80, 40, 10, 0, 0, Math.PI*2);
            ctx.fill(); ctx.stroke();
            
            // --- 4. GAMBAR BEBAN (ITEM) ---
            let yStack = 80;
            const itemW = 24; const itemH = 24;

            // Gambar Balok X (Kotak Biru)
            ctx.fillStyle = '#3B82F6'; // Blue-500
            ctx.strokeStyle = '#2563EB';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for(let i=0; i<countX; i++) {
                yStack -= itemH;
                ctx.fillRect(-itemW/2, yStack - 5, itemW, itemH);
                ctx.strokeRect(-itemW/2, yStack - 5, itemW, itemH);
                
                ctx.fillStyle = 'white';
                ctx.fillText('x', 0, yStack + 7 - 5);
                ctx.fillStyle = '#3B82F6'; // Reset color
            }

            // Gambar Satuan 1 (Lingkaran Kuning)
            ctx.fillStyle = '#FACC15'; // Yellow-400
            ctx.strokeStyle = '#CA8A04';
            
            // Tumpuk lingkaran 1 di atas balok x (atau di dasar jika tidak ada x)
            // Agar rapi, lingkaran disusun piramida atau baris jika banyak
            let circleX = -15;
            let circleY = yStack - 5; // Mulai dari atas tumpukan terakhir
            
            for(let i=0; i<count1; i++) {
                if(i % 3 === 0) { // Baris baru setiap 3 item
                    circleY -= 12; 
                    circleX = -10; 
                } else {
                    circleX += 10;
                }
                ctx.beginPath();
                ctx.arc(circleX, circleY, 5, 0, Math.PI*2);
                ctx.fill(); ctx.stroke();
            }

            ctx.restore();
        };

        // Gambar Piringan Kiri dan Kanan
        drawPan(-beamLen + 10, balState.Lx, balState.L1); // Kiri
        drawPan(beamLen - 10, balState.Rx, balState.R1);  // Kanan

        ctx.restore(); // Restore Rotasi Lengan
    };
</script>
</body>
</html>

